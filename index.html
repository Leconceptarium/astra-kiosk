<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Astra – Assistant de M. Morpheus</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      height: 100vh;
      background: radial-gradient(circle at center, #0d0020, #1b003b);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    video {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 20px;
      box-shadow: 0 0 50px #aa88ff;
      transition: opacity 0.5s ease-in-out;
    }

    #bandeau {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
      font-family: 'Unica One', sans-serif;
      font-size: 2.2rem;
      padding: 12px;
      text-align: center;
      letter-spacing: 1px;
    }
  </style>
</head>
<body>
  <video id="astraVideo" src="marche.mp4" autoplay loop muted playsinline></video>
  <div id="bandeau">ASTRA VOUS ÉCOUTE...</div>

 <script>
  const video = document.getElementById("astraVideo");
  const bandeau = document.getElementById("bandeau");

  // 🎬 Durée max des animations (en secondes)
  const MAX_REACTION_DURATION = 5;
  const MAX_MARCHE_DURATION = 10;

  // --- ASSOCIATION AUDIO -> VIDÉO ---
  const reactions = {
    "salutation_bonjour.mp3": "joie.mp4",
    "mdp_confirme.mp3": "joie.mp4",
    "ca_va.mp3": "joie.mp4",
    "mdp_faux.mp3": "colere.mp4",
    "mdp_faux2.mp3": "colere.mp4",
    "mdp_faux3.mp3": "colere.mp4",
    "phrase_non_reconnue.mp3": "suspicion.mp4",
    "phrase_non_reconnue2.mp3": "suspicion.mp4",
    "phrase_non_reconnue3.mp3": "suspicion.mp4",
    "phrase_non_reconnue4.mp3": "suspicion.mp4",
    "indice_aide.mp3": "confiante.mp4",
    "c_qui_morpheus.mp3": "confiante.mp4",
    "ou_sommes_nous.mp3": "confiante.mp4",
    "tu_es_la.mp3": "confiante.mp4"
  };

  // --- GESTION DES AUDIOS + VIDÉOS ---
  function playSoundWithReaction(file) {
    const audio = new Audio(file);
    const reactionVideo = reactions[file] || "marche.mp4";

    // 🔁 Change la vidéo selon la réaction
    video.src = reactionVideo;
    video.loop = false;
    video.muted = true;
    video.currentTime = 0;
    video.play();
    bandeau.textContent = "ASTRA RÉPOND...";

    // ⏱️ Coupe la vidéo après 5s max
    const stopTimer = setTimeout(() => {
      returnToIdle();
    }, MAX_REACTION_DURATION * 1000);

    // 🔊 Joue le son
    audio.play();
    audio.onended = () => {
      clearTimeout(stopTimer);
      returnToIdle();
    };
  }

  // --- FONCTION RETOUR À LA MARCHE ---
  function returnToIdle() {
    video.src = "marche.mp4";
    video.loop = true;
    video.muted = true;
    video.currentTime = 0;
    video.play();
    bandeau.textContent = "ASTRA VOUS ÉCOUTE...";
  }

  // --- RECONNAISSANCE VOCALE ---
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.continuous = true;
  recognition.interimResults = false;
  recognition.lang = 'fr-FR';

  let mdpValid = false;

  const detectPhrase = (text) => {
    const t = text.toLowerCase();

    if (t.includes("bonjour") || t.includes("salut")) return "salutation_bonjour.mp3";
    if (t.includes("qui es-tu") || t.includes("astra")) return "c_qui_morpheus.mp3";
    if (t.includes("on est où") || t.includes("où sommes-nous")) return "ou_sommes_nous.mp3";
    if (t.includes("ça va")) return "ca_va.mp3";
    if (t.includes("tu es là")) return "tu_es_la.mp3";
    if (t.includes("indice") || t.includes("aide")) return "indice_aide.mp3";

    // --- Mot de passe ---
    if (t.includes("bonne nuit")) {
      if (!mdpValid) {
        mdpValid = true;
        document.body.style.background = "linear-gradient(135deg, #002d2d, #006c6c)";
        playSoundWithReaction("mdp_confirme.mp3");
      } else playSoundWithReaction("mdp_confirme.mp3");
      return;
    }

    if (t.includes("pétunia")) return "mdp_faux.mp3";

    // --- Réponses non reconnues ---
    const randomFaux = [
      "phrase_non_reconnue.mp3",
      "phrase_non_reconnue2.mp3",
      "phrase_non_reconnue3.mp3",
      "phrase_non_reconnue4.mp3"
    ];
    return randomFaux[Math.floor(Math.random() * randomFaux.length)];
  };

  recognition.onresult = (event) => {
    const text = event.results[event.results.length - 1][0].transcript.trim();
    console.log("🎙️ Entendu :", text);
    const audioFile = detectPhrase(text);
    if (audioFile) playSoundWithReaction(audioFile);
  };

  recognition.onerror = (event) => console.error("Erreur vocale :", event.error);
  recognition.onend = () => setTimeout(() => recognition.start(), 1000);

  window.onload = () => {
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(() => {
        console.log("✅ Micro autorisé, écoute en cours");
        recognition.start();
      })
      .catch(err => console.error("Micro refusé :", err));
  };

  // --- TEST CLAVIER ---
  window.addEventListener("keydown", (e) => {
    if (e.key === "1") playSoundWithReaction("mdp_confirme.mp3");
    if (e.key === "2") playSoundWithReaction("mdp_faux.mp3");
    if (e.key === "3") playSoundWithReaction("phrase_non_reconnue.mp3");
    if (e.key === "4") playSoundWithReaction("indice_aide.mp3");
  });
</script>
</body>
</html>
