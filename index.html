<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Astra — Assistante de M. Morpheus</title>
  <meta name="theme-color" content="#0b0a12"/>
  <style>
    :root{
      --bg:#0b0a12; --ink:#f6e9d0; --ink-dim:#d6cbb5;
      --accent:#c89b3c; --muted:#857a62;
    }
    html,body{height:100%;}
    body{
      margin:0; background:radial-gradient(1200px 700px at 20% 0%,#131022 0%,var(--bg) 55%,#06050a 100%);
      color:var(--ink); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
      user-select:none; cursor:none;
    }
    .frame{position:relative; width:min(100vw,1024px); height:min(100vh,680px);
      background:linear-gradient(180deg,#141221 0%,#0e0c19 100%);
      border:16px solid transparent; border-image:url('assets/border-baroque.png') 60 fill round;
      box-shadow:0 0 60px rgba(0,0,0,.6) inset,0 20px 80px rgba(0,0,0,.65);
    }
    .hdr{position:absolute; top:12px; left:16px; right:16px; display:flex; align-items:center;}
    .logo{font-size:clamp(16px,2.2vw,22px); letter-spacing:.08em;}
    .chip{margin-left:auto; font-size:12px; color:var(--ink-dim);}
    .stage{position:absolute; inset:64px 24px 72px 24px; display:grid; grid-template-columns:1fr 380px; gap:24px;}
    .scene{position:relative; background:radial-gradient(70% 100% at 50% 20%,#1f1a35 0%,#141221 60%,#0e0c19 100%);
      border-radius:18px; box-shadow:inset 0 0 0 1px rgba(255,255,255,.06),0 10px 30px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .noise{position:absolute; inset:0; opacity:.08; background:url('assets/noise.png'); mix-blend-mode:overlay;}
    .scroll{background:linear-gradient(180deg,#2a253f 0%,#1e1a30 100%); border-radius:16px; padding:16px;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.07);}
    .scroll h2{margin:4px 0 12px; font-size:14px; letter-spacing:.12em; color:var(--ink-dim); text-transform:uppercase;}
    .out{height:calc(100% - 48px); overflow:auto; padding-right:6px;}
    .line{display:flex; align-items:flex-start; gap:10px; margin:10px 0;}
    .bubble{max-width:85%; padding:10px 12px; border-radius:12px; box-shadow:0 2px 0 rgba(0,0,0,.25);}
    .bubble.astra{background:#1d182b; border:1px solid rgba(255,255,255,.06);}
    .bubble.user{background:#0d1b2a; border:1px solid rgba(255,255,255,.05);}
    .tag{font-size:11px; color:var(--muted);}
    .imgcard{margin-top:8px; border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,.08);}
    .imgcard img{display:block; width:100%; height:auto;}
    .ftr{position:absolute; left:24px; right:24px; bottom:20px; display:flex; align-items:center; gap:12px;}
    .led{width:10px; height:10px; border-radius:50%; background:#372e4f; box-shadow:0 0 10px #000 inset;}
    .led.on{background:#27ae60; box-shadow:0 0 10px #27ae60,0 0 30px rgba(39,174,96,.35);}
    .status{font-size:12px; color:var(--ink-dim);}
    @media(max-width:900px){.stage{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="frame" id="app">
    <div class="hdr">
      <div class="logo">ASTRA — Atelier de M. Morpheus</div>
      <div class="chip" id="chip">FR • Verrouillé</div>
    </div>
    <div class="stage">
      <div class="scene"><div class="noise"></div></div>
      <aside class="scroll">
        <h2>Fil de l'atelier</h2>
        <div id="out" class="out"></div>
      </aside>
    </div>
    <div class="ftr"><div id="led" class="led"></div><div id="status" class="status">Initialisation…</div></div>
  </div>
  <audio id="fx-chime" src="assets/chime.mp3" preload="auto"></audio>
  <audio id="bg-lullaby" src="assets/lullaby.mp3" preload="auto" loop></audio>

<script>
const out=document.getElementById('out'),statusEl=document.getElementById('status'),chip=document.getElementById('chip'),
led=document.getElementById('led'),fxChime=document.getElementById('fx-chime'),lullaby=document.getElementById('bg-lullaby');
let isLocked=true,isRunning=false,isMuted=false,wakeArmed=true,currentLangPref='auto',wakeLock=null;

const IMAGES={liberation:'assets/parchemin_liberation.jpg',sweet:'assets/parchemin_sweet_dream.jpg',
love:'assets/parchemin_reve_d_amour.jpg',jail:'assets/parchemin_philtre_enfermement.jpg'};

function now(){return new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}
function addLine(kind,html){const line=document.createElement('div');line.className='line';
const tag=`<div class="tag">${now()} · ${kind==='astra'?'Astra':'Vous'}</div>`;
const bubble=`<div class="bubble ${kind}">${html}</div>`;
line.innerHTML=(kind==='astra'?bubble+tag:tag+bubble);
out.appendChild(line);out.scrollTop=out.scrollHeight;}
function addImage(src,alt){const w=document.createElement('div');w.className='imgcard';w.innerHTML=`<img src="${src}" alt="${alt}">`;
out.appendChild(w);out.scrollTop=out.scrollHeight;}

// ---- Voix fluide ----
let __voicesCache=[];const voicesReady=new Promise(r=>{
function loadV(){const v=speechSynthesis.getVoices();if(v&&v.length){__voicesCache=v;r(v);}else setTimeout(loadV,100);}
if(speechSynthesis.onvoiceschanged!==undefined)speechSynthesis.onvoiceschanged=()=>{__voicesCache=speechSynthesis.getVoices();r(__voicesCache);};
loadV();});
function pickVoice(lang){
const pref={fr:['Amélie (Améliorée)','Thomas (Améliorée)','Amelie (Enhanced)','Thomas (Enhanced)','Siri Voice 4','Aurelie','Google français'],
en:['Samantha (Enhanced)','Samantha','Alex','Google US English'],de:['Anna (Erweitert)','Markus','Petra','Google Deutsch']};
const want=lang==='fr'?/^fr/i:lang==='de'?/^de/i:/^en/i;for(const n of(pref[lang]||[])){const v=__voicesCache.find(v=>v.name===n);if(v)return v;}
const same=__voicesCache.filter(v=>want.test(v.lang));const e=same.find(v=>/Enhanced|Neural|Premium|Siri/i.test(v.name+v.voiceURI));
return e||same[0]||__voicesCache[0]||null;}
function speak(text,lang){if(isMuted||!text)return;const code=lang==='fr'?'fr-FR':lang==='de'?'de-DE':'en-US';
const rate=lang==='fr'?0.92:(lang==='de'?0.95:0.96),pitch=0.98;const parts=(text.match(/[^.!?…]+[.!?…]?/g)||[text])
.map(s=>s.trim()).filter(Boolean);let used=false;const sChunks=v=>{if(used)return;used=true;parts.forEach(p=>{
const u=new SpeechSynthesisUtterance(p);u.lang=code;u.rate=rate;u.pitch=pitch;if(v)u.voice=v;speechSynthesis.speak(u);});};
const t=setTimeout(()=>sChunks(null),250);voicesReady.then(()=>{try{clearTimeout(t);}catch{}sChunks(pickVoice(lang)||null);});}
  // ---- Langue & messages d'accueil (FR/EN/DE) ----
function prefLang(){
  const l = (navigator.language||'fr').toLowerCase();
  if(l.startsWith('de')) return 'de';
  if(l.startsWith('en')) return 'en';
  return 'fr';
}
const GREET = {
  fr: {
    chipLocked: 'FR • Verrouillé',
    listening: 'En écoute. Dites « okay Astra ».',
    hello: 'Système Astra initialisé. Théâtre baroque prêt.'
  },
  en: {
    chipLocked: 'EN • Locked',
    listening: 'Listening. Say “okay Astra”.',
    hello: 'Astra online. Baroque theatre booted.'
  },
  de: {
    chipLocked: 'DE • Gesperrt',
    listening: 'Ich höre zu. Sage „okay Astra“.',
    hello: 'Astra betriebsbereit. Barocktheater aktiv.'
  }
};
  
// ---- Reconnaissance ----
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;let rec=null,recLang='fr-FR';
function startRec(){
if(!SR){addLine('astra','Micro non supporté.');return;}
if(rec){try{rec.stop();}catch{}}
rec=new SR();rec.continuous=true;rec.interimResults=true;rec.lang=recLang;
rec.onresult=e=>{for(let i=e.resultIndex;i<e.results.length;i++){const r=e.results[i],txt=r[0].transcript.trim();
if(txt.match(/(bonne\s*nuit|good\s*night|gute\s*nacht)/i))handleText(txt);if(r.isFinal)handleText(txt);}};
rec.onstart=()=>{led.classList.add('on');};rec.onend=()=>{led.classList.remove('on');if(isRunning)setTimeout(startRec,150);};
try{rec.start();}catch{}}

// ---- IA Astra ----
function handleText(text){
const lang=currentLangPref==='auto'?guessLang(text):currentLangPref.slice(0,2);
addLine('user',text);
if(isLocked&&/(bonne\s*nuit|good\s*night|gute\s*nacht)/i.test(text)){
isLocked=false;chip.textContent='FR • Ouvert';
const t=lang==='en'?'Access granted. How polite.':lang==='de'?'Zugang gewährt. Nett geflüstert.':'Accès accordé. Quelle politesse.';
speak(t,lang);addLine('astra',t);return;}
if(isLocked){const t=lang==='en'?'Say the access phrase first.':'Prononcez la phrase d’accès d’abord.';speak(t,lang);addLine('astra',t);return;}
if(/(ok|okay|salut|hallo|bonjour)\s*astra/i.test(text)){
const t=lang==='en'?'Yes, I’m listening. Probably.':'Oui, je vous écoute. Peut-être.';
speak(t,lang);addLine('astra',t);return;}
if(/(qui\s+est\s+(monsieur\s+)?morpheus)/i.test(text)){
const t=lang==='en'?'Mister Morpheus is… complicated. Let’s say he collects dreams. Aggressively.':
'Disons que Monsieur Morpheus collectionne les rêves. De force.';
speak(t,lang);addLine('astra',t);return;}
if(/(potion|lib(é|e)rer|ouvrir\s+la\s+cage|free\s+the\s+creature)/i.test(text)){
const t=lang==='en'?'Here’s your precious liberation scroll. Try not to mess it up.':
'Voici votre précieux parchemin de libération. Essayez de ne pas tout gâcher.';
speak(t,lang);addLine('astra',t);addImage(IMAGES.liberation,'Parchemin');return;}
if(/(berceuse|lullaby)/i.test(text)){
const t=lang==='en'?'System lullaby engaged. Try not to snore too loud.':
'Berceuse système enclenchée. Évitez de ronfler.';
lullaby.play().catch(()=>{});speak(t,lang);addLine('astra',t);return;}
if(/(blague|joke)/i.test(text)){
const t=lang==='en'?'Why did the dream cross the road? To escape Morpheus.':
'Pourquoi le rêve a traversé la route ? Pour fuir Morpheus.';
speak(t,lang);addLine('astra',t);return;}
const def=lang==='en'?'Processing... your human curiosity is adorable.':
'Traitement en cours... votre curiosité humaine est presque touchante.';
speak(def,lang);addLine('astra',def);}
function guessLang(t){t=(t||'').toLowerCase();if(/[àâçéèêëîïôûùœ]/.test(t)||/bonjour|potion|libération/.test(t))return'fr';
if(/\b(the|how|open|monster|good\s*night|okay)\b/.test(t))return'en';
if(/\b(und|wie|öffnen|gute\s*nacht|käfig|hallo)\b|[äöüß]/.test(t))return'de';return'fr';}

// ---- Boot ----
async function boot(){if(isRunning)return;isRunning=true;
try{wakeLock=await navigator.wakeLock.request('screen');}catch{}
startRec();
const L = prefLang();
chip.textContent = GREET[L].chipLocked;
statusEl.textContent = GREET[L].listening;
setTimeout(()=>{
  speak(GREET[L].hello, L);
  addLine('astra', GREET[L].hello);
}, 600);
}
window.addEventListener('load',boot);
</script>
</body>
</html>
