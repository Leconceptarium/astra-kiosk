<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Astra ‚Äì Assistant de M. Morpheus</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #000;
      font-family: 'Unica One', serif;
    }

    video {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 95%;
      height: auto;
      transform: translate(-50%, -50%);
      object-fit: contain;
      background: #000;
      opacity: 0;
      transition: opacity 0.6s ease;
      display: none;
    }

    #astraIdle.active, #astraIdle2.active {
      display: block;
      opacity: 1;
      z-index: 1;
    }

    #astraReaction {
      z-index: 2;
      display: none;
    }

    #bandeau {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      font-size: clamp(1.5rem, 4vw, 3rem);
      text-align: center;
      padding: 20px;
      white-space: nowrap;
      overflow: hidden;
      z-index: 3;
    }

    #bandeau span {
      display: inline-block;
      animation: defilement 12s linear infinite;
    }

    @keyframes defilement {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

    #parcheminImage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 80%;
      max-height: 80%;
      z-index: 4;
      display: none;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    #parcheminImage.visible {
      opacity: 1;
    }

    .magic {
      position: absolute;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: radial-gradient(
        circle,
        rgba(0, 255, 255, 0.8) 0%,
        rgba(0, 255, 150, 0.25) 40%,
        rgba(0, 100, 100, 0.1) 65%,
        transparent 85%
      );
      filter: blur(3px) brightness(2.2);
      mix-blend-mode: screen;
      animation: fallMagic 6s ease-in-out forwards;
      pointer-events: none;
      z-index: 5;
    }

    @keyframes fallMagic {
      0% {
        transform: translateY(-600px) scale(1.3) rotate(0deg);
        opacity: 0;
      }
      20% {
        opacity: 1;
      }
      60% {
        transform: translateY(0px) scale(0.8) rotate(180deg);
        opacity: 0.9;
      }
      100% {
        transform: translateY(400px) scale(0.6) rotate(360deg);
        opacity: 0;
      }
    }

    #transitionFade {
      position: fixed;
      inset: 0;
      background: radial-gradient(
        circle at center,
        rgba(0, 255, 255, 0.9) 0%,
        rgba(0, 255, 150, 0.4) 30%,
        rgba(0, 100, 100, 0.2) 55%,
        transparent 75%
      );
      opacity: 0;
      pointer-events: none;
      transition: opacity 1.2s ease;
      z-index: 9;
    }

    #fullscreenBtn {
      position: fixed;
      bottom: 20px;
      right: 25px;
      z-index: 10;
      width: 50px;
      height: 50px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      color: #fff;
      font-size: 22px;
      text-align: center;
      line-height: 46px;
      cursor: pointer;
      background: rgba(255,255,255,0.08);
      transition: all .3s ease;
      user-select: none;
    }

    #fullscreenBtn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.6);
      transform: scale(1.1);
    }

    #statusIndicator {
      position: fixed;
      top: 20px;
      right: 25px;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      background: rgba(0,0,0,0.5);
      border-radius: 20px;
      color: #fff;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #statusIndicator.visible {
      opacity: 1;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ff4444;
      animation: pulse 2s infinite;
    }

    .status-dot.listening {
      background: #44ff44;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    #errorMessage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 50, 50, 0.9);
      color: white;
      padding: 20px 40px;
      border-radius: 10px;
      z-index: 11;
      display: none;
      text-align: center;
      max-width: 80%;
    }

    #debugPanel {
      position: fixed;
      bottom: 80px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: #0f0;
      padding: 15px;
      border-radius: 10px;
      font-family: monospace;
      font-size: 12px;
      max-width: 400px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 12;
      display: none;
    }

    #debugPanel.visible {
      display: block;
    }

    #debugToggle {
      position: fixed;
      bottom: 80px;
      left: 20px;
      z-index: 13;
      padding: 8px 16px;
      background: rgba(0, 255, 0, 0.2);
      border: 2px solid rgba(0, 255, 0, 0.5);
      border-radius: 20px;
      color: #0f0;
      cursor: pointer;
      font-size: 12px;
    }

    #languageSelector {
      position: fixed;
      top: 20px;
      left: 25px;
      z-index: 10;
      display: flex;
      gap: 10px;
    }

    .lang-btn {
      padding: 8px 16px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 20px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .lang-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.5);
    }

    .lang-btn.active {
      background: rgba(0, 255, 255, 0.3);
      border-color: rgba(0, 255, 255, 0.7);
    }
  </style>
</head>
<body>
  <!-- Vid√©os -->
  <video id="astraIdle" src="astra_idle.mp4" autoplay muted loop playsinline preload="auto"></video>
  <video id="astraIdle2" src="astra_idle2.mp4" muted loop playsinline preload="auto"></video>
  <video id="astraReaction" muted playsinline preload="auto"></video>

  <!-- Transition magique -->
  <div id="transitionFade"></div>

  <!-- S√©lecteur de langue -->
  <div id="languageSelector">
    <button class="lang-btn active" data-lang="fr">üá´üá∑ FR</button>
    <button class="lang-btn" data-lang="en">üá¨üáß EN</button>
    <button class="lang-btn" data-lang="de">üá©üá™ DE</button>
  </div>

  <!-- Indicateur de statut -->
  <div id="statusIndicator">
    <div class="status-dot"></div>
    <span id="statusText">Initialisation...</span>
  </div>

  <!-- Bouton plein √©cran -->
  <div id="fullscreenBtn" title="Plein √©cran">‚õ∂</div>

  <!-- Message d'erreur -->
  <div id="errorMessage"></div>

  <!-- Debug Panel -->
  <button id="debugToggle">üêõ DEBUG</button>
  <div id="debugPanel"></div>

  <div id="bandeau"><span>ASTRA VOUS √âCOUTE‚Ä¶ MAIS ELLE ATTEND VOTRE MOT DE PASSE</span></div>
  <img id="parcheminImage" src="parchemin.png" alt="Parchemin de lib√©ration" />

  <script>
    // ===== √âL√âMENTS DOM =====
    const elements = {
      bandeau: document.getElementById("bandeau"),
      parcheminImage: document.getElementById("parcheminImage"),
      astraIdle: document.getElementById("astraIdle"),
      astraIdle2: document.getElementById("astraIdle2"),
      astraReaction: document.getElementById("astraReaction"),
      fullscreenBtn: document.getElementById("fullscreenBtn"),
      fade: document.getElementById("transitionFade"),
      statusIndicator: document.getElementById("statusIndicator"),
      statusText: document.getElementById("statusText"),
      statusDot: document.querySelector(".status-dot"),
      errorMessage: document.getElementById("errorMessage"),
      languageSelector: document.getElementById("languageSelector"),
      debugPanel: document.getElementById("debugPanel"),
      debugToggle: document.getElementById("debugToggle")
    };

    // ===== SYST√àME DE DEBUG =====
    const debugLogger = {
      logs: [],
      
      log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
        this.logs.push(logEntry);
        
        if (this.logs.length > 50) {
          this.logs.shift();
        }
        
        this.update();
      },
      
      update() {
        if (elements.debugPanel) {
          elements.debugPanel.innerHTML = this.logs.map(log => 
            `<div>${log}</div>`
          ).join('');
          elements.debugPanel.scrollTop = elements.debugPanel.scrollHeight;
        }
      },
      
      clear() {
        this.logs = [];
        this.update();
      }
    };

    // Toggle debug panel
    elements.debugToggle.addEventListener('click', () => {
      elements.debugPanel.classList.toggle('visible');
    });

    // ===== √âTAT DE L'APPLICATION =====
    const state = {
      mdpValid: false,
      isPlaying: false,
      recognition: null,
      currentLang: 'fr'
    };

    // ===== TRADUCTIONS =====
    const translations = {
      fr: {
        bandeau: "ASTRA VOUS √âCOUTE‚Ä¶ MAIS ELLE ATTEND VOTRE MOT DE PASSE",
        initializing: "Initialisation...",
        micRequest: "Demande d'acc√®s au micro...",
        ready: "Pr√™t - Parlez √† Astra",
        listening: "√âcoute active",
        micDisabled: "Micro d√©sactiv√©",
        micError: "Erreur micro",
        errorInit: "Erreur d'initialisation",
        errorFullscreen: "Impossible de passer en plein √©cran",
        errorSpeechNotSupported: "Reconnaissance vocale non support√©e",
        errorMicDenied: "Micro refus√© ou non disponible",
        errorMicNotAllowed: "Micro non autoris√©",
        errorSpeechNotAvailable: "Reconnaissance vocale non disponible"
      },
      en: {
        bandeau: "ASTRA IS LISTENING‚Ä¶ BUT SHE'S WAITING FOR YOUR PASSWORD",
        initializing: "Initializing...",
        micRequest: "Requesting microphone access...",
        ready: "Ready - Speak to Astra",
        listening: "Listening",
        micDisabled: "Microphone disabled",
        micError: "Microphone error",
        errorInit: "Initialization error",
        errorFullscreen: "Unable to enter fullscreen",
        errorSpeechNotSupported: "Speech recognition not supported",
        errorMicDenied: "Microphone denied or unavailable",
        errorMicNotAllowed: "Microphone not allowed",
        errorSpeechNotAvailable: "Speech recognition unavailable"
      },
      de: {
        bandeau: "ASTRA H√ñRT ZU‚Ä¶ ABER SIE WARTET AUF IHR PASSWORT",
        initializing: "Initialisierung...",
        micRequest: "Mikrofonzugriff anfordern...",
        ready: "Bereit - Sprechen Sie mit Astra",
        listening: "H√∂rt zu",
        micDisabled: "Mikrofon deaktiviert",
        micError: "Mikrofonfehler",
        errorInit: "Initialisierungsfehler",
        errorFullscreen: "Vollbildmodus nicht m√∂glich",
        errorSpeechNotSupported: "Spracherkennung nicht unterst√ºtzt",
        errorMicDenied: "Mikrofon verweigert oder nicht verf√ºgbar",
        errorMicNotAllowed: "Mikrofon nicht erlaubt",
        errorSpeechNotAvailable: "Spracherkennung nicht verf√ºgbar"
      }
    };

    // ===== CONFIGURATION VID√âOS =====
    const VIDEO = {
      idle1: "astra_idle.mp4",
      idle2: "astra_idle2.mp4",
      talk: "astra_parle.mp4",
      suspicious: "astra_suspecte.mp4",
      angry: "astra_colere.mp4",
      happy: "astra_heureuse.mp4",
      walkTalk: "marche2.mp4",
      anxious: "inquiete.mp4",
      read: "lecture.mp4",
      joy: "joie.mp4",
      suspicionAlt: "suspicion.mp4",
      confident: "confiant.mp4"
    };

    // ===== CONFIGURATION AUDIO MULTILINGUE =====
    const audioFiles = {
      fr: {
        bonjour: "salutation_bonjour.mp3",
        qui: "qui_es_tu.mp3",
        ou: "ou_sommes_nous.mp3",
        mdp: "mdp_confirme.mp3",
        mdp_faux: ["mdp_faux.mp3", "mdp_faux_petunia.mp3"],
        petunia: "mdp_faux_petunia.mp3",
        invite_mdp: "invite_mdp.mp3",
        pas_compris: [
          "phrase_non_reconnue.mp3",
          "phrase_non_reconnue2.mp3",
          "phrase_non_reconnue3.mp3",
          "phrase_non_reconnue4.mp3"
        ],
        ca_va: "ca_va.mp3",
        tu_es_la: "tu_es_la.mp3",
        berceuse: "berceuse.mp3",
        notif: "notification_mdp_valide.mp3",
        reve_croire: "reve_croire.mp3",
        pq_reve_plus: "pq_les_humains_reve_plus.mp3",
        qui_morpheus: "c_qui_morpheus.mp3",
        parchemin: "parchemin_liberation.mp3",
        faire_quoi_mtn: "faire_quoi_mtn.mp3",
        rire: "rire.mp3",
        c_toi_qui_controles: "c_toi_qui_controles.mp3",
        blague: "blague.mp3",
        tu_aime_morpheus: "tu_aime_morpheus.mp3",
        la_solution: "la_solution.mp3",
        voix_preenregistree: "voix_preenregistree.mp3",
        mdp_oublie: "mdp_oublie.mp3",
        morpheus_apparence: "morpheus_apparence.mp3",
        indice_aide: "indice_aide.mp3"
      },
      en: {
        bonjour: "greeting_hello.mp3",
        qui: "who_are_you.mp3",
        ou: "en/where_are_we.mp3",
        mdp: "en/password_confirmed.mp3",
        mdp_faux: ["en/password_wrong.mp3", "en/password_wrong_petunia.mp3"],
        petunia: "en/password_wrong_petunia.mp3",
        invite_mdp: "en/invite_password.mp3",
        pas_compris: [
          "en/phrase_not_recognized.mp3",
          "en/phrase_not_recognized2.mp3",
          "en/phrase_not_recognized3.mp3",
          "en/phrase_not_recognized4.mp3"
        ],
        ca_va: "en/how_are_you.mp3",
        tu_es_la: "en/are_you_there.mp3",
        berceuse: "en/lullaby.mp3",
        notif: "en/notification_password_valid.mp3",
        reve_croire: "en/dream_believe.mp3",
        pq_reve_plus: "en/why_humans_dont_dream.mp3",
        qui_morpheus: "en/who_is_morpheus.mp3",
        parchemin: "en/liberation_scroll.mp3",
        faire_quoi_mtn: "en/what_to_do_now.mp3",
        rire: "en/laugh.mp3",
        c_toi_qui_controles: "en/you_control.mp3",
        blague: "en/joke.mp3",
        tu_aime_morpheus: "en/you_love_morpheus.mp3",
        la_solution: "en/the_solution.mp3",
        voix_preenregistree: "en/prerecorded_voice.mp3",
        mdp_oublie: "en/password_forgotten.mp3",
        morpheus_apparence: "en/morpheus_appearance.mp3",
        indice_aide: "en/hint_help.mp3"
      },
      de: {
        bonjour: "de/begruessung_hallo.mp3",
        qui: "de/wer_bist_du.mp3",
        ou: "de/wo_sind_wir.mp3",
        mdp: "de/passwort_bestaetigt.mp3",
        mdp_faux: ["de/passwort_falsch.mp3", "de/passwort_falsch_petunia.mp3"],
        petunia: "de/passwort_falsch_petunia.mp3",
        invite_mdp: "de/einladung_passwort.mp3",
        pas_compris: [
          "de/phrase_nicht_erkannt.mp3",
          "de/phrase_nicht_erkannt2.mp3",
          "de/phrase_nicht_erkannt3.mp3",
          "de/phrase_nicht_erkannt4.mp3"
        ],
        ca_va: "de/wie_gehts.mp3",
        tu_es_la: "de/bist_du_da.mp3",
        berceuse: "de/wiegenlied.mp3",
        notif: "de/benachrichtigung_passwort_gueltig.mp3",
        reve_croire: "de/traum_glauben.mp3",
        pq_reve_plus: "de/warum_menschen_nicht_traeumen.mp3",
        qui_morpheus: "de/wer_ist_morpheus.mp3",
        parchemin: "de/befreiungsrolle.mp3",
        faire_quoi_mtn: "de/was_jetzt_tun.mp3",
        rire: "de/lachen.mp3",
        c_toi_qui_controles: "de/du_kontrollierst.mp3",
        blague: "de/witz.mp3",
        tu_aime_morpheus: "de/du_liebst_morpheus.mp3",
        la_solution: "de/die_loesung.mp3",
        voix_preenregistree: "de/voraufgezeichnete_stimme.mp3",
        mdp_oublie: "de/passwort_vergessen.mp3",
        morpheus_apparence: "de/morpheus_aussehen.mp3",
        indice_aide: "de/hinweis_hilfe.mp3"
      }
    };

    // ===== UTILITAIRES =====
    const utils = {
      showError(message, duration = 3000) {
        elements.errorMessage.textContent = message;
        elements.errorMessage.style.display = 'block';
        setTimeout(() => {
          elements.errorMessage.style.display = 'none';
        }, duration);
      },

      updateStatus(textKey, isListening = false) {
        const text = translations[state.currentLang][textKey] || textKey;
        elements.statusText.textContent = text;
        if (isListening) {
          elements.statusDot.classList.add('listening');
        } else {
          elements.statusDot.classList.remove('listening');
        }
        elements.statusIndicator.classList.add('visible');
      },

      hideStatus(delay = 2000) {
        setTimeout(() => {
          elements.statusIndicator.classList.remove('visible');
        }, delay);
      },

      getRandomFromArray(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
      },

      updateBandeau() {
        const bandeauSpan = elements.bandeau.querySelector('span');
        bandeauSpan.textContent = translations[state.currentLang].bandeau;
      }
    };

    // ===== GESTION DES LANGUES =====
    const languageManager = {
      init() {
        const langButtons = elements.languageSelector.querySelectorAll('.lang-btn');
        langButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const lang = btn.dataset.lang;
            this.switchLanguage(lang);
          });
        });
      },

      switchLanguage(lang) {
        if (lang === state.currentLang) return;

        debugLogger.log(`Changement de langue: ${state.currentLang} ‚Üí ${lang}`, 'info');
        state.currentLang = lang;
        
        // Mise √† jour visuelle des boutons
        const langButtons = elements.languageSelector.querySelectorAll('.lang-btn');
        langButtons.forEach(btn => {
          if (btn.dataset.lang === lang) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });

        // Mise √† jour du bandeau
        utils.updateBandeau();

        // Red√©marrage de la reconnaissance vocale avec la nouvelle langue
        if (state.recognition) {
          state.recognition.stop();
          setTimeout(() => {
            speechRecognition.updateLanguage();
            speechRecognition.start();
            utils.updateStatus('ready', true);
            utils.hideStatus(3000);
            debugLogger.log(`Reconnaissance vocale red√©marr√©e en ${lang}`, 'success');
          }, 500);
        }
      }
    };

    // ===== GESTION PLEIN √âCRAN =====
    elements.fullscreenBtn.addEventListener("click", () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          utils.showError(translations[state.currentLang].errorFullscreen);
          console.error(err);
        });
      } else {
        document.exitFullscreen();
      }
    });

    // ===== GESTION VID√âOS =====
    const videoManager = {
      setupLoops() {
        [elements.astraIdle, elements.astraIdle2].forEach(v => {
          v.addEventListener('ended', () => {
            v.currentTime = 0.01;
            v.play().catch(console.error);
          });
        });
      },

      activateIdle(idleVideo) {
        elements.astraIdle.classList.remove("active");
        elements.astraIdle2.classList.remove("active");
        elements.astraIdle.style.display = "none";
        elements.astraIdle2.style.display = "none";

        idleVideo.style.display = "block";
        idleVideo.classList.add("active");
        idleVideo.play().catch(() => {
          idleVideo.muted = true;
          idleVideo.play();
        });
      },

      playReaction(videoName) {
        elements.astraReaction.src = videoName;
        elements.astraReaction.style.display = "block";
        elements.astraIdle.style.opacity = "0.3";
        elements.astraIdle2.style.opacity = "0.3";
        elements.astraReaction.style.opacity = "1";
        elements.astraReaction.currentTime = 0;
        return elements.astraReaction.play();
      },

      endReaction() {
        elements.astraReaction.style.opacity = "0";
        setTimeout(() => {
          elements.astraReaction.style.display = "none";
          const activeIdle = state.mdpValid ? elements.astraIdle2 : elements.astraIdle;
          activeIdle.style.opacity = "1";
          this.activateIdle(activeIdle);
          state.isPlaying = false;
        }, 600);
      }
    };

    // ===== EFFETS MAGIQUES =====
    const magicEffects = {
      spawn() {
        const p = document.createElement("div");
        p.className = "magic";
        p.style.left = Math.random() * 100 + "vw";
        p.style.top = "-40px";
        p.style.animationDuration = 3 + Math.random() * 5 + "s";
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 8000);
      },

      cascade(count = 40, interval = 150) {
        for (let i = 0; i < count; i++) {
          setTimeout(() => this.spawn(), i * interval);
        }
      }
    };

    // ===== GESTION AUDIO =====
    const audioManager = {
      currentAudio: null,

      play(file, videoName = VIDEO.talk) {
        debugLogger.log(`Tentative lecture: ${file}`, 'audio');
        debugLogger.log(`Vid√©o associ√©e: ${videoName}`, 'video');
        
        if (state.isPlaying) {
          debugLogger.log('Lecture d√©j√† en cours, ignor√©', 'warn');
          return;
        }
        state.isPlaying = true;

        if (this.currentAudio) {
          this.currentAudio.pause();
          this.currentAudio = null;
        }

        this.currentAudio = new Audio(file);
        
        // Test si le fichier existe
        this.currentAudio.addEventListener('loadeddata', () => {
          debugLogger.log(`‚úì Audio charg√©: ${file}`, 'success');
        });
        
        this.currentAudio.addEventListener('error', (e) => {
          debugLogger.log(`‚úó ERREUR audio: ${file} - ${e.type}`, 'error');
          utils.showError(`Fichier audio introuvable: ${file}`);
        });

        videoManager.playReaction(videoName);

        this.currentAudio.play().catch(err => {
          debugLogger.log(`Erreur play(): ${err.message}`, 'error');
          console.error("Erreur lecture audio:", err);
          videoManager.endReaction();
        });

        this.currentAudio.onended = () => {
          debugLogger.log('Audio termin√©', 'info');
          videoManager.endReaction();
          this.currentAudio = null;
        };
      }
    };

    // ===== GESTION PARCHEMIN =====
    const parcheminManager = {
      show(duration = 15000) {
        elements.parcheminImage.style.display = "block";
        setTimeout(() => {
          elements.parcheminImage.classList.add('visible');
        }, 10);
        
        setTimeout(() => {
          this.hide();
        }, duration);
      },

      hide() {
        elements.parcheminImage.classList.remove('visible');
        setTimeout(() => {
          elements.parcheminImage.style.display = "none";
        }, 500);
      }
    };

    // ===== D√âTECTION DE PHRASES MULTILINGUE =====
    const phraseDetector = {
      normalize(text) {
        return text.toLowerCase().trim();
      },

      detect(text) {
        const t = this.normalize(text);
        const lang = state.currentLang;
        const audio = audioFiles[lang];

        // FRAN√áAIS
        if (lang === 'fr') {
          if (/bonjour|salut|coucou|bonsoir|wesh|yo/i.test(t)) {
            return { file: audio.bonjour, video: VIDEO.happy };
          }
          if (/qui (tu es|es-tu)|t'es qui|c'est quoi toi|astra|c'est quoi ce truc/i.test(t)) {
            return { file: audio.qui, video: VIDEO.happy };
          }
          if (/o√π sommes|on est o√π|quel est cet endroit/i.test(t)) {
            return { file: audio.ou, video: VIDEO.anxious };
          }
          if (/bonne nuit|le mot de passe c'est bonne nuit/i.test(t)) {
            return this.handlePassword();
          }
          if (/mot de passe oubli√©|j'ai oubli√©|comment trouver/i.test(t)) {
            return { file: audio.mdp_oublie, video: VIDEO.anxious };
          }
          if (/p√©tunia/i.test(t)) {
            return { file: audio.petunia, video: VIDEO.angry };
          }
          if (/parchemin|marchemin|par chemin|potion.*lib√©ration|recette.*liberation/i.test(t)) {
            return this.handleParchemin();
          }
          if (/je connais le mot de passe|j'ai trouv√© le mot de passe/i.test(t)) {
            return { file: audio.invite_mdp, video: VIDEO.anxious };
          }
          if (/√ßa va|comment tu vas|tu vas bien/i.test(t)) {
            return { file: audio.ca_va, video: VIDEO.happy };
          }
          if (/tu es l√†|t'es l√†|h√© ho|tu m'entends/i.test(t)) {
            return { file: audio.tu_es_la, video: VIDEO.anxious };
          }
          if (/berceuse|musique pour dormir/i.test(t)) {
            return { file: audio.berceuse, video: VIDEO.talk };
          }
          if (/tu crois en nous|on va r√©ussir/i.test(t)) {
            return { file: audio.reve_croire, video: VIDEO.confident };
          }
          if (/pourquoi les humains ne r√™vent plus/i.test(t)) {
            return { file: audio.pq_reve_plus, video: VIDEO.suspicionAlt };
          }
          if (/qui est morpheus/i.test(t)) {
            return { file: audio.qui_morpheus, video: VIDEO.walkTalk };
          }
          if (/blague|raconte une blague/i.test(t)) {
            return this.handleJoke();
          }
          if (/tu aimes morpheus|tu nous aimes/i.test(t)) {
            return { file: audio.tu_aime_morpheus, video: VIDEO.happy };
          }
          if (/solution/i.test(t)) {
            return { file: audio.la_solution, video: VIDEO.walkTalk };
          }
          if (/contr√¥les/i.test(t)) {
            return { file: audio.c_toi_qui_controles, video: VIDEO.suspicious };
          }
          if (/pr√©enregistr√©e/i.test(t)) {
            return { file: audio.voix_preenregistree, video: VIDEO.suspicious };
          }
          if (/indice|aide/i.test(t)) {
            return { file: audio.indice_aide, video: VIDEO.suspicionAlt };
          }
          if (/faut faire quoi/i.test(t)) {
            return { file: audio.faire_quoi_mtn, video: VIDEO.walkTalk };
          }
        }

        // ANGLAIS
        if (lang === 'en') {
          if (/hello|hi|hey|good morning|good evening|yo/i.test(t)) {
            return { file: audio.bonjour, video: VIDEO.happy };
          }
          if (/who are you|what are you|who's astra|what is this/i.test(t)) {
            return { file: audio.qui, video: VIDEO.happy };
          }
          if (/where are we|where is this place|what is this place/i.test(t)) {
            return { file: audio.ou, video: VIDEO.anxious };
          }
          if (/good night|the password is good night/i.test(t)) {
            return this.handlePassword();
          }
          if (/forgot.*password|forgotten.*password|how to find/i.test(t)) {
            return { file: audio.mdp_oublie, video: VIDEO.anxious };
          }
          if (/petunia/i.test(t)) {
            return { file: audio.petunia, video: VIDEO.angry };
          }
          if (/scroll|parchment|potion.*liberation|recipe.*liberation/i.test(t)) {
            return this.handleParchemin();
          }
          if (/i know the password|i found the password/i.test(t)) {
            return { file: audio.invite_mdp, video: VIDEO.anxious };
          }
          if (/how are you|are you okay|you good/i.test(t)) {
            return { file: audio.ca_va, video: VIDEO.happy };
          }
          if (/are you there|you there|hey|can you hear me/i.test(t)) {
            return { file: audio.tu_es_la, video: VIDEO.anxious };
          }
          if (/lullaby|music to sleep/i.test(t)) {
            return { file: audio.berceuse, video: VIDEO.talk };
          }
          if (/do you believe in us|will we succeed/i.test(t)) {
            return { file: audio.reve_croire, video: VIDEO.confident };
          }
          if (/why don't humans dream anymore|why humans don't dream/i.test(t)) {
            return { file: audio.pq_reve_plus, video: VIDEO.suspicionAlt };
          }
          if (/who is morpheus/i.test(t)) {
            return { file: audio.qui_morpheus, video: VIDEO.walkTalk };
          }
          if (/joke|tell me a joke|tell a joke/i.test(t)) {
            return this.handleJoke();
          }
          if (/do you love morpheus|do you love us/i.test(t)) {
            return { file: audio.tu_aime_morpheus, video: VIDEO.happy };
          }
          if (/solution/i.test(t)) {
            return { file: audio.la_solution, video: VIDEO.walkTalk };
          }
          if (/control/i.test(t)) {
            return { file: audio.c_toi_qui_controles, video: VIDEO.suspicious };
          }
          if (/prerecorded/i.test(t)) {
            return { file: audio.voix_preenregistree, video: VIDEO.suspicious };
          }
          if (/hint|help|clue/i.test(t)) {
            return { file: audio.indice_aide, video: VIDEO.suspicionAlt };
          }
          if (/what should we do|what to do now/i.test(t)) {
            return { file: audio.faire_quoi_mtn, video: VIDEO.walkTalk };
          }
        }

        // ALLEMAND
        if (lang === 'de') {
          if (/hallo|guten tag|guten morgen|guten abend|hey|hi/i.test(t)) {
            return { file: audio.bonjour, video: VIDEO.happy };
          }
          if (/wer bist du|was bist du|wer ist astra|was ist das/i.test(t)) {
            return { file: audio.qui, video: VIDEO.happy };
          }
          if (/wo sind wir|wo ist dieser ort|was ist dieser ort/i.test(t)) {
            return { file: audio.ou, video: VIDEO.anxious };
          }
          if (/gute nacht|das passwort ist gute nacht/i.test(t)) {
            return this.handlePassword();
          }
          if (/passwort vergessen|ich habe vergessen|wie finde ich/i.test(t)) {
            return { file: audio.mdp_oublie, video: VIDEO.anxious };
          }
          if (/petunie/i.test(t)) {
            return { file: audio.petunia, video: VIDEO.angry };
          }
          if (/pergament|schriftrolle|trank.*befreiung|rezept.*befreiung/i.test(t)) {
            return this.handleParchemin();
          }
          if (/ich kenne das passwort|ich habe das passwort gefunden/i.test(t)) {
            return { file: audio.invite_mdp, video: VIDEO.anxious };
          }
          if (/wie geht es dir|geht es dir gut|alles gut/i.test(t)) {
            return { file: audio.ca_va, video: VIDEO.happy };
          }
          if (/bist du da|h√∂rst du mich|kannst du mich h√∂ren/i.test(t)) {
            return { file: audio.tu_es_la, video: VIDEO.anxious };
          }
          if (/wiegenlied|schlafmusik/i.test(t)) {
            return { file: audio.berceuse, video: VIDEO.talk };
          }
          if (/glaubst du an uns|werden wir es schaffen/i.test(t)) {
            return { file: audio.reve_croire, video: VIDEO.confident };
          }
          if (/warum tr√§umen menschen nicht mehr/i.test(t)) {
            return { file: audio.pq_reve_plus, video: VIDEO.suspicionAlt };
          }
          if (/wer ist morpheus/i.test(t)) {
            return { file: audio.qui_morpheus, video: VIDEO.walkTalk };
          }
          if (/witz|erz√§hl einen witz|erz√§hl mir einen witz/i.test(t)) {
            return this.handleJoke();
          }
          if (/liebst du morpheus|liebst du uns/i.test(t)) {
            return { file: audio.tu_aime_morpheus, video: VIDEO.happy };
          }
          if (/l√∂sung/i.test(t)) {
            return { file: audio.la_solution, video: VIDEO.walkTalk };
          }
          if (/kontrolle/i.test(t)) {
            return { file: audio.c_toi_qui_controles, video: VIDEO.suspicious };
          }
          if (/voraufgezeichnet/i.test(t)) {
            return { file: audio.voix_preenregistree, video: VIDEO.suspicious };
          }
          if (/hinweis|hilfe/i.test(t)) {
            return { file: audio.indice_aide, video: VIDEO.suspicionAlt };
          }
          if (/was sollen wir tun|was jetzt tun/i.test(t)) {
            return { file: audio.faire_quoi_mtn, video: VIDEO.walkTalk };
          }
        }

        // Phrase non reconnue
        return { 
          file: utils.getRandomFromArray(audio.pas_compris), 
          video: VIDEO.anxious 
        };
      },

      handlePassword() {
        const audio = audioFiles[state.currentLang];
        if (!state.mdpValid) {
          state.mdpValid = true;
          elements.bandeau.style.display = "none";
          audioManager.play(audio.mdp, VIDEO.happy);

          setTimeout(() => {
            magicEffects.cascade(40, 150);
            audioManager.play(audio.notif, VIDEO.walkTalk);

            // Transition magique
            elements.fade.style.opacity = "1";
            setTimeout(() => {
              elements.astraIdle.classList.remove("active");
              videoManager.activateIdle(elements.astraIdle2);
              elements.fade.style.opacity = "0";
            }, 1500);
          }, 3000);

          return null;
        } else {
          return { file: audio.mdp, video: VIDEO.walkTalk };
        }
      },

      handleParchemin() {
        const audio = audioFiles[state.currentLang];
        if (state.mdpValid) {
          parcheminManager.show(15000);
          return { file: audio.parchemin, video: VIDEO.read };
        } else {
          const faux = utils.getRandomFromArray(audio.mdp_faux);
          return { file: faux, video: VIDEO.angry };
        }
      },

      handleJoke() {
        const audio = audioFiles[state.currentLang];
        audioManager.play(audio.blague, VIDEO.joy);
        setTimeout(() => {
          audioManager.play(audio.rire, VIDEO.happy);
        }, 2500);
        return null;
      }
    };

    // ===== RECONNAISSANCE VOCALE =====
    const speechRecognition = {
      getLangCode() {
        const codes = {
          'fr': 'fr-FR',
          'en': 'en-US',
          'de': 'de-DE'
        };
        return codes[state.currentLang] || 'fr-FR';
      },

      init() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
          utils.showError(translations[state.currentLang].errorSpeechNotSupported, 5000);
          return false;
        }

        state.recognition = new SpeechRecognition();
        state.recognition.continuous = true;
        state.recognition.lang = this.getLangCode();
        state.recognition.interimResults = false;

        state.recognition.onstart = () => {
          utils.updateStatus('listening', true);
        };

        state.recognition.onresult = (e) => {
          const text = e.results[e.results.length - 1][0].transcript.trim();
          debugLogger.log(`üéôÔ∏è Entendu: "${text}"`, 'speech');
          debugLogger.log(`Langue active: ${state.currentLang}`, 'info');
          console.log("üéôÔ∏è Entendu :", text);
          
          const res = phraseDetector.detect(text);
          if (res && res.file) {
            debugLogger.log(`‚úì Phrase reconnue`, 'success');
            audioManager.play(res.file, res.video);
          } else {
            debugLogger.log(`Aucune r√©ponse pour cette phrase`, 'warn');
          }
        };

        state.recognition.onerror = (e) => {
          console.error("Erreur reconnaissance vocale:", e.error);
          if (e.error === 'no-speech') {
            // Pas d'erreur affich√©e pour no-speech
          } else if (e.error === 'not-allowed') {
            utils.showError(translations[state.currentLang].errorMicNotAllowed, 5000);
            utils.updateStatus('micDisabled', false);
          } else {
            utils.updateStatus('micError', false);
          }
        };

        state.recognition.onend = () => {
          setTimeout(() => {
            if (state.recognition) {
              state.recognition.start();
            }
          }, 1000);
        };

        return true;
      },

      updateLanguage() {
        if (state.recognition) {
          state.recognition.lang = this.getLangCode();
        }
      },

      start() {
        if (state.recognition) {
          state.recognition.start();
        }
      }
    };

    // ===== INITIALISATION =====
    const app = {
      async init() {
        try {
          debugLogger.log('Initialisation de l\'application', 'info');
          
          // Configuration des vid√©os
          videoManager.setupLoops();
          debugLogger.log('Vid√©os configur√©es', 'success');

          // Initialisation du s√©lecteur de langue
          languageManager.init();
          debugLogger.log(`Langue par d√©faut: ${state.currentLang}`, 'info');

          // Demande d'acc√®s au micro
          utils.updateStatus('micRequest', false);
          await navigator.mediaDevices.getUserMedia({ audio: true });
          debugLogger.log('Acc√®s micro autoris√©', 'success');

          // Initialisation de la reconnaissance vocale
          if (speechRecognition.init()) {
            videoManager.activateIdle(elements.astraIdle);
            elements.astraIdle.play().catch(() => {
              elements.astraIdle.muted = true;
              elements.astraIdle.play();
            });

            speechRecognition.start();
            utils.updateStatus('ready', true);
            utils.hideStatus(3000);
            debugLogger.log('Syst√®me pr√™t', 'success');
          } else {
            debugLogger.log('Reconnaissance vocale non disponible', 'error');
            utils.showError(translations[state.currentLang].errorSpeechNotAvailable, 5000);
          }

        } catch (err) {
          debugLogger.log(`ERREUR: ${err.message}`, 'error');
          console.error("Erreur initialisation:", err);
          utils.showError(translations[state.currentLang].errorMicDenied, 5000);
          utils.updateStatus('errorInit', false);
        }
      }
    };

    // ===== LANCEMENT =====
    window.onload = () => {
      app.init();
    };
  </script>
</body>
</html>
