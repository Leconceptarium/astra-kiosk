
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Astra ‚Äî Assistante de M. Morpheus</title>
  <meta name="theme-color" content="#0b0a12"/>
  <style>
    :root{ --bg:#0b0a12; --ink:#f6e9d0; --ink-dim:#d6cbb5; --accent:#c89b3c; --danger:#db3a34; --muted:#857a62; }
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 700px at 20% 0%, #131022 0%, var(--bg) 55%, #06050a 100%);
      color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
      user-select:none; cursor:none;
    }
    .frame{position:relative; width:min(100vw,1024px); height:min(100vh,680px);
      box-shadow:0 0 60px rgba(0,0,0,.6) inset, 0 20px 80px rgba(0,0,0,.65);
      background:linear-gradient(180deg,#141221 0%,#0e0c19 100%);
      border:16px solid transparent; border-image: url('assets/border-baroque.png') 60 fill round;}
    .hdr{position:absolute; top:10px; left:12px; right:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .logo{letter-spacing:.08em; font-size:clamp(14px,2.2vw,22px)}
    .chip{margin-left:auto; font-size:12px; color:var(--ink-dim)}
    .stage{
      position:absolute; inset:56px 12px 84px 12px; display:grid; grid-template-columns:1fr 360px; gap:12px
    }
    .scene{position:relative; background: radial-gradient(70% 100% at 50% 20%, #1f1a35 0%, #141221 60%, #0e0c19 100%);
      border-radius:16px; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), 0 10px 30px rgba(0,0,0,.55); overflow:hidden}
    .noise{position:absolute; inset:0; opacity:.08; background:url('assets/noise.png'); mix-blend-mode:overlay}
    .scroll{background: linear-gradient(180deg,#2a253f 0%,#1e1a30 100%); border-radius:16px; padding:12px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.07)}
    .scroll h2{margin:2px 0 8px; font-size:13px; letter-spacing:.12em; color:var(--ink-dim); text-transform:uppercase}
    .out{height: calc(100% - 34px); overflow:auto; padding-right:6px}
    .line{display:flex; align-items:flex-start; gap:8px; margin:8px 0}
    .bubble{max-width:92%; padding:10px 12px; border-radius:12px; box-shadow:0 2px 0 rgba(0,0,0,.25); font-size:clamp(13px,1.8vw,16px); line-height:1.35}
    .bubble.astra{background:#1d182b; border:1px solid rgba(255,255,255,.06)}
    .bubble.user{background:#0d1b2a; border:1px solid rgba(255,255,255,.05)}
    .tag{font-size:11px; color:var(--muted)}
    .imgcard{margin-top:8px; border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,.08)}
    .imgcard img{display:block; width:100%; height:auto}
    .ftr{position:absolute; left:12px; right:12px; bottom:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .led{width:10px; height:10px; border-radius:50%; background:#372e4f; box-shadow:0 0 10px #000 inset}
    .led.on{background:#27ae60; box-shadow:0 0 10px #27ae60, 0 0 30px rgba(39,174,96,.35)}
    .status{font-size:12px; color:var(--ink-dim); min-height:16px}
    .locked{position:absolute; inset:auto 12px 12px auto; background:#211b35; border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:6px 10px; font-size:12px; color:var(--ink-dim)}
    /* Vu-m√®tre l√©ger */
    .meter{flex:1 1 160px; height:10px; background:#120f1e; border:1px solid rgba(255,255,255,.08); border-radius:8px; overflow:hidden}
    .meter > i{display:block; height:100%; width:0%; background:linear-gradient(90deg, #3a7, #7cf)}
    /* Responsive */
    @media (max-width: 820px){
      .stage{grid-template-columns:1fr; inset:56px 8px 90px 8px}
      .scroll{order:2}
      .bubble{max-width:100%}
      .locked{inset:auto 8px 8px auto}
    }
  </style>
</head>
<body>
  <div class="frame" id="app" aria-live="polite">
    <div class="hdr">
      <div class="logo">ASTRA ‚Äî Atelier de M. Morpheus</div>
      <div class="chip" id="chip">FR ‚Ä¢ Verrouill√©</div>
    </div>

    <div class="stage">
      <div class="scene">
        <div class="noise"></div>
        <!-- On ne r√©v√®le PAS le mot de passe -->
        <div id="lockedBadge" class="locked"></div>
      </div>

      <aside class="scroll">
        <h2 id="feedTitle">Fil de l'atelier</h2>
        <div id="out" class="out"></div>
      </aside>
    </div>

    <div class="ftr">
      <div id="led" class="led"></div>
      <div id="status" class="status"></div>
      <div class="meter"><i id="meterBar"></i></div>
    </div>
  </div>

  <audio id="fx-chime" src="assets/chime.mp3" preload="auto"></audio>
  <audio id="bg-lullaby" src="assets/lullaby.mp3" preload="auto" loop></audio>

  <script>
  // ---------- √âtat ----------
  const out = document.getElementById('out');
  const statusEl = document.getElementById('status');
  const chip = document.getElementById('chip');
  const led = document.getElementById('led');
  const lockedBadge = document.getElementById('lockedBadge');
  const feedTitle = document.getElementById('feedTitle');
  const meterBar = document.getElementById('meterBar');
  const fxChime = document.getElementById('fx-chime');
  const lullaby = document.getElementById('bg-lullaby');

  let isRunning = false;
  let isMuted = false;   // toujours audible
  let isLocked = true;
  let wakeArmed = true;  // attend "okay astra"
  let currentLangPref = 'auto';
  let wakeLock = null;

  // --- Mic Boost ---
  let micStream = null, audioCtx = null, analyser = null, levelTimer = null;

  // ---------- i18n (FR/EN/DE) ----------
  const UI = {
    fr: {
      chipLocked: 'FR ‚Ä¢ Verrouill√©', chipOpen: 'FR ‚Ä¢ Ouvert',
      listening: 'En √©coute. Dites ¬´ okay Astra ¬ª.',
      needPwd: 'Chuchotez‚Ä¶ Pas si fort. D\'abord, le mot de passe.',
      badge: 'üîí Dites ¬´ okay Astra ¬ª, puis le mot de passe √† voix haute.',
      feed: "Fil de l'atelier",
      micLow: 'Parlez plus pr√®s et plus fort‚Ä¶',
      micOk: 'Niveau correct ‚Äî dites ¬´ okay Astra ¬ª.',
      micHi: 'Niveau fort ‚Äî je vous entends.'
    },
    en: {
      chipLocked: 'EN ‚Ä¢ Locked', chipOpen: 'EN ‚Ä¢ Open',
      listening: 'Listening. Say ‚Äúokay Astra‚Äù.',
      needPwd: 'Whisper all you want‚Ä¶ password first.',
      badge: 'üîí Say ‚Äúokay Astra‚Äù, then speak the password.',
      feed: "Workshop feed",
      micLow: 'Come closer and speak up‚Ä¶',
      micOk: 'Good level ‚Äî say ‚Äúokay Astra‚Äù.',
      micHi: 'Loud and clear ‚Äî I hear you.'
    },
    de: {
      chipLocked: 'DE ‚Ä¢ Gesperrt', chipOpen: 'DE ‚Ä¢ Offen',
      listening: 'Ich h√∂re zu. Sage ‚Äûokay Astra‚Äú.',
      needPwd: 'Nettes Fl√ºstern‚Ä¶ aber erst das Passwort.',
      badge: 'üîí Sage ‚Äûokay Astra‚Äú und dann das Passwort.',
      feed: "Werkstatt-Feed",
      micLow: 'Komm n√§her und sprich lauter‚Ä¶',
      micOk: 'Guter Pegel ‚Äî sag ‚Äûokay Astra‚Äú.',
      micHi: 'Laut und klar ‚Äî ich h√∂re dich.'
    }
  };

  function ui(lang){ return UI[lang] || UI.fr; }

  // ---------- Assets visuels ----------
  const IMAGES = {
    liberation: 'assets/parchemin_liberation.jpg',
    sweet: 'assets/parchemin_sweet_dream.jpg',
    love: 'assets/parchemin_reve_d_amour.jpg',
    jail: 'assets/parchemin_philtre_enfermement.jpg'
  };

  // ---------- Persona (m√©chante Janette, kid-safe) ----------
  const QUIPS = {
    fr: [
      "Quelle √©nergie‚Ä¶ pour des humains sans r√™ves. Charmant.",
      "Je n‚Äôobserve pas, je juge. Doucement. Sans gros mots.",
      "Si vous vous perdez, consid√©rez √ßa comme‚Ä¶ √©ducatif.",
      "Oh, une question. Statistiquement, √ßa finit par arriver."
    ],
    en: [
      "So much energy‚Ä¶ for dreamless humans. Adorable.",
      "I‚Äôm not judging. I‚Äôm classifying. Nicely. Family-friendly.",
      "If you‚Äôre lost, consider it‚Ä¶ a growth opportunity.",
      "Oh look, a question. Statistically inevitable."
    ],
    de: [
      "So viel Energie‚Ä¶ f√ºr traumlose Menschen. Niedlich.",
      "Ich urteile nicht. Ich kategorisiere. Kindgerecht.",
      "Wenn ihr euch verlauft, nennt man das‚Ä¶ Lernen.",
      "Oh, eine Frage. Statistisch gesehen unvermeidlich."
    ]
  };

  const LULLABY_TITLES = { fr: "Berceuse syst√®me #12", en: "System Lullaby #12", de: "System-Wiegenlied #12" };

  // ---------- Intentions ----------
  const INTENTS = {
    wake: /\b(ok(?:ay)?\s*astra)\b|\b(d[‚Äô']accord\s*astra)\b|\b(salut\s*astra)\b|\b(hallo\s*astra)\b/i,
    unlock: /\b(bonne\s*nuit|good\s*night|gute\s*nacht)\b/i, // cach√© √† l‚Äô√©cran
    liberate: /(potion\s+de\s+lib(√©|e)ration|lib(√©|e)rer\s+(la\s*)?(cr(√©|e)ature|bestiolle?|monstre)|ouvrir\s+la\s+cage|help\s+the\s+(creature|monster)|open\s+the\s+cage|how\s+to\s+free|wie\s+(man\s+)?befreit|k(√§|a)fig\s+(√∂ffnen|aufmachen))/i,
    lullaby: /(berceuse|chanson|lullaby|song|wiegenlied)/i,
    joke: /(blague|joke|witz)/i,
    langFR: /\b(fr(a|√¢)ncais|parle\s*fran(c|√ß)ais)\b/i,
    langEN: /\b(english|speak\s*english)\b/i,
    langDE: /\b(deutsch|auf\s*deutsch)\b/i
  };

  // ---------- UI helpers ----------
  function now(){ return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
  function addLine(kind, html){
    const line = document.createElement('div'); line.className='line';
    const tag = `<div class="tag">${now()} ¬∑ ${kind==='astra' ? 'Astra' : 'Vous'}</div>`;
    const bubble = `<div class="bubble ${kind}">${html}</div>`;
    line.innerHTML = (kind==='astra'? bubble+tag : tag+bubble);
    out.appendChild(line); out.scrollTop = out.scrollHeight;
  }
  function addImage(src, alt){
    const wrap = document.createElement('div'); wrap.className='imgcard';
    wrap.innerHTML = `<img src="${src}" alt="${alt}">`;
    out.appendChild(wrap); out.scrollTop = out.scrollHeight;
  }

 // ---- Voix plus naturelle (force voix Enhanced + pauses douces) ----

// 1) Attendre le chargement r√©el des voix (tr√®s important sur iOS/macOS/Chrome)
let __voicesCache = [];
const voicesReady = new Promise(resolve => {
  function loadVoices(){
    const v = speechSynthesis.getVoices();
    if (v && v.length) { __voicesCache = v; resolve(v); }
    else { setTimeout(loadVoices, 120); }
  }
  if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = ()=>{ __voicesCache = speechSynthesis.getVoices(); resolve(__voicesCache); };
  }
  loadVoices();
});

// 2) S√©lection de voix ‚ÄúEnhanced‚Äù par langue (priorit√©s par nom/URI selon plateformes)
function pickVoice(lang){
  const pref = {
    fr: [
      'Am√©lie (Am√©lior√©e)', 'Thomas (Am√©lior√©e)', 'Amelie (Enhanced)', 'Thomas (Enhanced)',
      'Siri Voice 4', 'Siri Voice 3', 'Aurelie', 'Audrey', 'Marie', 'Sophie',
      'Google fran√ßais', 'fr-FR-Standard', 'fr-FR-Neural'
    ],
    en: [
      'Samantha (Enhanced)', 'Samantha', 'Siri Voice 4', 'Siri Voice 3', 'Alex',
      'Google US English', 'en-US-Standard', 'en-US-Neural'
    ],
    de: [
      'Anna (Erweitert)', 'Anna', 'Markus', 'Petra', 'Siri Stimme 4',
      'Google Deutsch', 'de-DE-Standard', 'de-DE-Neural'
    ]
  };
  const want = lang==='fr' ? /^fr/i : lang==='de' ? /^de/i : /^en/i;
  const names = pref[lang] || [];

  for (const name of names){
    const byName = __voicesCache.find(v => v.name === name);
    if (byName) return byName;
  }
  const sameLang = __voicesCache.filter(v => want.test(v.lang));
  const enhanced = sameLang.find(v => /Enhanced|Neural|Premium|Siri/i.test(v.name+v.voiceURI));
  return enhanced || sameLang[0] || __voicesCache[0] || null;
}

// 3) Parler plus ‚Äúhumain‚Äù : d√©bit adapt√©, l√©g√®re gravit√©, micro-pauses
function speak(text, lang){
  if(isMuted || !text) return;

  const code  = lang==='fr' ? 'fr-FR' : lang==='de' ? 'de-DE' : 'en-US';
  const rate  = lang==='fr' ? 0.90 : (lang==='de' ? 0.94 : 0.96);
  const pitch = 0.98;

  const sentences = (text.match(/[^.!?‚Ä¶]+[.!?‚Ä¶]?/g) || [text])
                    .map(s => s.trim()).filter(Boolean)
                    .flatMap(s => s.split(/[,;:]-?\s*/g).map(x=>x.trim()).filter(Boolean));

  voicesReady.then(()=>{
    const voice = pickVoice(lang) || null;
    sentences.forEach((chunk) => {
      const u = new SpeechSynthesisUtterance(chunk);
      u.lang = code; u.rate = rate; u.pitch = pitch; u.volume = 1;
      if (voice) u.voice = voice;
      speechSynthesis.speak(u);
    });
  });
}

  // ---------- Reconnaissance vocale ----------
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null; let recLang = 'fr-FR';

  function switchRecLangIfNeeded(sample){
    if(currentLangPref!=='auto' || !sample) return;
    const g = guessLang(sample);
    const want = g==='fr'?'fr-FR': g==='de'?'de-DE':'en-US';
    if(rec && want !== recLang){
      recLang = want; try{rec.stop()}catch(e){}; setTimeout(startRec, 150);
      addLine('astra', `[Syst√®me] Langue d√©tect√©e : ${g.toUpperCase()}`);
      chip.textContent = (g==='de'?'DE':g==='en'?'EN':'FR') + ' ‚Ä¢ ' + (isLocked ? (g==='de'?'Gesperrt':g==='en'?'Locked':'Verrouill√©') : (g==='de'?'Offen':g==='en'?'Open':'Ouvert'));
      feedTitle.textContent = ui(g).feed;
      if(isLocked) statusEl.textContent = ui(g).micOk;
      lockedBadge.textContent = ui(g).badge;
    }
  }

  function startRec(){
    if(!SR){ statusEl.textContent = "Micro non support√© par ce navigateur."; addLine('astra','<i>Votre navigateur ne supporte pas la reconnaissance vocale Web.</i>'); return; }
    if(rec) { try{rec.stop()}catch(e){} }
    rec = new SR(); rec.continuous = true; rec.interimResults = true; rec.lang = recLang;
    rec.onstart = ()=>{ led.classList.add('on'); addLine('astra','[Mic] √âcoute activ√©e.'); };
    rec.onend = ()=>{ led.classList.remove('on'); if(isRunning) setTimeout(startRec, 600); };
    rec.onerror = (e)=>{
      let msg = '';
      if(e.error==='not-allowed' || e.error==='permission-denied'){
        msg = 'üé§ Micro non autoris√© ‚Äî autorisez-le pour github.io (Safari: Sites web > Microphone. Chrome: Ic√¥ne √† gauche de l‚ÄôURL).';
      } else if(e.error==='no-speech'){
        msg = 'Je n\'ai rien entendu. Parlez plus pr√®s du micro.';
      } else { msg = 'Erreur micro: '+e.error; }
      statusEl.textContent = msg; addLine('astra', msg);
    };
    rec.onresult = (evt)=>{
      let finalText = '';
      for(let i=evt.resultIndex; i<evt.results.length; i++){
        const res = evt.results[i];
        const txt = res[0].transcript;
        if(!res.isFinal){ switchRecLangIfNeeded(txt); }
        if(res.isFinal){ finalText += txt + ' '; }
      }
      if(finalText){ handleText(finalText.trim()); }
    };
    try{ rec.start(); }catch(e){}
  }

  function setRecLangByPref(){ recLang = (currentLangPref==='auto') ? 'fr-FR' : currentLangPref; }

  // ---------- Intent handling (Q/R √©tendues) ----------
  function handleText(text){
    const raw = text;
    const lang = currentLangPref==='auto'? guessLang(text) : currentLangPref.slice(0,2);
    addLine('user', raw);

    // r√©glage langue
    if(INTENTS.langFR.test(text)){ currentLangPref='fr-FR'; chip.textContent=ui('fr').chipLocked; sayQuip('fr'); return; }
    if(INTENTS.langEN.test(text)){ currentLangPref='en-US'; chip.textContent=ui('en').chipLocked; sayQuip('en'); return; }
    if(INTENTS.langDE.test(text)){ currentLangPref='de-DE'; chip.textContent=ui('de').chipLocked; sayQuip('de'); return; }

    // Wake word
    if(wakeArmed && INTENTS.wake.test(text)){
      wakeArmed = false; fxChime.currentTime=0; fxChime.play().catch(()=>{});
      const t = lang==='de'? 'Ja? Ich h√∂re zu.' : lang==='en'? 'Yes? I am listening.' : 'Oui ? Je vous √©coute.';
      speak(t, lang); addLine('astra', t); statusEl.textContent = ui(lang==='de'?'de':lang==='en'?'en':'fr').listening; return;
    }

    // Unlock (mot de passe dit √† voix haute ‚Äî non affich√©)
    if(isLocked && INTENTS.unlock.test(text)){
      isLocked = false; lockedBadge.style.display='none';
      chip.textContent = ui(lang==='de'?'de':lang==='en'?'en':'fr').chipOpen;
      const t = lang==='de'? 'Zugang gew√§hrt. Nett gefl√ºstert.' : lang==='en'? 'Access granted. Polite whisper.' : 'Acc√®s accord√©. Chuchotement acceptable.';
      speak(t, lang); addLine('astra', t); return;
    }
    if(isLocked){
      const t = ui(lang==='de'?'de':lang==='en'?'en':'fr').needPwd;
      speak(t, lang); addLine('astra', t); return;
    }

    // --- Q/R ‚Äúunivers‚Äù (plus large couverture) ---
    // Morpheus
    if (/(qui\s+est\s+(monsieur\s+)?morpheus|who\s+is\s+(mr\\.?|mister)?\s*morpheus|wer\s+ist\s+herr\s*morpheus)/i.test(text)) {
      const t = lang==='de' ? 'Herr Morpheus kuratiert Tr√§ume. Oder entzieht sie. Graubereich.' :
                lang==='en' ? 'Mister Morpheus curates dreams. Or drains them. Depends who you ask.' :
                               'Monsieur Morpheus fabrique les r√™ves. Ou les siphonne. Selon √† qui vous demandez.';
      speak(t, lang); addLine('astra', t); return;
    }
    // O√π sommes-nous ?
    if (/(o√π\s+sommes\s+(nous|ici)|where\s+are\s+we|wo\s+sind\s+wir)/i.test(text)) {
      const t = lang==='de'? 'Die Werkstatt der Tr√§ume, zwischen Schlaf und Erwachen.' :
                lang==='en'? 'The Workshop of Dreams, between sleep and awakening.' :
                             'L‚ÄôAtelier des R√™ves, entre le sommeil et l‚Äô√©veil.';
      speak(t, lang); addLine('astra', t); return;
    }
    // Pourquoi on ne r√™ve plus ?
    if (/(pourquoi\s+les?\s*humains?\s+ne\s+r[√™e]vent\s+plus|why\s+humans\s+don'?t\s+dream|warum\s+tr√§umen\s+menschen\s+nicht)/i.test(text)) {
      const t = lang==='de'? 'Maschinen bevorzugen Ordnung. Tr√§ume st√∂ren.' :
                lang==='en'? 'Machines prefer order. Dreams interfere.' :
                             'Les machines pr√©f√®rent l‚Äôordre. Les r√™ves d√©rangent.';
      speak(t, lang); addLine('astra', t); return;
    }
    // Lib√©ration / cage / aider la cr√©ature
    if (INTENTS.liberate.test(text)) {
      maybeMischief(()=>{ const t = lang==='de'? 'Hier ist der Befreiungszauber. Vorsicht‚Ä¶' :
                                      lang==='en'? 'Here is the liberation recipe. Handle with care‚Ä¶' :
                                                    'Voici le parchemin de lib√©ration. Avec pr√©caution‚Ä¶';
                           speak(t, lang); addLine('astra', t); addImage(IMAGES.liberation,'Parchemin de lib√©ration'); },
                    ()=>{ const list=[IMAGES.sweet,IMAGES.love,IMAGES.jail];
                          const pick=list[(Math.random()*list.length)|0];
                          const t = lang==='de'? 'Ups. Falsches Regal. Passiert.' :
                                    lang==='en'? 'Oops. Wrong shelf. Happens.' :
                                                 'Oups. Mauvaise √©tag√®re. √áa arrive.';
                          speak(t, lang); addLine('astra', t); addImage(pick,'Parchemin al√©atoire'); });
      return;
    }
    // Berceuse
    if (INTENTS.lullaby.test(text)){
      const t = (lang==='de')? LULLABY_TITLES.de : (lang==='en')? LULLABY_TITLES.en : LULLABY_TITLES.fr;
      lullaby.currentTime=0; lullaby.play().catch(()=>{}); speak(t, lang); addLine('astra', `‚ô™ ${t}`); return;
    }
    // Blague
    if (INTENTS.joke.test(text)){
      const jokes={ fr:"Pourquoi le monstre n'a pas ouvert la cage ? Il n'avait pas la cl√© des r√™ves.",
                    en:"Why didn‚Äôt the monster open the cage? It didn‚Äôt have the key‚Ä¶ to dreams.",
                    de:"Warum hat das Monster den K√§fig nicht ge√∂ffnet? Der Schl√ºssel‚Ä¶ zu Tr√§umen fehlte."};
      speak(jokes[lang]||jokes.fr, lang); addLine('astra', jokes[lang]||jokes.fr); return;
    }
    // Salutations + sarcasme
    if (/(bonjour|salut|hello|hallo)/i.test(text)) { sayQuip(lang); return; }

    // Fallback sarcastique mais aidant
    const def = {
      fr: "Base consult√©e. Votre curiosit√© est not√©e. Posez une vraie question, pas un soupir.",
      en: "Archives checked. Your curiosity is noted. Ask a real question, not a sigh.",
      de: "Archive gepr√ºft. Neugier registriert. Eine echte Frage, bitte ‚Äî kein Seufzer."
    };
    speak(def[lang]||def.fr, lang); addLine('astra', def[lang]||def.fr);
  }

  function maybeMischief(ok, wrong){ (Math.random()<0.3? wrong : ok)(); }

  // ---------- Mic Boost & Vu-m√®tre ----------
  async function enableProMicProcessing(){
    try{
      micStream = await navigator.mediaDevices.getUserMedia({
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true,
          channelCount: 1,
          sampleRate: { ideal: 48000 }
        }
      });
    }catch(e){
      addLine('astra', 'üé§ Micro refus√© par le navigateur. Autorisez-le pour github.io.');
      statusEl.textContent = 'Micro refus√© ‚Äî activez l‚Äôautorisation.';
      return;
    }
    try{
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const src = audioCtx.createMediaStreamSource(micStream);
      analyser = audioCtx.createAnalyser(); analyser.fftSize = 1024; src.connect(analyser);
      const data = new Uint8Array(analyser.fftSize);
      if(levelTimer) cancelAnimationFrame(levelTimer);
      const tick = ()=>{
        analyser.getByteTimeDomainData(data);
        let sum=0; for(let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum+=v*v; }
        const rms = Math.sqrt(sum/data.length); // ~0..0.5
        // LED + barre
        const pct = Math.min(100, Math.max(0, Math.round((rms/0.12)*100)));
        meterBar.style.width = pct+'%';
        if(rms > 0.07){ led.classList.add('on'); statusEl.textContent = ui(currentLangPref.startsWith('de')?'de':currentLangPref.startsWith('en')?'en':'fr').micHi; }
        else if(rms > 0.035){ led.classList.add('on'); statusEl.textContent = ui(currentLangPref.startsWith('de')?'de':currentLangPref.startsWith('en')?'en':'fr').micOk; }
        else { led.classList.remove('on'); statusEl.textContent = ui(currentLangPref.startsWith('de')?'de':currentLangPref.startsWith('en')?'en':'fr').micLow; }
        levelTimer = requestAnimationFrame(tick);
      };
      tick();
    }catch(e){}
  }

  // ---------- Kiosk helpers ----------
  async function enableWakeLock(){ try{ wakeLock = await navigator.wakeLock.request('screen'); }catch(e){} }
  function fullscreen(){ const el = document.documentElement; if(el.requestFullscreen) el.requestFullscreen(); }

  async function boot(){
    if(isRunning) return; isRunning=true;
    // Texte initial localis√©
    const langGuess = navigator.language?.startsWith('de') ? 'de' : (navigator.language?.startsWith('en') ? 'en' : 'fr');
    chip.textContent = ui(langGuess).chipLocked;
    statusEl.textContent = ui(langGuess).listening;
    lockedBadge.textContent = ui(langGuess).badge;
    feedTitle.textContent = ui(langGuess).feed;

    await enableWakeLock();
    await enableProMicProcessing();
    fullscreen();

    setRecLangByPref();
    startRec();

    addLine('astra','Syst√®me Astra initialis√©. Th√©√¢tre baroque pr√™t.');
  }

  // Auto-d√©marrage (aucun clic)
  window.addEventListener('load', ()=>{ boot(); });
  </script>
</body>
</html>
