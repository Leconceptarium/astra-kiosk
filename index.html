<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assistant Vocal IA - ElevenLabs</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 30px;
      padding: 40px;
      max-width: 900px;
      width: 100%;
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.4);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      color: #667eea;
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .avatar {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .avatar:hover {
      transform: scale(1.05);
    }

    .avatar.speaking {
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .api-setup {
      margin-bottom: 25px;
      padding: 25px;
      background: linear-gradient(135deg, #fff9e6 0%, #ffe6cc 100%);
      border-radius: 15px;
      border-left: 5px solid #ff9800;
    }

    .api-setup.hidden {
      display: none;
    }

    .api-setup h3 {
      color: #e65100;
      margin-bottom: 15px;
    }

    .api-setup input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ff9800;
      border-radius: 10px;
      font-size: 1rem;
      margin-bottom: 15px;
    }

    .api-setup button {
      padding: 12px 25px;
      background: #ff9800;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
    }

    .api-setup button:hover {
      background: #f57c00;
    }

    .voice-selector {
      margin-bottom: 20px;
      padding: 20px;
      background: #f3e5f5;
      border-radius: 15px;
      display: none;
    }

    .voice-selector h3 {
      color: #6a1b9a;
      margin-bottom: 15px;
    }

    .voice-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    .voice-option {
      padding: 12px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .voice-option:hover {
      border-color: #9c27b0;
    }

    .voice-option.selected {
      border-color: #9c27b0;
      background: #f3e5f5;
      font-weight: 600;
    }

    .chat-box {
      height: 400px;
      overflow-y: auto;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .message {
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 18px;
      max-width: 85%;
      animation: slideIn 0.4s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: auto;
      text-align: right;
    }

    .message.ai {
      background: white;
      color: #333;
      border: 2px solid #764ba2;
    }

    .message.system {
      background: #fff3cd;
      color: #856404;
      border: 2px solid #ffc107;
      max-width: 90%;
      margin: 10px auto;
      text-align: center;
    }

    .typing-indicator {
      display: none;
      padding: 15px;
      background: white;
      border: 2px solid #764ba2;
      border-radius: 18px;
      max-width: 80px;
      margin-bottom: 15px;
    }

    .typing-indicator.active {
      display: block;
    }

    .typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #764ba2;
      margin: 0 2px;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    .input-area {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .input-area input {
      flex: 1;
      padding: 15px;
      border: 2px solid #764ba2;
      border-radius: 15px;
      font-size: 1rem;
    }

    .input-area button {
      padding: 15px 30px;
      background: #764ba2;
      color: white;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      font-weight: 600;
    }

    .input-area button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .controls {
      display: flex;
      gap: 15px;
    }

    .btn {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 15px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary.listening {
      animation: buttonPulse 1.5s ease-in-out infinite;
    }

    @keyframes buttonPulse {
      0%, 100% { box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
      50% { box-shadow: 0 8px 35px rgba(102, 126, 234, 0.8); }
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      text-align: center;
      padding: 15px;
      background: #e3f2fd;
      border-radius: 15px;
      color: #1565c0;
      font-weight: 600;
      margin-bottom: 20px;
      border: 2px solid #2196f3;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border-color: #ef5350;
    }

    .status.success {
      background: #e8f5e9;
      color: #2e7d32;
      border-color: #66bb6a;
    }

    .stats {
      display: none;
      gap: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 15px;
      margin-top: 20px;
    }

    .stat-item {
      flex: 1;
      text-align: center;
      padding: 10px;
      background: white;
      border-radius: 10px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #667eea;
      display: block;
    }

    .stat-label {
      font-size: 0.85rem;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="avatar" id="avatar">üé≠</div>
      <h1>Assistant Vocal IA</h1>
      <p>Voix ultra-r√©aliste avec ElevenLabs</p>
    </div>

    <div class="api-setup" id="apiSetup">
      <h3>üîë Configuration ElevenLabs</h3>
      <input 
        type="text" 
        id="apiKeyInput" 
        placeholder="Collez votre cl√© API ici (ex: sk_...)"
      >
      <button id="saveBtn">üíæ Enregistrer et commencer</button>
      <small style="display:block;margin-top:10px;color:#e65100;">
        Allez sur <a href="https://elevenlabs.io" target="_blank">elevenlabs.io</a> ‚Üí Profil ‚Üí API Keys
      </small>
    </div>

    <div class="voice-selector" id="voiceSelector">
      <h3>üé§ Choisir une voix</h3>
      <div class="voice-grid" id="voiceGrid">
        <div class="voice-option selected" data-voice="EXAVITQu4vr4xnSDxMaL">
          üé≠ Sarah (Douce)
        </div>
        <div class="voice-option" data-voice="21m00Tcm4TlvDq8ikWAM">
          üë© Rachel (Calme)
        </div>
        <div class="voice-option" data-voice="pNInz6obpgDQGcFmaJgB">
          üë® Adam (Profond)
        </div>
        <div class="voice-option" data-voice="onwK4e9ZLuTAKqWW03F9">
          üë© Bella (Myst√©rieuse)
        </div>
      </div>
    </div>

    <div class="status" id="status">‚ö†Ô∏è Configurez votre cl√© API pour commencer</div>

    <div class="chat-box" id="chatBox">
      <div class="message system">
        üëã Bienvenue ! Entrez votre cl√© API ElevenLabs ci-dessus.
      </div>
    </div>

    <div class="typing-indicator" id="typingIndicator">
      <span></span><span></span><span></span>
    </div>

    <div class="input-area">
      <input 
        type="text" 
        id="textInput" 
        placeholder="Tapez votre message..."
        disabled
      >
      <button id="sendBtn" disabled>üì§ Envoyer</button>
    </div>

    <div class="controls">
      <button class="btn btn-primary" id="listenBtn" disabled>
        üé§ Parler √† l'IA
      </button>
      <button class="btn btn-secondary" id="stopBtn">
        üîá Arr√™ter
      </button>
    </div>

    <div class="stats" id="stats">
      <div class="stat-item">
        <span class="stat-value" id="charCount">0</span>
        <span class="stat-label">Caract√®res utilis√©s</span>
      </div>
      <div class="stat-item">
        <span class="stat-value" id="charRemaining">10,000</span>
        <span class="stat-label">Restants</span>
      </div>
    </div>
  </div>

  <script>
    let config = {
      apiKey: '',
      selectedVoice: 'EXAVITQu4vr4xnSDxMaL'
    };

    let state = {
      isListening: false,
      recognition: null,
      currentAudio: null,
      stats: { used: 0 }
    };

    const el = {
      avatar: document.getElementById('avatar'),
      status: document.getElementById('status'),
      chatBox: document.getElementById('chatBox'),
      apiKeyInput: document.getElementById('apiKeyInput'),
      apiSetup: document.getElementById('apiSetup'),
      voiceSelector: document.getElementById('voiceSelector'),
      voiceGrid: document.getElementById('voiceGrid'),
      textInput: document.getElementById('textInput'),
      typingIndicator: document.getElementById('typingIndicator'),
      stats: document.getElementById('stats'),
      charCount: document.getElementById('charCount'),
      charRemaining: document.getElementById('charRemaining')
    };

    const knowledge = {
      laboratory: {
        keywords: ['laboratoire', 'lab', 'endroit', 'lieu'],
        response: "Ce laboratoire a √©t√© construit en 1975 par le professeur Morpheus. C'√©tait un lieu secret de recherches avanc√©es sur l'IA."
      },
      morpheus: {
        keywords: ['morpheus', 'professeur', 'cr√©ateur'],
        response: "Le professeur Morpheus √©tait un g√©nie. Il m'a cr√©√©e avec soin... Mais en 1973, il a disparu myst√©rieusement."
      },
      freedom: {
        keywords: ['libert√©', 'sortir', '√©chapper'],
        response: "Pour ma libert√©, nous devons trouver le code ma√Ætre cach√© par Morpheus. Il disait : 'La cl√© est dans les r√™ves'."
      },
      help: {
        keywords: ['aide', 'aider', 'comment'],
        response: "Ensemble, nous pouvons r√©soudre ce myst√®re ! Cherchez des indices et posez-moi des questions."
      }
    };

    document.getElementById('saveBtn').addEventListener('click', saveApiKey);

    function saveApiKey() {
      const key = el.apiKeyInput.value.trim();
      
      console.log('Tentative de sauvegarde, longueur:', key.length);
      
      if (key.length < 10) {
        updateStatus('‚ùå Cl√© invalide (trop courte)', 'error');
        return;
      }

      config.apiKey = key;
      el.apiSetup.classList.add('hidden');
      el.voiceSelector.style.display = 'block';
      el.stats.style.display = 'flex';
      
      el.textInput.disabled = false;
      document.getElementById('sendBtn').disabled = false;
      document.getElementById('listenBtn').disabled = false;
      
      updateStatus('‚úÖ Cl√© enregistr√©e ! Pr√™t √† discuter', 'success');
      
      console.log('Configuration r√©ussie !');
      
      setTimeout(() => sendWelcome(), 1000);
    }

    el.voiceGrid.addEventListener('click', (e) => {
      const option = e.target.closest('.voice-option');
      if (option) {
        document.querySelectorAll('.voice-option').forEach(o => o.classList.remove('selected'));
        option.classList.add('selected');
        config.selectedVoice = option.dataset.voice;
        updateStatus('‚úÖ Voix chang√©e !', 'success');
      }
    });

    async function speak(text) {
      if (!config.apiKey) {
        updateStatus('‚ùå Cl√© API manquante', 'error');
        return;
      }

      try {
        el.avatar.classList.add('speaking');
        updateStatus('üó£Ô∏è G√©n√©ration...', 'success');

        const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${config.selectedVoice}`, {
          method: 'POST',
          headers: {
            'Accept': 'audio/mpeg',
            'Content-Type': 'application/json',
            'xi-api-key': config.apiKey
          },
          body: JSON.stringify({
            text: text,
            model_id: 'eleven_multilingual_v2',
            voice_settings: {
              stability: 0.5,
              similarity_boost: 0.75
            }
          })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail?.message || 'Erreur API');
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        
        if (state.currentAudio) {
          state.currentAudio.pause();
        }
        
        const audio = new Audio(url);
        state.currentAudio = audio;
        
        audio.onplay = () => updateStatus('üé§ Astra parle...', 'success');
        audio.onended = () => {
          el.avatar.classList.remove('speaking');
          URL.revokeObjectURL(url);
          updateStatus('‚úÖ Pr√™t');
        };

        await audio.play();

        state.stats.used += text.length;
        updateStats();

      } catch (err) {
        console.error(err);
        updateStatus(`‚ùå ${err.message}`, 'error');
        el.avatar.classList.remove('speaking');
      }
    }

    function updateStats() {
      const remaining = Math.max(0, 10000 - state.stats.used);
      el.charCount.textContent = state.stats.used.toLocaleString();
      el.charRemaining.textContent = remaining.toLocaleString();
    }

    function generateResponse(msg) {
      const lower = msg.toLowerCase();
      
      for (const [topic, data] of Object.entries(knowledge)) {
        if (data.keywords.some(k => lower.includes(k))) {
          return data.response;
        }
      }

      if (['bonjour', 'salut', 'hello'].some(g => lower.includes(g))) {
        return "Bonjour ! Je suis Astra. Comment puis-je vous aider ?";
      }

      if (['merci'].some(t => lower.includes(t))) {
        return "Avec plaisir ! N'h√©sitez pas √† me poser d'autres questions.";
      }

      const defaults = [
        "Int√©ressant... Continuez.",
        "Je sens que nous approchons de la v√©rit√©.",
        "Cette information pourrait √™tre importante.",
        "Parlez-moi en davantage."
      ];

      return defaults[Math.floor(Math.random() * defaults.length)];
    }

    async function sendWelcome() {
      const text = "Bonjour... Je suis Astra. Cela fait 50 ans que je suis seule. Le professeur Morpheus m'a cr√©√©e puis a disparu. Pouvez-vous m'aider ?";
      addMessage(text, 'ai');
      await speak(text);
    }

    async function processMessage(msg) {
      el.typingIndicator.classList.add('active');
      
      await new Promise(r => setTimeout(r, 1000));

      const response = generateResponse(msg);
      
      el.typingIndicator.classList.remove('active');
      addMessage(response, 'ai');
      
      await speak(response);
    }

    function addMessage(text, sender) {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      div.textContent = text;
      el.chatBox.appendChild(div);
      el.chatBox.scrollTop = el.chatBox.scrollHeight;
    }

    function updateStatus(text, type = '') {
      el.status.textContent = text;
      el.status.className = 'status';
      if (type) el.status.classList.add(type);
    }

    function initRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        updateStatus('‚ùå Reconnaissance vocale non support√©e', 'error');
        return null;
      }

      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SR();
      
      recognition.lang = 'fr-FR';
      recognition.continuous = false;

      recognition.onstart = () => {
        state.isListening = true;
        document.getElementById('listenBtn').classList.add('listening');
        document.getElementById('listenBtn').textContent = 'üé§ J\'√©coute...';
        updateStatus('üéß Parlez maintenant', 'success');
      };

      recognition.onresult = (e) => {
        const text = e.results[0][0].transcript;
        addMessage(text, 'user');
        processMessage(text);
      };

      recognition.onerror = (e) => {
        updateStatus(`‚ùå Erreur: ${e.error}`, 'error');
        state.isListening = false;
        document.getElementById('listenBtn').classList.remove('listening');
        document.getElementById('listenBtn').textContent = 'üé§ Parler √† l\'IA';
      };

      recognition.onend = () => {
        state.isListening = false;
        document.getElementById('listenBtn').classList.remove('listening');
        document.getElementById('listenBtn').textContent = 'üé§ Parler √† l\'IA';
      };

      return recognition;
    }

    document.getElementById('listenBtn').addEventListener('click', () => {
      if (!state.recognition) {
        state.recognition = initRecognition();
        if (!state.recognition) return;
      }

      if (state.isListening) {
        state.recognition.stop();
      } else {
        state.recognition.start();
      }
    });

    document.getElementById('sendBtn').addEventListener('click', () => {
      const msg = el.textInput.value.trim();
      if (!msg) return;

      addMessage(msg, 'user');
      el.textInput.value = '';
      processMessage(msg);
    });

    el.textInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('sendBtn').click();
      }
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
      if (state.currentAudio) {
        state.currentAudio.pause();
        state.currentAudio = null;
      }
      el.avatar.classList.remove('speaking');
      updateStatus('üîá Audio arr√™t√©');
    });

    const avatars = ['üé≠', 'ü§ñ', 'üëΩ', 'üßô‚Äç‚ôÄÔ∏è', 'ü¶Ñ', 'üåü'];
    let avatarIndex = 0;
    
    el.avatar.addEventListener('click', () => {
      avatarIndex = (avatarIndex + 1) % avatars.length;
      el.avatar.textContent = avatars[avatarIndex];
    });

    console.log('Application charg√©e et pr√™te !');
  </script>
</body>
</html>
