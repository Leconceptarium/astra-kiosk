<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Astra â€“ Assistant de M. Morpheus</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #000;
      font-family: 'Unica One', serif;
    }

    video {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 95%;
      height: auto;
      transform: translate(-50%, -50%);
      object-fit: contain;
      background: #000;
      opacity: 0;
      transition: opacity 0.6s ease;
      display: none;
    }

    #astraIdle.active, #astraIdle2.active {
      display: block;
      opacity: 1;
      z-index: 1;
    }

    #astraReaction {
      z-index: 2;
      display: none;
    }

    #bandeau {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      font-size: clamp(1.5rem, 4vw, 3rem);
      text-align: center;
      padding: 20px;
      white-space: nowrap;
      overflow: hidden;
      z-index: 3;
    }

    #bandeau span {
      display: inline-block;
      animation: defilement 12s linear infinite;
    }

    @keyframes defilement {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

    #parcheminImage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 80%;
      max-height: 80%;
      z-index: 4;
      display: none;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    #parcheminImage.visible {
      opacity: 1;
    }

    .magic {
      position: absolute;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: radial-gradient(
        circle,
        rgba(0, 255, 255, 0.8) 0%,
        rgba(0, 255, 150, 0.25) 40%,
        rgba(0, 100, 100, 0.1) 65%,
        transparent 85%
      );
      filter: blur(3px) brightness(2.2);
      mix-blend-mode: screen;
      animation: fallMagic 6s ease-in-out forwards;
      pointer-events: none;
      z-index: 5;
    }

    @keyframes fallMagic {
      0% {
        transform: translateY(-600px) scale(1.3) rotate(0deg);
        opacity: 0;
      }
      20% {
        opacity: 1;
      }
      60% {
        transform: translateY(0px) scale(0.8) rotate(180deg);
        opacity: 0.9;
      }
      100% {
        transform: translateY(400px) scale(0.6) rotate(360deg);
        opacity: 0;
      }
    }

    #transitionFade {
      position: fixed;
      inset: 0;
      background: radial-gradient(
        circle at center,
        rgba(0, 255, 255, 0.9) 0%,
        rgba(0, 255, 150, 0.4) 30%,
        rgba(0, 100, 100, 0.2) 55%,
        transparent 75%
      );
      opacity: 0;
      pointer-events: none;
      transition: opacity 1.2s ease;
      z-index: 9;
    }

    #fullscreenBtn {
      position: fixed;
      bottom: 20px;
      right: 25px;
      z-index: 10;
      width: 50px;
      height: 50px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      color: #fff;
      font-size: 22px;
      text-align: center;
      line-height: 46px;
      cursor: pointer;
      background: rgba(255,255,255,0.08);
      transition: all .3s ease;
      user-select: none;
    }

    #fullscreenBtn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.6);
      transform: scale(1.1);
    }

    #statusIndicator {
      position: fixed;
      top: 20px;
      right: 25px;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      background: rgba(0,0,0,0.5);
      border-radius: 20px;
      color: #fff;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #statusIndicator.visible {
      opacity: 1;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ff4444;
      animation: pulse 2s infinite;
    }

    .status-dot.listening {
      background: #44ff44;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    #errorMessage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 50, 50, 0.9);
      color: white;
      padding: 20px 40px;
      border-radius: 10px;
      z-index: 11;
      display: none;
      text-align: center;
      max-width: 80%;
    }
  </style>
</head>
<body>
  <!-- VidÃ©os -->
  <video id="astraIdle" src="astra_idle.mp4" autoplay muted loop playsinline preload="auto"></video>
  <video id="astraIdle2" src="astra_idle2.mp4" muted loop playsinline preload="auto"></video>
  <video id="astraReaction" muted playsinline preload="auto"></video>

  <!-- Transition magique -->
  <div id="transitionFade"></div>

  <!-- Indicateur de statut -->
  <div id="statusIndicator">
    <div class="status-dot"></div>
    <span id="statusText">Initialisation...</span>
  </div>

  <!-- Bouton plein Ã©cran -->
  <div id="fullscreenBtn" title="Plein Ã©cran">â›¶</div>

  <!-- Message d'erreur -->
  <div id="errorMessage"></div>

  <div id="bandeau"><span>ASTRA VOUS Ã‰COUTEâ€¦ MAIS ELLE ATTEND VOTRE MOT DE PASSE</span></div>
  <img id="parcheminImage" src="parchemin.png" alt="Parchemin de libÃ©ration" />

  <script>
    // ===== Ã‰LÃ‰MENTS DOM =====
    const elements = {
      bandeau: document.getElementById("bandeau"),
      parcheminImage: document.getElementById("parcheminImage"),
      astraIdle: document.getElementById("astraIdle"),
      astraIdle2: document.getElementById("astraIdle2"),
      astraReaction: document.getElementById("astraReaction"),
      fullscreenBtn: document.getElementById("fullscreenBtn"),
      fade: document.getElementById("transitionFade"),
      statusIndicator: document.getElementById("statusIndicator"),
      statusText: document.getElementById("statusText"),
      statusDot: document.querySelector(".status-dot"),
      errorMessage: document.getElementById("errorMessage")
    };

    // ===== Ã‰TAT DE L'APPLICATION =====
    const state = {
      mdpValid: false,
      isPlaying: false,
      recognition: null
    };

    // ===== CONFIGURATION VIDÃ‰OS =====
    const VIDEO = {
      idle1: "astra_idle.mp4",
      idle2: "astra_idle2.mp4",
      talk: "astra_parle.mp4",
      suspicious: "astra_suspecte.mp4",
      angry: "astra_colere.mp4",
      happy: "astra_heureuse.mp4",
      walkTalk: "marche2.mp4",
      anxious: "inquiete.mp4",
      read: "lecture.mp4",
      joy: "joie.mp4",
      suspicionAlt: "suspicion.mp4",
      confident: "confiant.mp4"
    };

    // ===== CONFIGURATION AUDIO =====
    const audioFiles = {
      bonjour: "salutation_bonjour.mp3",
      qui: "qui_es_tu.mp3",
      ou: "ou_sommes_nous.mp3",
      mdp: "mdp_confirme.mp3",
      mdp_faux: ["mdp_faux.mp3", "mdp_faux_petunia.mp3"],
      petunia: "mdp_faux_petunia.mp3",
      invite_mdp: "invite_mdp.mp3",
      pas_compris: [
        "phrase_non_reconnue.mp3",
        "phrase_non_reconnue2.mp3",
        "phrase_non_reconnue3.mp3",
        "phrase_non_reconnue4.mp3"
      ],
      ca_va: "ca_va.mp3",
      tu_es_la: "tu_es_la.mp3",
      berceuse: "berceuse.mp3",
      notif: "notification_mdp_valide.mp3",
      reve_croire: "reve_croire.mp3",
      pq_reve_plus: "pq_les_humains_reve_plus.mp3",
      qui_morpheus: "c_qui_morpheus.mp3",
      parchemin: "parchemin_liberation.mp3",
      faire_quoi_mtn: "faire_quoi_mtn.mp3",
      rire: "rire.mp3",
      c_toi_qui_controles: "c_toi_qui_controles.mp3",
      blague: "blague.mp3",
      tu_aime_morpheus: "tu_aime_morpheus.mp3",
      la_solution: "la_solution.mp3",
      voix_preenregistree: "voix_preenregistree.mp3",
      mdp_oublie: "mdp_oublie.mp3",
      morpheus_apparence: "morpheus_apparence.mp3",
      indice_aide: "indice_aide.mp3"
    };

    // ===== UTILITAIRES =====
    const utils = {
      showError(message, duration = 3000) {
        elements.errorMessage.textContent = message;
        elements.errorMessage.style.display = 'block';
        setTimeout(() => {
          elements.errorMessage.style.display = 'none';
        }, duration);
      },

      updateStatus(text, isListening = false) {
        elements.statusText.textContent = text;
        if (isListening) {
          elements.statusDot.classList.add('listening');
        } else {
          elements.statusDot.classList.remove('listening');
        }
        elements.statusIndicator.classList.add('visible');
      },

      hideStatus(delay = 2000) {
        setTimeout(() => {
          elements.statusIndicator.classList.remove('visible');
        }, delay);
      },

      getRandomFromArray(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
      }
    };

    // ===== GESTION PLEIN Ã‰CRAN =====
    elements.fullscreenBtn.addEventListener("click", () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          utils.showError("Impossible de passer en plein Ã©cran");
          console.error(err);
        });
      } else {
        document.exitFullscreen();
      }
    });

    // ===== GESTION VIDÃ‰OS =====
    const videoManager = {
      setupLoops() {
        [elements.astraIdle, elements.astraIdle2].forEach(v => {
          v.addEventListener('ended', () => {
            v.currentTime = 0.01;
            v.play().catch(console.error);
          });
        });
      },

      activateIdle(idleVideo) {
        elements.astraIdle.classList.remove("active");
        elements.astraIdle2.classList.remove("active");
        elements.astraIdle.style.display = "none";
        elements.astraIdle2.style.display = "none";

        idleVideo.style.display = "block";
        idleVideo.classList.add("active");
        idleVideo.play().catch(() => {
          idleVideo.muted = true;
          idleVideo.play();
        });
      },

      playReaction(videoName) {
        elements.astraReaction.src = videoName;
        elements.astraReaction.style.display = "block";
        elements.astraIdle.style.opacity = "0.3";
        elements.astraIdle2.style.opacity = "0.3";
        elements.astraReaction.style.opacity = "1";
        elements.astraReaction.currentTime = 0;
        return elements.astraReaction.play();
      },

      endReaction() {
        elements.astraReaction.style.opacity = "0";
        setTimeout(() => {
          elements.astraReaction.style.display = "none";
          const activeIdle = state.mdpValid ? elements.astraIdle2 : elements.astraIdle;
          activeIdle.style.opacity = "1";
          this.activateIdle(activeIdle);
          state.isPlaying = false;
        }, 600);
      }
    };

    // ===== EFFETS MAGIQUES =====
    const magicEffects = {
      spawn() {
        const p = document.createElement("div");
        p.className = "magic";
        p.style.left = Math.random() * 100 + "vw";
        p.style.top = "-40px";
        p.style.animationDuration = 3 + Math.random() * 5 + "s";
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 8000);
      },

      cascade(count = 40, interval = 150) {
        for (let i = 0; i < count; i++) {
          setTimeout(() => this.spawn(), i * interval);
        }
      }
    };

    // ===== GESTION AUDIO =====
    const audioManager = {
      currentAudio: null,

      play(file, videoName = VIDEO.talk) {
        if (state.isPlaying) return;
        state.isPlaying = true;

        if (this.currentAudio) {
          this.currentAudio.pause();
          this.currentAudio = null;
        }

        this.currentAudio = new Audio(file);
        videoManager.playReaction(videoName);

        this.currentAudio.play().catch(err => {
          console.error("Erreur lecture audio:", err);
          videoManager.endReaction();
        });

        this.currentAudio.onended = () => {
          videoManager.endReaction();
          this.currentAudio = null;
        };
      }
    };

    // ===== GESTION PARCHEMIN =====
    const parcheminManager = {
      show(duration = 15000) {
        elements.parcheminImage.style.display = "block";
        setTimeout(() => {
          elements.parcheminImage.classList.add('visible');
        }, 10);
        
        setTimeout(() => {
          this.hide();
        }, duration);
      },

      hide() {
        elements.parcheminImage.classList.remove('visible');
        setTimeout(() => {
          elements.parcheminImage.style.display = "none";
        }, 500);
      }
    };

    // ===== DÃ‰TECTION DE PHRASES =====
    const phraseDetector = {
      normalize(text) {
        return text.toLowerCase().trim();
      },

      detect(text) {
        const t = this.normalize(text);

        // Salutations
        if (/bonjour|salut|coucou|bonsoir|wesh|yo/i.test(t)) {
          return { file: audioFiles.bonjour, video: VIDEO.happy };
        }

        // IdentitÃ©
        if (/qui (tu es|es-tu)|t'es qui|c'est quoi toi|astra|c'est quoi ce truc/i.test(t)) {
          return { file: audioFiles.qui, video: VIDEO.happy };
        }

        // Localisation
        if (/oÃ¹ sommes|on est oÃ¹|quel est cet endroit/i.test(t)) {
          return { file: audioFiles.ou, video: VIDEO.anxious };
        }

        // Mot de passe
        if (/bonne nuit|le mot de passe c'est bonne nuit/i.test(t)) {
          return this.handlePassword();
        }

        // Mot de passe oubliÃ©
        if (/mot de passe oubliÃ©|j'ai oubliÃ©|comment trouver/i.test(t)) {
          return { file: audioFiles.mdp_oublie, video: VIDEO.anxious };
        }

        // PÃ©tunia
        if (/pÃ©tunia/i.test(t)) {
          return { file: audioFiles.petunia, video: VIDEO.angry };
        }

        // Parchemin
        if (/parchemin|marchemin|par chemin|potion.*libÃ©ration|recette.*liberation/i.test(t)) {
          return this.handleParchemin();
        }

        // Connaissance du mot de passe
        if (/je connais le mot de passe|j'ai trouvÃ© le mot de passe/i.test(t)) {
          return { file: audioFiles.invite_mdp, video: VIDEO.anxious };
        }

        // Questions diverses
        if (/Ã§a va|comment tu vas|tu vas bien/i.test(t)) {
          return { file: audioFiles.ca_va, video: VIDEO.happy };
        }

        if (/tu es lÃ |t'es lÃ |hÃ© ho|tu m'entends/i.test(t)) {
          return { file: audioFiles.tu_es_la, video: VIDEO.anxious };
        }

        if (/berceuse|musique pour dormir/i.test(t)) {
          return { file: audioFiles.berceuse, video: VIDEO.talk };
        }

        if (/tu crois en nous|on va rÃ©ussir/i.test(t)) {
          return { file: audioFiles.reve_croire, video: VIDEO.confident };
        }

        if (/pourquoi les humains ne rÃªvent plus/i.test(t)) {
          return { file: audioFiles.pq_reve_plus, video: VIDEO.suspicionAlt };
        }

        if (/qui est morpheus/i.test(t)) {
          return { file: audioFiles.qui_morpheus, video: VIDEO.walkTalk };
        }

        if (/blague|raconte une blague/i.test(t)) {
          return this.handleJoke();
        }

        if (/tu aimes morpheus|tu nous aimes/i.test(t)) {
          return { file: audioFiles.tu_aime_morpheus, video: VIDEO.happy };
        }

        if (/solution/i.test(t)) {
          return { file: audioFiles.la_solution, video: VIDEO.walkTalk };
        }

        if (/contrÃ´les/i.test(t)) {
          return { file: audioFiles.c_toi_qui_controles, video: VIDEO.suspicious };
        }

        if (/prÃ©enregistrÃ©e/i.test(t)) {
          return { file: audioFiles.voix_preenregistree, video: VIDEO.suspicious };
        }

        if (/indice|aide/i.test(t)) {
          return { file: audioFiles.indice_aide, video: VIDEO.suspicionAlt };
        }

        if (/faut faire quoi/i.test(t)) {
          return { file: audioFiles.faire_quoi_mtn, video: VIDEO.walkTalk };
        }

        // Phrase non reconnue
        return { 
          file: utils.getRandomFromArray(audioFiles.pas_compris), 
          video: VIDEO.anxious 
        };
      },

      handlePassword() {
        if (!state.mdpValid) {
          state.mdpValid = true;
          elements.bandeau.style.display = "none";
          audioManager.play(audioFiles.mdp, VIDEO.happy);

          setTimeout(() => {
            magicEffects.cascade(40, 150);
            audioManager.play(audioFiles.notif, VIDEO.walkTalk);

            // Transition magique
            elements.fade.style.opacity = "1";
            setTimeout(() => {
              elements.astraIdle.classList.remove("active");
              videoManager.activateIdle(elements.astraIdle2);
              elements.fade.style.opacity = "0";
            }, 1500);
          }, 3000);

          return null;
        } else {
          return { file: audioFiles.mdp, video: VIDEO.walkTalk };
        }
      },

      handleParchemin() {
        if (state.mdpValid) {
          parcheminManager.show(15000);
          return { file: audioFiles.parchemin, video: VIDEO.read };
        } else {
          const faux = utils.getRandomFromArray(audioFiles.mdp_faux);
          return { file: faux, video: VIDEO.angry };
        }
      },

      handleJoke() {
        audioManager.play(audioFiles.blague, VIDEO.joy);
        setTimeout(() => {
          audioManager.play(audioFiles.rire, VIDEO.happy);
        }, 2500);
        return null;
      }
    };

    // ===== RECONNAISSANCE VOCALE =====
    const speechRecognition = {
      init() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
          utils.showError("Reconnaissance vocale non supportÃ©e", 5000);
          return false;
        }

        state.recognition = new SpeechRecognition();
        state.recognition.continuous = true;
        state.recognition.lang = 'fr-FR';
        state.recognition.interimResults = false;

        state.recognition.onstart = () => {
          utils.updateStatus("Ã‰coute active", true);
        };

        state.recognition.onresult = (e) => {
          const text = e.results[e.results.length - 1][0].transcript.trim();
          console.log("ðŸŽ™ï¸ Entendu :", text);
          
          const res = phraseDetector.detect(text);
          if (res && res.file) {
            audioManager.play(res.file, res.video);
          }
        };

        state.recognition.onerror = (e) => {
          console.error("Erreur reconnaissance vocale:", e.error);
          if (e.error === 'no-speech') {
            // Pas d'erreur affichÃ©e pour no-speech
          } else if (e.error === 'not-allowed') {
            utils.showError("Micro non autorisÃ©", 5000);
            utils.updateStatus("Micro dÃ©sactivÃ©", false);
          } else {
            utils.updateStatus("Erreur micro", false);
          }
        };

        state.recognition.onend = () => {
          setTimeout(() => {
            if (state.recognition) {
              state.recognition.start();
            }
          }, 1000);
        };

        return true;
      },

      start() {
        if (state.recognition) {
          state.recognition.start();
        }
      }
    };

    // ===== INITIALISATION =====
    const app = {
      async init() {
        try {
          // Configuration des vidÃ©os
          videoManager.setupLoops();

          // Demande d'accÃ¨s au micro
          utils.updateStatus("Demande d'accÃ¨s au micro...", false);
          await navigator.mediaDevices.getUserMedia({ audio: true });

          // Initialisation de la reconnaissance vocale
          if (speechRecognition.init()) {
            videoManager.activateIdle(elements.astraIdle);
            elements.astraIdle.play().catch(() => {
              elements.astraIdle.muted = true;
              elements.astraIdle.play();
            });

            speechRecognition.start();
            utils.updateStatus("PrÃªt - Parlez Ã  Astra", true);
            utils.hideStatus(3000);
          } else {
            utils.showError("Reconnaissance vocale non disponible", 5000);
          }

        } catch (err) {
          console.error("Erreur initialisation:", err);
          utils.showError("Micro refusÃ© ou non disponible", 5000);
          utils.updateStatus("Erreur d'initialisation", false);
        }
      }
    };

    // ===== LANCEMENT =====
    window.onload = () => {
      app.init();
    };
  </script>
</body>
</html>
