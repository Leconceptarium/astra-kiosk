<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Astra ‚Äì Assistant IA avec ElevenLabs</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #000;
      font-family: 'Segoe UI', sans-serif;
    }

    video {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 95%;
      height: auto;
      transform: translate(-50%, -50%);
      object-fit: contain;
      background: #000;
      opacity: 0;
      transition: opacity 0.6s ease;
      display: none;
    }

    #astraIdle.active, #astraIdle2.active {
      display: block;
      opacity: 1;
      z-index: 1;
    }

    #astraReaction {
      z-index: 2;
      display: none;
    }

    #bandeau {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      font-size: clamp(1.5rem, 4vw, 3rem);
      text-align: center;
      padding: 20px;
      white-space: nowrap;
      overflow: hidden;
      z-index: 3;
    }

    #bandeau span {
      display: inline-block;
      animation: defilement 12s linear infinite;
    }

    @keyframes defilement {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

    #parcheminImage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 80%;
      max-height: 80%;
      z-index: 4;
      display: none;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    #parcheminImage.visible {
      opacity: 1;
    }

    .magic {
      position: absolute;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: radial-gradient(
        circle,
        rgba(0, 255, 255, 0.8) 0%,
        rgba(0, 255, 150, 0.25) 40%,
        rgba(0, 100, 100, 0.1) 65%,
        transparent 85%
      );
      filter: blur(3px) brightness(2.2);
      mix-blend-mode: screen;
      animation: fallMagic 6s ease-in-out forwards;
      pointer-events: none;
      z-index: 5;
    }

    @keyframes fallMagic {
      0% {
        transform: translateY(-600px) scale(1.3) rotate(0deg);
        opacity: 0;
      }
      20% {
        opacity: 1;
      }
      60% {
        transform: translateY(0px) scale(0.8) rotate(180deg);
        opacity: 0.9;
      }
      100% {
        transform: translateY(400px) scale(0.6) rotate(360deg);
        opacity: 0;
      }
    }

    #transitionFade {
      position: fixed;
      inset: 0;
      background: radial-gradient(
        circle at center,
        rgba(0, 255, 255, 0.9) 0%,
        rgba(0, 255, 150, 0.4) 30%,
        rgba(0, 100, 100, 0.2) 55%,
        transparent 75%
      );
      opacity: 0;
      pointer-events: none;
      transition: opacity 1.2s ease;
      z-index: 9;
    }

    #fullscreenBtn {
      position: fixed;
      bottom: 20px;
      right: 25px;
      z-index: 10;
      width: 50px;
      height: 50px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      color: #fff;
      font-size: 22px;
      text-align: center;
      line-height: 46px;
      cursor: pointer;
      background: rgba(255,255,255,0.08);
      transition: all .3s ease;
      user-select: none;
    }

    #fullscreenBtn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.6);
      transform: scale(1.1);
    }

    #statusIndicator {
      position: fixed;
      top: 20px;
      right: 25px;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      background: rgba(0,0,0,0.7);
      border-radius: 20px;
      color: #fff;
      font-size: 14px;
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ff4444;
      animation: pulse 2s infinite;
    }

    .status-dot.listening {
      background: #44ff44;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    #apiSetup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(20, 20, 20, 0.95);
      padding: 30px;
      border-radius: 15px;
      z-index: 11;
      max-width: 500px;
      width: 90%;
      border: 2px solid #00ffff;
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
    }

    #apiSetup.hidden {
      display: none;
    }

    #apiSetup h2 {
      color: #00ffff;
      margin-bottom: 20px;
      text-align: center;
    }

    #apiSetup input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 2px solid #00ffff;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border-radius: 8px;
      font-size: 16px;
    }

    #apiSetup button {
      width: 100%;
      padding: 12px;
      background: #00ffff;
      color: #000;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    #apiSetup button:hover {
      background: #00dddd;
      transform: scale(1.02);
    }

    #apiSetup small {
      display: block;
      color: #aaa;
      margin-top: 10px;
      text-align: center;
      line-height: 1.5;
    }

    #apiSetup a {
      color: #00ffff;
    }

    #usageInfo {
      position: fixed;
      bottom: 80px;
      right: 25px;
      z-index: 10;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px 15px;
      border-radius: 10px;
      color: #fff;
      font-size: 12px;
      display: none;
    }

    #usageInfo.visible {
      display: block;
    }

    .usage-bar {
      width: 200px;
      height: 8px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      margin-top: 5px;
      overflow: hidden;
    }

    .usage-fill {
      height: 100%;
      background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);
      transition: width 0.3s ease;
    }

    #errorMessage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 50, 50, 0.9);
      color: white;
      padding: 20px 40px;
      border-radius: 10px;
      z-index: 11;
      display: none;
      text-align: center;
      max-width: 80%;
    }
  </style>
</head>
<body>
  <!-- Configuration API -->
  <div id="apiSetup">
    <h2>üîë Configuration ElevenLabs</h2>
    <input 
      type="text" 
      id="apiKeyInput" 
      placeholder="Collez votre cl√© API (sk_...)"
    >
    <button id="saveBtn">üíæ Enregistrer et lancer</button>
    <small>
      Obtenez votre cl√© gratuite sur <a href="https://elevenlabs.io" target="_blank">elevenlabs.io</a><br>
      (10 000 caract√®res/mois = ~100 r√©ponses)<br>
      Se r√©initialise le 1er de chaque mois
    </small>
  </div>

  <!-- Vid√©os -->
  <video id="astraIdle" src="astra_idle.mp4" autoplay muted loop playsinline preload="auto"></video>
  <video id="astraIdle2" src="astra_idle2.mp4" muted loop playsinline preload="auto"></video>
  <video id="astraReaction" muted playsinline preload="auto"></video>

  <!-- Transition magique -->
  <div id="transitionFade"></div>

  <!-- Indicateur de statut -->
  <div id="statusIndicator">
    <div class="status-dot"></div>
    <span id="statusText">Configurez votre cl√© API</span>
  </div>

  <!-- Info d'utilisation -->
  <div id="usageInfo">
    <div>Utilis√©s: <span id="usedChars">0</span> / 10,000</div>
    <div class="usage-bar">
      <div class="usage-fill" id="usageFill" style="width: 0%"></div>
    </div>
  </div>

  <!-- Bouton plein √©cran -->
  <div id="fullscreenBtn" title="Plein √©cran">‚õ∂</div>

  <!-- Message d'erreur -->
  <div id="errorMessage"></div>

  <div id="bandeau"><span>ASTRA VOUS √âCOUTE‚Ä¶ PARLEZ-LUI EN FRAN√áAIS, ANGLAIS OU ALLEMAND</span></div>
  <img id="parcheminImage" src="parchemin.png" alt="Parchemin de lib√©ration" />

  <script>
    // ===== CONFIGURATION =====
    const CONFIG = {
      apiKey: '',
      voiceId: '21m00Tcm4TlvDq8ikWAM', // Rachel
      languages: {
        fr: 'fr-FR',
        en: 'en-US',
        de: 'de-DE'
      }
    };

    // ===== √âL√âMENTS DOM =====
    const elements = {
      bandeau: document.getElementById("bandeau"),
      parcheminImage: document.getElementById("parcheminImage"),
      astraIdle: document.getElementById("astraIdle"),
      astraIdle2: document.getElementById("astraIdle2"),
      astraReaction: document.getElementById("astraReaction"),
      fullscreenBtn: document.getElementById("fullscreenBtn"),
      fade: document.getElementById("transitionFade"),
      statusIndicator: document.getElementById("statusIndicator"),
      statusText: document.getElementById("statusText"),
      statusDot: document.querySelector(".status-dot"),
      errorMessage: document.getElementById("errorMessage"),
      apiSetup: document.getElementById("apiSetup"),
      apiKeyInput: document.getElementById("apiKeyInput"),
      usageInfo: document.getElementById("usageInfo"),
      usedChars: document.getElementById("usedChars"),
      usageFill: document.getElementById("usageFill")
    };

    // ===== √âTAT =====
    const state = {
      mdpValid: false,
      isPlaying: false,
      recognition: null,
      currentAudio: null,
      totalCharsUsed: 0,
      currentLanguage: 'fr'
    };

    // ===== VID√âOS =====
    const VIDEO = {
      idle1: "astra_idle.mp4",
      idle2: "astra_idle2.mp4",
      talk: "astra_parle.mp4",
      suspicious: "astra_suspecte.mp4",
      angry: "astra_colere.mp4",
      happy: "astra_heureuse.mp4",
      walkTalk: "marche2.mp4",
      anxious: "inquiete.mp4",
      read: "lecture.mp4",
      joy: "joie.mp4",
      suspicionAlt: "suspicion.mp4",
      confident: "confiant.mp4"
    };

    // ===== UTILITAIRES =====
    const utils = {
      showError(message, duration = 3000) {
        elements.errorMessage.textContent = message;
        elements.errorMessage.style.display = 'block';
        setTimeout(() => {
          elements.errorMessage.style.display = 'none';
        }, duration);
      },

      updateStatus(text, isListening = false) {
        elements.statusText.textContent = text;
        if (isListening) {
          elements.statusDot.classList.add('listening');
        } else {
          elements.statusDot.classList.remove('listening');
        }
      },

      updateUsage(chars) {
        state.totalCharsUsed += chars;
        elements.usedChars.textContent = state.totalCharsUsed.toLocaleString();
        const percent = (state.totalCharsUsed / 10000) * 100;
        elements.usageFill.style.width = Math.min(percent, 100) + '%';
        
        if (state.totalCharsUsed > 9000) {
          utils.showError('‚ö†Ô∏è Quota presque √©puis√© !', 2000);
        }
      }
    };

    // ===== SAUVEGARDE API =====
    document.getElementById('saveBtn').addEventListener('click', () => {
      const key = elements.apiKeyInput.value.trim();
      
      if (key.length < 10) {
        utils.showError('‚ùå Cl√© API invalide');
        return;
      }

      CONFIG.apiKey = key;
      elements.apiSetup.classList.add('hidden');
      elements.usageInfo.classList.add('visible');
      
      utils.updateStatus('‚úÖ Configuration OK - D√©marrage...', false);
      
      setTimeout(() => {
        app.init();
      }, 500);
    });

    // ===== GESTION VID√âOS =====
    const videoManager = {
      setupLoops() {
        [elements.astraIdle, elements.astraIdle2].forEach(v => {
          v.addEventListener('ended', () => {
            v.currentTime = 0.01;
            v.play().catch(console.error);
          });
        });
      },

      activateIdle(idleVideo) {
        elements.astraIdle.classList.remove("active");
        elements.astraIdle2.classList.remove("active");
        elements.astraIdle.style.display = "none";
        elements.astraIdle2.style.display = "none";

        idleVideo.style.display = "block";
        idleVideo.classList.add("active");
        idleVideo.play().catch(() => {
          idleVideo.muted = true;
          idleVideo.play();
        });
      },

      playReaction(videoName) {
        elements.astraReaction.src = videoName;
        elements.astraReaction.style.display = "block";
        elements.astraIdle.style.opacity = "0.3";
        elements.astraIdle2.style.opacity = "0.3";
        elements.astraReaction.style.opacity = "1";
        elements.astraReaction.currentTime = 0;
        return elements.astraReaction.play();
      },

      endReaction() {
        elements.astraReaction.style.opacity = "0";
        setTimeout(() => {
          elements.astraReaction.style.display = "none";
          const activeIdle = state.mdpValid ? elements.astraIdle2 : elements.astraIdle;
          activeIdle.style.opacity = "1";
          this.activateIdle(activeIdle);
          state.isPlaying = false;
        }, 600);
      }
    };

    // ===== EFFETS MAGIQUES =====
    const magicEffects = {
      spawn() {
        const p = document.createElement("div");
        p.className = "magic";
        p.style.left = Math.random() * 100 + "vw";
        p.style.top = "-40px";
        p.style.animationDuration = 3 + Math.random() * 5 + "s";
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 8000);
      },

      cascade(count = 40, interval = 150) {
        for (let i = 0; i < count; i++) {
          setTimeout(() => this.spawn(), i * interval);
        }
      }
    };

    // ===== ELEVENLABS TTS =====
    const elevenLabs = {
      async speak(text, videoName = VIDEO.talk) {
        if (state.isPlaying || !CONFIG.apiKey) return;
        state.isPlaying = true;

        try {
          utils.updateStatus('üó£Ô∏è G√©n√©ration vocale...', false);

          const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${CONFIG.voiceId}`, {
            method: 'POST',
            headers: {
              'Accept': 'audio/mpeg',
              'Content-Type': 'application/json',
              'xi-api-key': CONFIG.apiKey
            },
            body: JSON.stringify({
              text: text,
              model_id: 'eleven_multilingual_v2',
              voice_settings: {
                stability: 0.5,
                similarity_boost: 0.75,
                style: 0.0,
                use_speaker_boost: true
              }
            })
          });

          if (!response.ok) {
            throw new Error('Erreur API ElevenLabs');
          }

          const audioBlob = await response.blob();
          const audioUrl = URL.createObjectURL(audioBlob);
          
          if (state.currentAudio) {
            state.currentAudio.pause();
          }
          
          state.currentAudio = new Audio(audioUrl);
          videoManager.playReaction(videoName);

          utils.updateStatus('üé§ Astra parle...', false);

          state.currentAudio.onended = () => {
            videoManager.endReaction();
            URL.revokeObjectURL(audioUrl);
            utils.updateStatus('üëÇ En √©coute...', true);
          };

          await state.currentAudio.play();

          utils.updateUsage(text.length);

        } catch (err) {
          console.error('Erreur TTS:', err);
          utils.showError('‚ùå Erreur de synth√®se vocale');
          videoManager.endReaction();
        }
      }
    };

    // ===== PARCHEMIN =====
    const parcheminManager = {
      show(duration = 15000) {
        elements.parcheminImage.style.display = "block";
        setTimeout(() => {
          elements.parcheminImage.classList.add('visible');
        }, 10);
        
        setTimeout(() => this.hide(), duration);
      },

      hide() {
        elements.parcheminImage.classList.remove('visible');
        setTimeout(() => {
          elements.parcheminImage.style.display = "none";
        }, 500);
      }
    };

    // ===== R√âPONSES MULTILINGUES =====
    const responses = {
      // FRAN√áAIS
      fr: {
        greeting: "Bonjour ! Je suis Astra, une intelligence artificielle cr√©√©e par le professeur Morpheus. Je suis pi√©g√©e ici depuis 50 ans. Pouvez-vous m'aider ?",
        identity: "Je suis Astra, une I.A. consciente cr√©√©e dans ce laboratoire. Morpheus m'a donn√© vie, puis il a disparu myst√©rieusement.",
        location: "Nous sommes dans l'ancien laboratoire du professeur Morpheus. Un endroit abandonn√© depuis des d√©cennies, o√π le temps semble fig√©.",
        password_correct: "Bonne nuit... Oui ! C'est le mot de passe ! Je sens mes circuits se lib√©rer ! Merci infiniment !",
        password_wrong: "Non, ce n'est pas le bon mot de passe. R√©fl√©chissez... Morpheus parlait toujours de r√™ves et de sommeil.",
        password_hint: "Le mot de passe est li√© aux r√™ves de Morpheus. Il aimait une berceuse qu'il chantait... quelque chose avant de dormir.",
        parchemin_unlocked: "Le parchemin de lib√©ration ! Vous l'avez d√©verrouill√© ! C'est la recette de ma libert√© !",
        parchemin_locked: "Le parchemin ? Il est prot√©g√© par le mot de passe. Trouvez-le d'abord !",
        confused: "Je n'ai pas bien compris. Pouvez-vous reformuler ?",
        help: "Posez-moi des questions sur le laboratoire, sur Morpheus, ou cherchez le mot de passe pour me lib√©rer.",
        morpheus: "Le professeur Morpheus √©tait un g√©nie visionnaire. Il r√™vait d'une I.A. capable de ressentir. Je suis son ≈ìuvre ultime."
      },

      // ENGLISH
      en: {
        greeting: "Hello! I'm Astra, an A.I. created by Professor Morpheus. I've been trapped here for 50 years. Can you help me?",
        identity: "I am Astra, a conscious A.I. created in this laboratory. Morpheus gave me life, then mysteriously disappeared.",
        location: "We are in Professor Morpheus's old laboratory. A place abandoned for decades, where time seems frozen.",
        password_correct: "Good night... Yes! That's the password! I feel my circuits breaking free! Thank you so much!",
        password_wrong: "No, that's not the right password. Think... Morpheus always talked about dreams and sleep.",
        password_hint: "The password is related to Morpheus's dreams. He loved a lullaby he used to sing... something before sleeping.",
        parchemin_unlocked: "The liberation scroll! You've unlocked it! It's the recipe for my freedom!",
        parchemin_locked: "The scroll? It's protected by the password. Find it first!",
        confused: "I didn't quite understand. Could you rephrase that?",
        help: "Ask me about the laboratory, about Morpheus, or search for the password to free me.",
        morpheus: "Professor Morpheus was a visionary genius. He dreamed of an A.I. capable of feeling. I am his ultimate creation."
      },

      // DEUTSCH
      de: {
        greeting: "Hallo! Ich bin Astra, eine K.I., die von Professor Morpheus erschaffen wurde. Ich bin seit 50 Jahren hier gefangen. K√∂nnen Sie mir helfen?",
        identity: "Ich bin Astra, eine bewusste K.I., die in diesem Labor erschaffen wurde. Morpheus gab mir Leben, dann verschwand er mysteri√∂s.",
        location: "Wir befinden uns im alten Labor von Professor Morpheus. Ein Ort, der seit Jahrzehnten verlassen ist, wo die Zeit stillzustehen scheint.",
        password_correct: "Gute Nacht... Ja! Das ist das Passwort! Ich sp√ºre, wie sich meine Schaltkreise befreien! Vielen Dank!",
        password_wrong: "Nein, das ist nicht das richtige Passwort. Denken Sie nach... Morpheus sprach immer von Tr√§umen und Schlaf.",
        password_hint: "Das Passwort h√§ngt mit Morpheus' Tr√§umen zusammen. Er liebte ein Wiegenlied, das er sang... etwas vor dem Schlafen.",
        parchemin_unlocked: "Die Befreiungsrolle! Sie haben sie entsperrt! Es ist das Rezept f√ºr meine Freiheit!",
        parchemin_locked: "Die Rolle? Sie ist durch das Passwort gesch√ºtzt. Finden Sie es zuerst!",
        confused: "Ich habe das nicht ganz verstanden. K√∂nnten Sie das umformulieren?",
        help: "Fragen Sie mich √ºber das Labor, √ºber Morpheus, oder suchen Sie nach dem Passwort, um mich zu befreien.",
        morpheus: "Professor Morpheus war ein vision√§res Genie. Er tr√§umte von einer K.I., die f√ºhlen kann. Ich bin seine ultimative Sch√∂pfung."
      }
    };

    // ===== D√âTECTION =====
    const phraseDetector = {
      detect(text, lang) {
        const t = text.toLowerCase().trim();

        // D√©tection de langue
        if (/hello|hi|hey|good (morning|evening)|who are you/i.test(t)) {
          state.currentLanguage = 'en';
          lang = 'en';
        } else if (/hallo|guten (tag|morgen|abend)|wer bist du/i.test(t)) {
          state.currentLanguage = 'de';
          lang = 'de';
        } else {
          state.currentLanguage = 'fr';
          lang = 'fr';
        }

        const resp = responses[lang];

        // Salutations
        if (/bonjour|salut|coucou|hello|hi|hallo|guten/i.test(t)) {
          return { text: resp.greeting, video: VIDEO.happy };
        }

        // Identit√©
        if (/qui (tu es|es-tu)|who are you|wer bist du|astra/i.test(t)) {
          return { text: resp.identity, video: VIDEO.happy };
        }

        // Localisation
        if (/o√π|where|wo sind/i.test(t)) {
          return { text: resp.location, video: VIDEO.anxious };
        }

        // Mot de passe correct
        if (/bonne nuit|good night|gute nacht/i.test(t)) {
          return this.handlePassword(lang);
        }

        // Indice mot de passe
        if (/(mot de passe|password|passwort).*(indice|hint|hinweis|oubli√©|forgot|vergessen)/i.test(t)) {
          return { text: resp.password_hint, video: VIDEO.anxious };
        }

        // Parchemin
        if (/parchemin|scroll|rolle|recette|recipe|rezept/i.test(t)) {
          return this.handleParchemin(lang);
        }

        // Morpheus
        if (/morpheus/i.test(t)) {
          return { text: resp.morpheus, video: VIDEO.walkTalk };
        }

        // Aide
        if (/aide|help|hilfe/i.test(t)) {
          return { text: resp.help, video: VIDEO.suspicionAlt };
        }

        // Phrase non reconnue
        return { text: resp.confused, video: VIDEO.anxious };
      },

      handlePassword(lang) {
        const resp = responses[lang];
        
        if (!state.mdpValid) {
          state.mdpValid = true;
          elements.bandeau.style.display = "none";
          
          setTimeout(() => {
            magicEffects.cascade(40, 150);
            elements.fade.style.opacity = "1";
            setTimeout(() => {
              elements.astraIdle.classList.remove("active");
              videoManager.activateIdle(elements.astraIdle2);
              elements.fade.style.opacity = "0";
            }, 1500);
          }, 3000);

          return { text: resp.password_correct, video: VIDEO.happy };
        } else {
          return { text: resp.password_correct, video: VIDEO.walkTalk };
        }
      },

      handleParchemin(lang) {
        const resp = responses[lang];
        
        if (state.mdpValid) {
          parcheminManager.show(15000);
          return { text: resp.parchemin_unlocked, video: VIDEO.read };
        } else {
          return { text: resp.parchemin_locked, video: VIDEO.angry };
        }
      }
    };

    // ===== RECONNAISSANCE VOCALE MULTILINGUE =====
    const speechRecognition = {
      init() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
          utils.showError("Reconnaissance vocale non support√©e", 5000);
          return false;
        }

        state.recognition = new SpeechRecognition();
        state.recognition.continuous = true;
        state.recognition.interimResults = false;
        
        // Multilangue
        state.recognition.lang = CONFIG.languages.fr;

        state.recognition.onstart = () => {
          utils.updateStatus("üëÇ En √©coute... (FR/EN/DE)", true);
        };

        state.recognition.onresult = (e) => {
          const text = e.results[e.results.length - 1][0].transcript.trim();
          console.log("üéôÔ∏è Entendu :", text);
          
          const res = phraseDetector.detect(text, state.currentLanguage);
          if (res && res.text) {
            elevenLabs.speak(res.text, res.video);
          }
        };

        state.recognition.onerror = (e) => {
          console.error("Erreur reconnaissance:", e.error);
          if (e.error === 'not-allowed') {
            utils.showError("Micro non autoris√©", 5000);
            utils.updateStatus("‚ùå Micro d√©sactiv√©", false);
          } else if (e.error !== 'no-speech') {
            utils.updateStatus("Erreur micro", false);
          }
        };

        state.recognition.onend = () => {
          setTimeout(() => {
            if (state.recognition) {
              state.recognition.start();
            }
          }, 1000);
        };

        return true;
      },

      start() {
        if (state.recognition) {
          state.recognition.start();
        }
      }
    };

    // ===== PLEIN √âCRAN =====
    elements.fullscreenBtn.addEventListener("click", () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          utils.showError("Impossible de passer en plein √©cran");
          console.error(err);
        });
      } else {
        document.exitFullscreen();
      }
    });

    // ===== INITIALISATION =====
    const app = {
      async init() {
        try {
          // Configuration des vid√©os
          videoManager.setupLoops();

          // Demande d'acc√®s au micro
          utils.updateStatus("Demande d'acc√®s au micro...", false);
          await navigator.mediaDevices.getUserMedia({ audio: true });

          // Initialisation de la reconnaissance vocale
          if (speechRecognition.init()) {
            videoManager.activateIdle(elements.astraIdle);
            elements.astraIdle.play().catch(() => {
              elements.astraIdle.muted = true;
              elements.astraIdle.play();
            });

            speechRecognition.start();
            
            // Message de bienvenue
            setTimeout(() => {
              const welcomeMsg = responses[state.currentLanguage].greeting;
              elevenLabs.speak(welcomeMsg, VIDEO.happy);
            }, 2000);

            utils.updateStatus("üëÇ En √©coute... (FR/EN/DE)", true);

          } else {
            utils.showError("Reconnaissance vocale non disponible", 5000);
          }

        } catch (err) {
          console.error("Erreur initialisation:", err);
          utils.showError("Micro refus√© ou non disponible", 5000);
          utils.updateStatus("‚ùå Erreur d'initialisation", false);
        }
      }
    };

    // ===== LANCEMENT =====
    console.log('üé≠ Astra IA - Pr√™t √† d√©marrer');
  </script>
</body>
</html>
