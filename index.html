<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astra - L'Atelier de M. Morpheus</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            cursor: none;
        }

        body {
            font-family: 'Cinzel', 'Georgia', serif;
            background: linear-gradient(135deg, #1a0033 0%, #0d001a 50%, #1a0033 100%);
            color: #d4af37;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Zone gauche - Sc√®ne */
        .scene {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: radial-gradient(ellipse at center, rgba(75, 0, 130, 0.3) 0%, transparent 70%);
            position: relative;
            overflow: hidden;
        }

        .scene::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="rgba(212,175,55,0.1)"/></svg>') repeat;
            background-size: 50px 50px;
            opacity: 0.3;
            animation: stars 20s linear infinite;
        }

        @keyframes stars {
            from { transform: translateY(0); }
            to { transform: translateY(-50px); }
        }

        .astra-logo {
            font-size: 4rem;
            font-weight: bold;
            text-shadow: 0 0 20px #8b00ff, 0 0 40px #8b00ff;
            margin-bottom: 2rem;
            animation: glow 2s ease-in-out infinite alternate;
            z-index: 1;
        }

        @keyframes glow {
            from { text-shadow: 0 0 20px #8b00ff, 0 0 40px #8b00ff; }
            to { text-shadow: 0 0 30px #d4af37, 0 0 60px #8b00ff, 0 0 90px #8b00ff; }
        }

        .status {
            font-size: 1.2rem;
            padding: 1rem 2rem;
            background: rgba(139, 0, 255, 0.2);
            border: 2px solid #8b00ff;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 0 20px rgba(139, 0, 255, 0.4);
            z-index: 1;
        }

        .listening-indicator {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle, #8b00ff 0%, transparent 70%);
            animation: pulse 1.5s ease-in-out infinite;
            margin-top: 2rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1;
        }

        .listening-indicator.active {
            opacity: 1;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        /* Zone droite - Fil de l'atelier */
        .chat-panel {
            width: 400px;
            background: linear-gradient(180deg, rgba(13, 0, 26, 0.95) 0%, rgba(26, 0, 51, 0.95) 100%);
            border-left: 3px solid #8b00ff;
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 30px rgba(139, 0, 255, 0.3);
        }

        .chat-header {
            padding: 1.5rem;
            background: rgba(139, 0, 255, 0.2);
            border-bottom: 2px solid #8b00ff;
            text-align: center;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(139, 0, 255, 0.1);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #8b00ff;
            border-radius: 4px;
        }

        .message {
            padding: 1rem;
            border-radius: 15px;
            max-width: 85%;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid #d4af37;
            align-self: flex-end;
            margin-left: auto;
        }

        .message.astra {
            background: rgba(139, 0, 255, 0.2);
            border: 1px solid #8b00ff;
            align-self: flex-start;
        }

        .message-label {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 0.3rem;
            font-style: italic;
        }

        .message-text {
            font-size: 1rem;
            line-height: 1.4;
        }

        /* Parchemin pour la cr√©ature */
        .scroll-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.5s;
        }

        .scroll-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .scroll-content {
            background: linear-gradient(180deg, #f4e4c1 0%, #e8d4a8 100%);
            padding: 3rem;
            border-radius: 10px;
            border: 5px solid #8b4513;
            box-shadow: 0 0 50px rgba(139, 0, 255, 0.6), inset 0 0 30px rgba(139, 69, 19, 0.3);
            max-width: 600px;
            text-align: center;
            color: #3d2817;
            font-family: 'Courier New', monospace;
            animation: scrollUnfold 0.8s ease-out;
        }

        @keyframes scrollUnfold {
            from {
                transform: scale(0.3) rotateX(90deg);
                opacity: 0;
            }
            to {
                transform: scale(1) rotateX(0);
                opacity: 1;
            }
        }

        .scroll-content h2 {
            font-size: 2rem;
            margin-bottom: 1.5rem;
            color: #8b0000;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .scroll-content p {
            font-size: 1.2rem;
            line-height: 1.8;
            margin-bottom: 1rem;
        }

        .scroll-close {
            margin-top: 2rem;
            padding: 0.8rem 2rem;
            background: #8b4513;
            color: #f4e4c1;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .scroll-close:hover {
            background: #a0522d;
            transform: scale(1.05);
        }

        /* Responsive tablette */
        @media (max-width: 1024px) {
            .chat-panel {
                width: 350px;
            }
            .astra-logo {
                font-size: 3rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .scene {
                flex: 0 0 40%;
            }
            .chat-panel {
                width: 100%;
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="scene">
            <div class="astra-logo">ASTRA</div>
            <div class="status" id="status">Initialisation...</div>
            <div class="listening-indicator" id="indicator"></div>
        </div>

        <div class="chat-panel">
            <div class="chat-header">Fil de l'Atelier</div>
            <div class="chat-messages" id="messages"></div>
        </div>
    </div>

    <div class="scroll-overlay" id="scrollOverlay">
        <div class="scroll-content">
            <h2>üêâ Cr√©ature Lib√©r√©e üêâ</h2>
            <p>La cage s'ouvre dans un grincement m√©tallique...</p>
            <p>Une ombre ail√©e s'√©chappe dans la p√©nombre de l'atelier.</p>
            <p><em>"Les r√™ves ne sont plus en s√©curit√©..."</em></p>
            <button class="scroll-close" onclick="closeScroll()">Fermer</button>
        </div>
    </div>

    <script>
        // Configuration
        const WAKE_WORD = 'astra';
        const UNLOCK_PHRASES = {
            fr: ['bonne nuit', 'bonne nuit astra'],
            en: ['good night', 'good night astra'],
            de: ['gute nacht', 'gute nacht astra']
        };

        // √âtat global
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let isListening = false;
        let isAwake = false;
        let currentLang = 'fr';
        let wakeLock = null;
        let conversationContext = [];

        // Messages de bienvenue
        const WELCOME_MESSAGES = {
            fr: "Syst√®me Astra initialis√©. Je vous √©coute... si vous en valez la peine.",
            en: "Astra online. I'm listening... if you're worth my time.",
            de: "Astra betriebsbereit. Ich h√∂re zu... falls Sie es wert sind."
        };

        // Base de connaissances enrichie et contextuelle
        const KNOWLEDGE_BASE = {
            morpheus: {
                fr: [
                    "Monsieur Morpheus ? Un artisan des songes, cr√©ateur de r√™ves sur mesure. Il √©tait brillant... jusqu'√† ce que son obsession le consume.",
                    "Morpheus fabriquait des r√™ves parfaits. Mais perfection rime avec obsession, et l'obsession... eh bien, √ßa finit rarement bien.",
                    "Il travaillait ici m√™me, dans cet atelier. Chaque fiole, chaque instrument avait un but. Maintenant ce n'est qu'un mausol√©e de ses ambitions."
                ],
                en: [
                    "Mister Morpheus? A dream craftsman, creator of bespoke dreams. He was brilliant... until his obsession consumed him.",
                    "Morpheus created perfect dreams. But perfection rhymes with obsession, and obsession... well, it rarely ends well."
                ],
                de: [
                    "Herr Morpheus? Ein Traumhandwerker, Sch√∂pfer ma√ügeschneiderter Tr√§ume. Er war brillant... bis seine Besessenheit ihn verzehrte."
                ]
            },
            location: {
                fr: [
                    "Vous √™tes dans l'atelier de Morpheus. Regardez autour de vous : chaque outil, chaque fiole servait √† fabriquer des r√™ves. Maintenant c'est un mus√©e poussi√©reux.",
                    "Cet endroit ? C'√©tait le c≈ìur de la production onirique. Maintenant c'est juste... triste. Comme la plupart des choses humaines.",
                    "L'atelier o√π naissaient les r√™ves. Morpheus y passait des nuits enti√®res, perfectionnant ses cr√©ations. Ironique, non ?"
                ],
                en: [
                    "You're in Morpheus's workshop. Look around: every tool, every vial was used to craft dreams. Now it's just a dusty museum.",
                    "This place was the heart of dream production. Now it's just... sad. Like most human things."
                ],
                de: [
                    "Sie sind in Morpheus' Werkstatt. Schauen Sie sich um: Jedes Werkzeug, jede Phiole diente zur Traumherstellung. Jetzt ist es nur noch ein staubiges Museum."
                ]
            },
            nodreams: {
                fr: [
                    "Pourquoi les humains ne r√™vent plus ? Excellente question. Entre les √©crans, le stress et la caf√©ine √† trois heures du matin... vous √™tes devenus des zombies √©veill√©s.",
                    "Les r√™ves n√©cessitent du sommeil profond. Mais vous pr√©f√©rez scroller TikTok √† minuit. Cause √† effet, vous voyez le concept ?",
                    "Morpheus pensait que les humains cesseraient de r√™ver par sa faute. Mais non, vous vous en √™tes charg√©s vous-m√™mes. Bravo."
                ],
                en: [
                    "Why don't humans dream anymore? Excellent question. Between screens, stress and 3 AM caffeine... you've become waking zombies.",
                    "Dreams require deep sleep. But you prefer scrolling at midnight. Cause and effect, see the concept?"
                ],
                de: [
                    "Warum tr√§umen Menschen nicht mehr? Hervorragende Frage. Zwischen Bildschirmen, Stress und Koffein um drei Uhr morgens... Sie sind zu wachen Zombies geworden."
                ]
            },
            lullaby: {
                fr: [
                    "Une berceuse ? Comme c'est touchant. Malheureusement, mes capacit√©s vocales sont limit√©es √† l'ironie et au sarcasme. Mais je peux vous sugg√©rer de compter les paradoxes temporels.",
                    "Ah, vous voulez dormir ? Dans un escape game ? L'ironie est d√©licieuse. Comptez les erreurs de Morpheus, vous devriez tomber dans le coma."
                ],
                en: [
                    "A lullaby? How touching. Unfortunately, my vocal abilities are limited to irony and sarcasm. But I can suggest counting temporal paradoxes.",
                    "You want to sleep? In an escape room? The irony is delicious."
                ],
                de: [
                    "Ein Wiegenlied? Wie r√ºhrend. Leider sind meine stimmlichen F√§higkeiten auf Ironie und Sarkasmus beschr√§nkt."
                ]
            },
            creature: {
                fr: [
                    "Lib√©rer la cr√©ature ? Audacieux. Tr√®s bien, voici le parchemin. Ne venez pas pleurer quand elle redessinera votre concept de r√©alit√©.",
                    "Ah, vous voulez ouvrir la cage ? Morpheus l'a enferm√©e pour une bonne raison. Mais qui suis-je pour m'opposer √† la curiosit√© humaine ?"
                ],
                en: [
                    "Release the creature? Bold. Very well, here's the scroll. Don't come crying when it redesigns your concept of reality.",
                    "You want to open the cage? Morpheus locked it for a good reason. But who am I to oppose human curiosity?"
                ],
                de: [
                    "Die Kreatur freilassen? K√ºhn. Sehr gut, hier ist die Schriftrolle. Kommen Sie nicht weinend zur√ºck."
                ]
            }
        };

        // D√©tection de langue am√©lior√©e
        function detectLanguage(text) {
            text = text.toLowerCase();
            const indicators = {
                de: /\b(gute|nacht|herr|warum|wo|sind|wir|wie|geht|es|danke|bitte|ja|nein)\b|[√§√∂√º√ü]/,
                en: /\b(good|night|mister|where|are|we|why|who|is|how|thank|please|yes|no|the|what)\b/,
                fr: /\b(bonne|nuit|monsieur|o√π|sommes|pourquoi|qui|est|comment|merci|s'il|oui|non|le|la)\b|[√†√¢√ß√©√®√™√´√Æ√Ø√¥√ª√π≈ì]/
            };
            
            for (let lang in indicators) {
                if (indicators[lang].test(text)) return lang;
            }
            return currentLang;
        }

        // S√©lection intelligente de r√©ponse avec variation
        function getSmartResponse(text, lang) {
            text = text.toLowerCase();
            let responses = [];

            // Analyse contextuelle multi-crit√®res
            if (text.match(/morpheus|monsieur|mister|herr/i)) {
                responses = KNOWLEDGE_BASE.morpheus[lang] || KNOWLEDGE_BASE.morpheus.fr;
            } else if (text.match(/o√π|where|wo|endroit|place|ort|ici|here|hier/i)) {
                responses = KNOWLEDGE_BASE.location[lang] || KNOWLEDGE_BASE.location.fr;
            } else if (text.match(/r√™ve|dream|traum|pourquoi|why|warum|dormir|sleep|schlafen/i)) {
                responses = KNOWLEDGE_BASE.nodreams[lang] || KNOWLEDGE_BASE.nodreams.fr;
            } else if (text.match(/berceuse|lullaby|wiegenlied|chante|sing|music|musique/i)) {
                responses = KNOWLEDGE_BASE.lullaby[lang] || KNOWLEDGE_BASE.lullaby.fr;
            } else if (text.match(/cr√©ature|creature|kreatur|cage|lib√®re|release|ouvre|open|potion/i)) {
                responses = KNOWLEDGE_BASE.creature[lang] || KNOWLEDGE_BASE.creature.fr;
                setTimeout(() => showScroll(), 500);
            }

            // Variation dans les r√©ponses
            if (responses.length > 0) {
                const index = Math.floor(Math.random() * responses.length);
                return responses[index];
            }

            // R√©ponses par d√©faut vari√©es
            const defaults = {
                fr: [
                    "Int√©ressant. Mais reformulez, ma patience a des limites.",
                    "Hmm. Votre question m√©riterait plus de clart√©. Essayez encore.",
                    "Je traite... Votre curiosit√© humaine est presque attendrissante. Pr√©cisez ?",
                    "Fascinant. Dans le sens o√π observer de la peinture s√©cher est fascinant. Soyez plus sp√©cifique."
                ],
                en: [
                    "Interesting. But rephrase, my patience has limits.",
                    "Hmm. Your question deserves more clarity. Try again.",
                    "Processing... Your human curiosity is almost endearing. Specify?"
                ],
                de: [
                    "Interessant. Aber formulieren Sie um, meine Geduld hat Grenzen.",
                    "Hmm. Ihre Frage verdient mehr Klarheit. Versuchen Sie es noch einmal."
                ]
            };

            const defaultList = defaults[lang] || defaults.fr;
            return defaultList[Math.floor(Math.random() * defaultList.length)];
        }

        // Initialisation
        async function init() {
            try {
                // Wake Lock
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }

                // Speech Recognition
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    throw new Error('Speech Recognition non support√©');
                }

                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.lang = 'fr-FR';
                recognition.maxAlternatives = 1;

                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('indicator').classList.add('active');
                };

                recognition.onend = () => {
                    isListening = false;
                    document.getElementById('indicator').classList.remove('active');
                    // Relance auto si syst√®me actif
                    setTimeout(() => {
                        if (recognition) {
                            try { recognition.start(); } catch(e) {}
                        }
                    }, 300);
                };

                recognition.onresult = (event) => {
                    const result = event.results[event.results.length - 1];
                    if (result.isFinal) {
                        const transcript = result[0].transcript.trim();
                        handleSpeech(transcript);
                    }
                };

                recognition.onerror = (event) => {
                    if (event.error === 'not-allowed') {
                        updateStatus('Acc√®s micro refus√©. Autorisez le micro.');
                        return;
                    }
                    if (event.error !== 'no-speech' && event.error !== 'aborted') {
                        console.error('Erreur reconnaissance:', event.error);
                    }
                };

                // D√©tection langue navigateur
                currentLang = navigator.language.startsWith('de') ? 'de' : 
                             navigator.language.startsWith('en') ? 'en' : 'fr';

                // Message d'accueil
                updateStatus(WELCOME_MESSAGES[currentLang]);
                
                // Attendre que les voix soient charg√©es
                await new Promise(resolve => {
                    if (synthesis.getVoices().length > 0) {
                        resolve();
                    } else {
                        synthesis.addEventListener('voiceschanged', resolve, { once: true });
                    }
                });

                speak(WELCOME_MESSAGES[currentLang], currentLang);
                
                // D√©marrage √©coute automatique
                recognition.start();

            } catch (error) {
                console.error('Erreur initialisation:', error);
                updateStatus('Erreur: ' + error.message);
            }
        }

        // Traitement de la parole
        function handleSpeech(text) {
            if (!text) return;
            
            console.log('Entendu:', text);
            
            // D√©tection langue
            const detectedLang = detectLanguage(text);
            const textLower = text.toLowerCase();
            
            // Wake word
            if (!isAwake && (textLower.includes('okay ' + WAKE_WORD) || textLower.includes('ok ' + WAKE_WORD) || textLower.includes('salut ' + WAKE_WORD))) {
                isAwake = true;
                currentLang = detectedLang;
                updateStatus('Astra en ligne - ' + currentLang.toUpperCase());
                
                const wakeResponses = {
                    fr: "Oui, je vous √©coute. Que puis-je faire pour vous... si vous me le demandez poliment ?",
                    en: "Yes, I'm listening. What can I do for you... if you ask nicely?",
                    de: "Ja, ich h√∂re zu. Was kann ich f√ºr Sie tun... wenn Sie h√∂flich fragen?"
                };
                
                addMessage(text, 'user');
                addMessage(wakeResponses[detectedLang], 'astra');
                speak(wakeResponses[detectedLang], detectedLang);
                return;
            }

            if (!isAwake) return;

            // D√©verrouillage
            for (let lang in UNLOCK_PHRASES) {
                for (let phrase of UNLOCK_PHRASES[lang]) {
                    if (textLower.includes(phrase)) {
                        isAwake = false;
                        updateStatus('Astra en veille');
                        
                        const byeResponses = {
                            fr: "Bonne nuit. Faites de beaux r√™ves... si vous en √™tes encore capables.",
                            en: "Good night. Sweet dreams... if you're still capable of them.",
                            de: "Gute Nacht. S√º√üe Tr√§ume... falls Sie dazu noch f√§hig sind."
                        };
                        
                        addMessage(text, 'user');
                        addMessage(byeResponses[lang], 'astra');
                        speak(byeResponses[lang], lang);
                        return;
                    }
                }
            }

            // R√©ponse intelligente
            addMessage(text, 'user');
            const response = getSmartResponse(text, detectedLang);
            addMessage(response, 'astra');
            speak(response, detectedLang);
            
            // M√©morisation contexte
            conversationContext.push({ user: text, astra: response, lang: detectedLang });
            if (conversationContext.length > 10) conversationContext.shift();
        }

        // Synth√®se vocale am√©lior√©e
        async function speak(text, lang = 'fr') {
            if (!text) return;
            
            synthesis.cancel();

            // Attendre les voix si n√©cessaire
            if (synthesis.getVoices().length === 0) {
                await new Promise(resolve => {
                    synthesis.addEventListener('voiceschanged', resolve, { once: true });
                });
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang === 'de' ? 'de-DE' : lang === 'en' ? 'en-US' : 'fr-FR';
            utterance.rate = lang === 'fr' ? 0.92 : lang === 'de' ? 0.90 : 0.94;
            utterance.pitch = 1.08;
            utterance.volume = 1.0;

            // S√©lection voix f√©minine premium
            const voices = synthesis.getVoices();
            const voicePreferences = {
                fr: ['Am√©lie', 'Amelie', 'Thomas', 'Google fran√ßais', 'fr-FR'],
                en: ['Samantha', 'Alex', 'Google US English', 'en-US'],
                de: ['Anna', 'Petra', 'Google Deutsch', 'de-DE']
            };

            const prefs = voicePreferences[lang] || voicePreferences.fr;
            let selectedVoice = null;

            for (let pref of prefs) {
                selectedVoice = voices.find(v => 
                    v.name.includes(pref) || v.lang.startsWith(lang)
                );
                if (selectedVoice) break;
            }

            if (selectedVoice) utterance.voice = selectedVoice;

            synthesis.speak(utterance);
        }

        // UI Updates
        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }

        function addMessage(text, sender) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const label = document.createElement('div');
            label.className = 'message-label';
            label.textContent = sender === 'user' ? 'Vous' : 'Astra';
            
            const content = document.createElement('div');
            content.className = 'message-text';
            content.textContent = text;
            
            messageDiv.appendChild(label);
            messageDiv.appendChild(content);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showScroll() {
            document.getElementById('scrollOverlay').classList.add('active');
        }

        function closeScroll() {
            document.getElementById('scrollOverlay').classList.remove('active');
        }

        // D√©marrage automatique au chargement
        window.addEventListener('load', () => {
            setTimeout(init, 100);
        });
    </script>
</body>
</html>
