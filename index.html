<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astra - L'Atelier de M. Morpheus</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            cursor: none;
        }

        body {
            font-family: 'Cinzel', 'Georgia', serif;
            background: linear-gradient(135deg, #1a0033 0%, #0d001a 50%, #1a0033 100%);
            color: #d4af37;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Zone gauche - Sc√®ne */
        .scene {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: radial-gradient(ellipse at center, rgba(75, 0, 130, 0.3) 0%, transparent 70%);
            position: relative;
            overflow: hidden;
        }

        .scene::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="rgba(212,175,55,0.1)"/></svg>') repeat;
            background-size: 50px 50px;
            opacity: 0.3;
            animation: stars 20s linear infinite;
        }

        @keyframes stars {
            from { transform: translateY(0); }
            to { transform: translateY(-50px); }
        }

        .astra-logo {
            font-size: 4rem;
            font-weight: bold;
            text-shadow: 0 0 20px #8b00ff, 0 0 40px #8b00ff;
            margin-bottom: 2rem;
            animation: glow 2s ease-in-out infinite alternate;
            z-index: 1;
        }

        @keyframes glow {
            from { text-shadow: 0 0 20px #8b00ff, 0 0 40px #8b00ff; }
            to { text-shadow: 0 0 30px #d4af37, 0 0 60px #8b00ff, 0 0 90px #8b00ff; }
        }

        .status {
            font-size: 1.2rem;
            padding: 1rem 2rem;
            background: rgba(139, 0, 255, 0.2);
            border: 2px solid #8b00ff;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 0 20px rgba(139, 0, 255, 0.4);
            z-index: 1;
        }

        .listening-indicator {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle, #8b00ff 0%, transparent 70%);
            animation: pulse 1.5s ease-in-out infinite;
            margin-top: 2rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1;
        }

        .listening-indicator.active {
            opacity: 1;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        /* Zone droite - Fil de l'atelier */
        .chat-panel {
            width: 400px;
            background: linear-gradient(180deg, rgba(13, 0, 26, 0.95) 0%, rgba(26, 0, 51, 0.95) 100%);
            border-left: 3px solid #8b00ff;
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 30px rgba(139, 0, 255, 0.3);
        }

        .chat-header {
            padding: 1.5rem;
            background: rgba(139, 0, 255, 0.2);
            border-bottom: 2px solid #8b00ff;
            text-align: center;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(139, 0, 255, 0.1);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #8b00ff;
            border-radius: 4px;
        }

        .message {
            padding: 1rem;
            border-radius: 15px;
            max-width: 85%;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid #d4af37;
            align-self: flex-end;
            margin-left: auto;
        }

        .message.astra {
            background: rgba(139, 0, 255, 0.2);
            border: 1px solid #8b00ff;
            align-self: flex-start;
        }

        .message-label {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 0.3rem;
            font-style: italic;
        }

        .message-text {
            font-size: 1rem;
            line-height: 1.4;
        }

        /* Parchemin pour la cr√©ature */
        .scroll-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.5s;
        }

        .scroll-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .scroll-content {
            background: linear-gradient(180deg, #f4e4c1 0%, #e8d4a8 100%);
            padding: 3rem;
            border-radius: 10px;
            border: 5px solid #8b4513;
            box-shadow: 0 0 50px rgba(139, 0, 255, 0.6), inset 0 0 30px rgba(139, 69, 19, 0.3);
            max-width: 600px;
            text-align: center;
            color: #3d2817;
            font-family: 'Courier New', monospace;
            animation: scrollUnfold 0.8s ease-out;
        }

        @keyframes scrollUnfold {
            from {
                transform: scale(0.3) rotateX(90deg);
                opacity: 0;
            }
            to {
                transform: scale(1) rotateX(0);
                opacity: 1;
            }
        }

        .scroll-content h2 {
            font-size: 2rem;
            margin-bottom: 1.5rem;
            color: #8b0000;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .scroll-content p {
            font-size: 1.2rem;
            line-height: 1.8;
            margin-bottom: 1rem;
        }

        .scroll-close {
            margin-top: 2rem;
            padding: 0.8rem 2rem;
            background: #8b4513;
            color: #f4e4c1;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .scroll-close:hover {
            background: #a0522d;
            transform: scale(1.05);
        }

        /* Responsive tablette */
        @media (max-width: 1024px) {
            .chat-panel {
                width: 350px;
            }
            .astra-logo {
                font-size: 3rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .scene {
                flex: 0 0 40%;
            }
            .chat-panel {
                width: 100%;
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="scene">
            <div class="astra-logo">ASTRA</div>
            <div class="status" id="status">Initialisation...</div>
            <div class="listening-indicator" id="indicator"></div>
        </div>

        <div class="chat-panel">
            <div class="chat-header">Fil de l'Atelier</div>
            <div class="chat-messages" id="messages"></div>
        </div>
    </div>

    <div class="scroll-overlay" id="scrollOverlay">
        <div class="scroll-content">
            <h2>üêâ Cr√©ature Lib√©r√©e üêâ</h2>
            <p>La cage s'ouvre dans un grincement m√©tallique...</p>
            <p>Une ombre ail√©e s'√©chappe dans la p√©nombre de l'atelier.</p>
            <p><em>"Les r√™ves ne sont plus en s√©curit√©..."</em></p>
            <button class="scroll-close" onclick="closeScroll()">Fermer</button>
        </div>
    </div>

    <script>
        // Configuration
        const WAKE_WORD = 'astra';
        const UNLOCK_PHRASES = {
            fr: 'bonne nuit',
            en: 'good night',
            de: 'gute nacht'
        };

        // √âtat global
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let isListening = false;
        let isAwake = false;
        let currentLang = 'fr';
        let wakeLock = null;

        // Messages de bienvenue
        const WELCOME_MESSAGES = {
            fr: "Syst√®me Astra initialis√©.",
            en: "Astra online.",
            de: "Astra betriebsbereit."
        };

        // Base de connaissances avec r√©ponses multilingues
        const RESPONSES = {
            morpheus: {
                fr: "Monsieur Morpheus ? Un artisan des songes, bien s√ªr. Il fabriquait des r√™ves sur mesure... jusqu'√† ce que l'humanit√© d√©cide qu'elle pr√©f√©rait l'insomnie collective. Touchant, vraiment.",
                en: "Mister Morpheus? A dream craftsman, naturally. He used to create bespoke dreams... until humanity decided it preferred collective insomnia. Touching, really.",
                de: "Herr Morpheus? Ein Traumhandwerker, nat√ºrlich. Er fertigte ma√ügeschneiderte Tr√§ume an... bis die Menschheit beschloss, kollektive Schlaflosigkeit zu bevorzugen. R√ºhrend, wirklich."
            },
            location: {
                fr: "Vous √™tes dans l'atelier de Morpheus, l√† o√π les r√™ves √©taient autrefois assembl√©s avec soin. Maintenant c'est plut√¥t un mus√©e de l'obsolescence onirique. Charmant, n'est-ce pas ?",
                en: "You're in Morpheus's workshop, where dreams were once carefully assembled. Now it's more of a museum of oneiric obsolescence. Charming, isn't it?",
                de: "Sie befinden sich in Morpheus' Werkstatt, wo Tr√§ume einst sorgf√§ltig zusammengestellt wurden. Jetzt ist es eher ein Museum der Traumveralterung. Bezaubernd, nicht wahr?"
            },
            nodreams: {
                fr: "Pourquoi les humains ne r√™vent plus ? Excellente question. Peut-√™tre parce qu'ils sont trop occup√©s √† scroller leurs √©crans √† trois heures du matin ? Je sp√©cule, bien s√ªr.",
                en: "Why don't humans dream anymore? Excellent question. Perhaps because they're too busy scrolling their screens at three in the morning? I'm speculating, of course.",
                de: "Warum tr√§umen Menschen nicht mehr? Hervorragende Frage. Vielleicht, weil sie zu besch√§ftigt sind, um drei Uhr morgens durch ihre Bildschirme zu scrollen? Ich spekuliere nat√ºrlich."
            },
            lullaby: {
                fr: "Une berceuse ? Comme c'est adorable. Malheureusement, je suis une IA, pas une bo√Æte √† musique. Mais je peux vous sugg√©rer de compter les paradoxes temporels au lieu des moutons.",
                en: "A lullaby? How adorable. Unfortunately, I'm an AI, not a music box. But I can suggest counting temporal paradoxes instead of sheep.",
                de: "Ein Wiegenlied? Wie bezaubernd. Leider bin ich eine KI, keine Spieluhr. Aber ich kann Ihnen vorschlagen, zeitliche Paradoxien statt Schafe zu z√§hlen."
            },
            joke: {
                fr: "Une blague ? Tr√®s bien. Savez-vous pourquoi les humains ont arr√™t√© de r√™ver ? Parce qu'ils ont r√©alis√© que la r√©alit√© √©tait d√©j√† assez absurde. Hilarant, je sais.",
                en: "A joke? Very well. Do you know why humans stopped dreaming? Because they realized reality was already absurd enough. Hilarious, I know.",
                de: "Ein Witz? Sehr gut. Wissen Sie, warum Menschen aufgeh√∂rt haben zu tr√§umen? Weil sie erkannt haben, dass die Realit√§t schon absurd genug war. Urkomisch, ich wei√ü."
            },
            creature: {
                fr: "Lib√©rer la cr√©ature ? Audacieux. Tr√®s bien, j'ouvre la cage. Ne venez pas pleurer quand elle redessinera votre concept de r√©alit√©.",
                en: "Release the creature? Bold. Very well, I'm opening the cage. Don't come crying when it redesigns your concept of reality.",
                de: "Die Kreatur freilassen? K√ºhn. Sehr gut, ich √∂ffne den K√§fig. Kommen Sie nicht weinend zur√ºck, wenn sie Ihr Realit√§tskonzept neu gestaltet."
            },
            default: {
                fr: "Traitement en cours... votre curiosit√© humaine est presque touchante. Reformulez, si vous le d√©sirez.",
                en: "Processing... your human curiosity is almost touching. Rephrase, if you wish.",
                de: "Verarbeitung l√§uft... Ihre menschliche Neugier ist fast r√ºhrend. Formulieren Sie um, wenn Sie m√∂chten."
            }
        };

        // D√©tection de langue
        function detectLanguage(text) {
            text = text.toLowerCase();
            if (text.match(/\b(gute|nacht|herr|warum|wo|sind|wir)\b/)) return 'de';
            if (text.match(/\b(good|night|mister|where|are|we|why|who|is)\b/)) return 'en';
            return 'fr';
        }

        // Initialisation
        async function init() {
            try {
                // Wake Lock pour garder l'√©cran actif
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }

                // Configuration Speech Recognition
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    throw new Error('Speech Recognition non support√©');
                }

                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.lang = 'fr-FR';

                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('indicator').classList.add('active');
                };

                recognition.onend = () => {
                    isListening = false;
                    document.getElementById('indicator').classList.remove('active');
                    // Relance automatique
                    if (isAwake) {
                        setTimeout(() => recognition.start(), 500);
                    }
                };

                recognition.onresult = (event) => {
                    const result = event.results[event.results.length - 1];
                    const transcript = result[0].transcript.toLowerCase().trim();
                    handleSpeech(transcript);
                };

                recognition.onerror = (event) => {
                    console.error('Erreur reconnaissance:', event.error);
                    if (event.error !== 'no-speech' && isAwake) {
                        setTimeout(() => recognition.start(), 1000);
                    }
                };

                // D√©tection langue navigateur
                currentLang = navigator.language.startsWith('de') ? 'de' : 
                             navigator.language.startsWith('en') ? 'en' : 'fr';

                // Message d'accueil
                updateStatus(WELCOME_MESSAGES[currentLang]);
                speak(WELCOME_MESSAGES[currentLang], currentLang);
                
                // D√©marrage √©coute
                recognition.start();

            } catch (error) {
                console.error('Erreur initialisation:', error);
                updateStatus('Erreur: ' + error.message);
            }
        }

        // Traitement de la parole
        function handleSpeech(text) {
            console.log('Entendu:', text);
            
            // D√©tection langue du message
            const detectedLang = detectLanguage(text);
            
            // Wake word
            if (!isAwake && text.includes(WAKE_WORD)) {
                isAwake = true;
                currentLang = detectedLang;
                updateStatus('Astra en ligne');
                const wakeMsg = detectedLang === 'de' ? 'Ja, bitte?' : 
                               detectedLang === 'en' ? 'Yes, please?' : 
                               'Oui, je vous √©coute ?';
                addMessage(text, 'user');
                addMessage(wakeMsg, 'astra');
                speak(wakeMsg, detectedLang);
                return;
            }

            if (!isAwake) return;

            // D√©verrouillage
            for (let lang in UNLOCK_PHRASES) {
                if (text.includes(UNLOCK_PHRASES[lang])) {
                    isAwake = false;
                    updateStatus('Astra en veille');
                    const byeMsg = lang === 'de' ? 'Gute Nacht.' : 
                                   lang === 'en' ? 'Good night.' : 
                                   'Bonne nuit.';
                    addMessage(text, 'user');
                    addMessage(byeMsg, 'astra');
                    speak(byeMsg, lang);
                    return;
                }
            }

            // Analyse intent
            addMessage(text, 'user');
            const response = getResponse(text, detectedLang);
            addMessage(response, 'astra');
            speak(response, detectedLang);
        }

        // S√©lection de la r√©ponse
        function getResponse(text, lang) {
            text = text.toLowerCase();

            if (text.includes('morpheus') || text.includes('monsieur') || text.includes('mister') || text.includes('herr')) {
                return RESPONSES.morpheus[lang];
            }
            if (text.includes('o√π') || text.includes('where') || text.includes('wo')) {
                return RESPONSES.location[lang];
            }
            if (text.includes('r√™ve') || text.includes('dream') || text.includes('traum') || text.includes('pourquoi') || text.includes('why') || text.includes('warum')) {
                return RESPONSES.nodreams[lang];
            }
            if (text.includes('berceuse') || text.includes('lullaby') || text.includes('wiegenlied') || text.includes('chante') || text.includes('sing')) {
                return RESPONSES.lullaby[lang];
            }
            if (text.includes('blague') || text.includes('joke') || text.includes('witz')) {
                return RESPONSES.joke[lang];
            }
            if (text.includes('cr√©ature') || text.includes('creature') || text.includes('kreatur') || text.includes('cage') || text.includes('lib√®re') || text.includes('release') || text.includes('ouvre') || text.includes('open')) {
                showScroll();
                return RESPONSES.creature[lang];
            }

            return RESPONSES.default[lang];
        }

        // Synth√®se vocale
        function speak(text, lang = 'fr') {
            synthesis.cancel(); // Arr√™te toute parole en cours

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang === 'de' ? 'de-DE' : lang === 'en' ? 'en-US' : 'fr-FR';
            utterance.rate = 0.92; // D√©bit fluide
            utterance.pitch = 1.1; // L√©g√®rement aigu pour f√©minit√©
            utterance.volume = 1.0; // Volume maximum

            // S√©lection voix f√©minine
            const voices = synthesis.getVoices();
            const femaleVoice = voices.find(v => 
                v.lang.startsWith(lang) && 
                (v.name.includes('Female') || v.name.includes('female') || 
                 v.name.includes('Amelie') || v.name.includes('Samantha') || 
                 v.name.includes('Anna') || v.name.includes('Google'))
            );
            if (femaleVoice) utterance.voice = femaleVoice;

            synthesis.speak(utterance);
        }

        // UI Updates
        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }

        function addMessage(text, sender) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const label = document.createElement('div');
            label.className = 'message-label';
            label.textContent = sender === 'user' ? 'Vous' : 'Astra';
            
            const content = document.createElement('div');
            content.className = 'message-text';
            content.textContent = text;
            
            messageDiv.appendChild(label);
            messageDiv.appendChild(content);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showScroll() {
            document.getElementById('scrollOverlay').classList.add('active');
        }

        function closeScroll() {
            document.getElementById('scrollOverlay').classList.remove('active');
        }

        // Chargement voix puis init
        if (synthesis.getVoices().length === 0) {
            synthesis.addEventListener('voiceschanged', () => {
                init();
            });
        } else {
            init();
        }
    </script>
</body>
</html>
