
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Astra ‚Äî Assistant de M. Morpheus</title>
  <meta name="theme-color" content="#0b0a12"/>
  <style>
    :root{ --bg:#0b0a12; --ink:#f6e9d0; --ink-dim:#d6cbb5; --accent:#c89b3c; --danger:#db3a34; --muted:#857a62; }
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 700px at 20% 0%, #131022 0%, var(--bg) 55%, #06050a 100%);
      color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
      user-select:none; cursor:none; /* aucun clic n√©cessaire pour les joueurs */
    }
    .frame{position:relative; width:min(100vw,1024px); height:min(100vh,680px);
      box-shadow:0 0 60px rgba(0,0,0,.6) inset, 0 20px 80px rgba(0,0,0,.65);
      background:linear-gradient(180deg,#141221 0%,#0e0c19 100%);
      border:16px solid transparent; border-image: url('assets/border-baroque.png') 60 fill round;}
    .hdr{position:absolute; top:12px; left:16px; right:16px; display:flex; gap:12px; align-items:center;}
    .logo{letter-spacing:.08em; font-size:clamp(16px,2.2vw,22px)}
    .chip{margin-left:auto; font-size:12px; color:var(--ink-dim)}

    .stage{position:absolute; inset:64px 24px 72px 24px; display:grid; grid-template-columns:1fr 380px; gap:24px}
    .scene{position:relative; background: radial-gradient(70% 100% at 50% 20%, #1f1a35 0%, #141221 60%, #0e0c19 100%); border-radius:18px; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), 0 10px 30px rgba(0,0,0,.55); overflow:hidden}
    .noise{position:absolute; inset:0; opacity:.08; background:url('assets/noise.png'); mix-blend-mode:overlay}

    .scroll{background: linear-gradient(180deg,#2a253f 0%,#1e1a30 100%); border-radius:16px; padding:16px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.07)}
    .scroll h2{margin:4px 0 12px; font-size:14px; letter-spacing:.12em; color:var(--ink-dim); text-transform:uppercase}
    .out{height: calc(100% - 48px); overflow:auto; padding-right:6px}
    .line{display:flex; align-items:flex-start; gap:10px; margin:10px 0}
    .bubble{max-width:85%; padding:10px 12px; border-radius:12px; box-shadow:0 2px 0 rgba(0,0,0,.25)}
    .bubble.astra{background:#1d182b; border:1px solid rgba(255,255,255,.06)}
    .bubble.user{background:#0d1b2a; border:1px solid rgba(255,255,255,.05)}
    .tag{font-size:11px; color:var(--muted)}
    .imgcard{margin-top:8px; border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,.08)}
    .imgcard img{display:block; width:100%; height:auto}

    .ftr{position:absolute; left:24px; right:24px; bottom:20px; display:flex; align-items:center; gap:12px}
    .led{width:10px; height:10px; border-radius:50%; background:#372e4f; box-shadow:0 0 10px #000 inset}
    .led.on{background:#27ae60; box-shadow:0 0 10px #27ae60, 0 0 30px rgba(39,174,96,.35)}
    .status{font-size:12px; color:var(--ink-dim)}

    .locked{position:absolute; inset:auto 24px 24px auto; background:#211b35; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:6px 10px; font-size:12px; color:var(--ink-dim)}
  </style>
</head>
<body>
  <div class="frame" id="app" aria-live="polite">
    <div class="hdr">
      <div class="logo">ASTRA ‚Äî Atelier de M. Morpheus</div>
      <div class="chip" id="chip">FR ‚Ä¢ Verrouill√©</div>
    </div>

    <div class="stage">
      <div class="scene">
        <div class="noise"></div>
        <div id="lockedBadge" class="locked">üîí Mot de passe (dites-le √† voix haute) : ¬´ bonne nuit ¬ª ‚Ä¢ ‚Äúgood night‚Äù ‚Ä¢ ‚ÄúGute Nacht‚Äù</div>
      </div>

      <aside class="scroll">
        <h2>Fil de l'atelier</h2>
        <div id="out" class="out"></div>
      </aside>
    </div>

    <div class="ftr">
      <div id="led" class="led"></div>
      <div id="status" class="status">Initialisation‚Ä¶</div>
    </div>
  </div>

  <audio id="fx-chime" src="assets/chime.mp3" preload="auto"></audio>
  <audio id="bg-lullaby" src="assets/lullaby.mp3" preload="auto" loop></audio>

  <script>
  // ---------- State ----------
  const out = document.getElementById('out');
  const statusEl = document.getElementById('status');
  const chip = document.getElementById('chip');
  const led = document.getElementById('led');
  const lockedBadge = document.getElementById('lockedBadge');
  const fxChime = document.getElementById('fx-chime');
  const lullaby = document.getElementById('bg-lullaby');

  let isRunning = false;
  let isMuted = false; // pas de bouton, toujours non muet
  let isLocked = true;
  let wakeArmed = true; // attend "okay astra"
  let currentLangPref = 'auto';
  let wakeLock = null;

  const IMAGES = {
    liberation: 'assets/parchemin_liberation.jpg',
    sweet: 'assets/parchemin_sweet_dream.jpg',
    love: 'assets/parchemin_reve_d_amour.jpg',
    jail: 'assets/parchemin_philtre_enfermement.jpg'
  };

  const QUIPS = {
    fr: [
      "Oh, des humains sans r√™ves‚Ä¶ quelle surprise. Essayons quand m√™me.",
      "Je ne juge pas, j'observe. Et c'est‚Ä¶ fascinant.",
      "Si vous vous perdez, c'est s√ªrement voulu par le syst√®me. Probablement.",
    ],
    en: [
      "Humans without dreams. Classic. Let's improvise.",
      "Not judging, just‚Ä¶ observing. Intriguing.",
      "If you're lost, the system calls it ‚Äòimmersion‚Äô. Probably.",
    ],
    de: [
      "Menschen ohne Tr√§ume. Wie originell. Improvisieren wir.",
      "Ich urteile nicht, ich beobachte. Faszinierend.",
      "Wenn ihr euch verirrt, nennt das System es ‚ÄòImmersion‚Äô. Wahrscheinlich.",
    ]
  };

  const LULLABY_TITLES = { fr: "Berceuse syst√®me #12", en: "System Lullaby #12", de: "System-Wiegenlied #12" };

  const INTENTS = {
    wake: /\b(ok(?:ay)?\s*astra)\b|\b(d[‚Äô']accord\s*astra)\b|\b(salut\s*astra)\b|\b(hallo\s*astra)\b/i,
    unlock: /\b(bonne\s*nuit|good\s*night|gute\s*nacht)\b/i,
    liberate: /(potion\s+de\s+lib(√©|e)ration|lib(√©|e)rer\s+(la\s*)?(cr(√©|e)ature|bestiolle?|monstre)|ouvrir\s+la\s+cage|help\s+the\s+(creature|monster)|open\s+the\s+cage|how\s+to\s+free|wie\s+(man\s+)?befreit|k(√§|a)fig\s+(√∂ffnen|aufmachen))/i,
    lullaby: /(berceuse|chanson|lullaby|song|wiegenlied)/i,
    joke: /(blague|joke|witz)/i,
    langFR: /\b(fr(a|√¢)ncais|parle\s*fran(c|√ß)ais)\b/i,
    langEN: /\b(english|speak\s*english)\b/i,
    langDE: /\b(deutsch|auf\s*deutsch)\b/i
  };

  function now(){ return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
  function addLine(kind, html){
    const line = document.createElement('div'); line.className='line';
    const tag = `<div class="tag">${now()} ¬∑ ${kind==='astra' ? 'Astra' : 'Vous'}</div>`;
    const bubble = `<div class="bubble ${kind}">${html}</div>`;
    line.innerHTML = (kind==='astra'? bubble+tag : tag+bubble);
    out.appendChild(line); out.scrollTop = out.scrollHeight;
  }
  function addImage(src, alt){
    const wrap = document.createElement('div'); wrap.className='imgcard';
    wrap.innerHTML = `<img src="${src}" alt="${alt}">`;
    out.appendChild(wrap); out.scrollTop = out.scrollHeight;
  }

// ---------- Speech Synthesis ----------
function pickVoice(lang){
  // Priorit√©s de voix naturelles (quand dispo)
  const prefNames = {
    fr: ['Google fran√ßais','Am√©lie','Thomas','Aurelie','Audrey','Marie','Sophie'],
    en: ['Google US English','Samantha','Karen','Daniel','Victoria','Alex'],
    de: ['Google Deutsch','Anna','Petra','Markus']
  };
  const want = (lang==='fr') ? /^fr/i : (lang==='de') ? /^de/i : /^en/i;
  // Provoque le chargement des voix sur certains navigateurs
  const _ = speechSynthesis.getVoices();
  const voices = speechSynthesis.getVoices();
  const cand = voices.filter(v => want.test(v.lang));
  const byName = cand.find(v => (prefNames[lang]||[]).includes(v.name));
  return byName || cand[0] || voices[0];
}

function guessLang(text){
  text = (text||'').toLowerCase();
  if(/[√†√¢√ß√©√®√™√´√Æ√Ø√¥√ª√π≈ì]/.test(text) || /(bonjour|potion|lib√©ration|cage)/.test(text)) return 'fr';
  if(/\b(the|how|open|monster|good\s*night|okay)\b/.test(text)) return 'en';
  if(/\b(und|wie|√∂ffnen|gute\s*nacht|k√§fig|hallo)\b|[√§√∂√º√ü]/.test(text)) return 'de';
  return 'fr';
}

function speak(text, lang){
  if(isMuted || !text) return;

  const code  = (lang==='fr') ? 'fr-FR' : (lang==='de') ? 'de-DE' : 'en-US';
  const voice = pickVoice(lang);
  const rate  = (lang==='fr') ? 0.92 : (lang==='de') ? 0.96 : 0.98; // un peu plus lent = plus naturel
  const pitch = 1.0;

  // D√©coupe en phrases pour √©viter les saccades longues
  const parts = (text.match(/[^.!?‚Ä¶]+[.!?‚Ä¶]?/g) || [text])
               .map(s => s.trim()).filter(Boolean);

  for(const chunk of parts){
    const u = new SpeechSynthesisUtterance(chunk);
    u.lang = code; u.voice = voice; u.rate = rate; u.pitch = pitch; u.volume = 1;
    speechSynthesis.speak(u); // la file d‚Äôattente g√®re la succession des phrases
  }
}

  // ---------- Recognition ----------
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null; let recLang = 'fr-FR';

  function switchRecLangIfNeeded(sample){
    if(currentLangPref!=='auto' || !sample) return;
    const g = guessLang(sample);
    const want = g==='fr'?'fr-FR': g==='de'?'de-DE':'en-US';
    if(rec && want !== recLang){
      recLang = want; try{rec.stop()}catch(e){}; setTimeout(startRec, 150);
      addLine('astra', `[Syst√®me] Langue d√©tect√©e¬†: ${g.toUpperCase()}`);
    }
  }

  function startRec(){
    if(!SR){ statusEl.textContent = "Micro non support√© par ce navigateur."; addLine('astra','<i>Votre navigateur ne supporte pas la reconnaissance vocale Web.</i>'); return; }
    if(rec) { try{rec.stop()}catch(e){} }
    rec = new SR(); rec.continuous = true; rec.interimResults = true; rec.lang = recLang;
    rec.onstart = ()=>{ led.classList.add('on'); addLine('astra','[Mic] √âcoute activ√©e. Dites ¬´ okay Astra ¬ª.'); };
    rec.onend = ()=>{ led.classList.remove('on'); if(isRunning) setTimeout(startRec, 600); };
    rec.onerror = (e)=>{
      let msg = '';
      if(e.error==='not-allowed' || e.error==='permission-denied'){
        msg = 'üé§ Micro non autoris√© ‚Äî autorisez-le pour github.io (Safari¬†: R√©glages > Sites web > Microphone. Chrome¬†: Ic√¥ne √† gauche de l‚ÄôURL > Param√®tres du site).';
      } else if(e.error==='no-speech'){
        msg = 'Je n\'ai rien entendu. Parlez plus pr√®s du micro.';
      } else { msg = 'Erreur micro: '+e.error; }
      statusEl.textContent = msg; addLine('astra', msg);
    };
    rec.onresult = (evt)=>{
      let finalText = '';
      for(let i=evt.resultIndex; i<evt.results.length; i++){
        const res = evt.results[i];
        const txt = res[0].transcript;
        if(!res.isFinal){ switchRecLangIfNeeded(txt); }
        if(res.isFinal){ finalText += txt + ' '; }
      }
      if(finalText){ handleText(finalText.trim()); }
    };
    try{ rec.start(); }catch(e){}
  }

  function setRecLangByPref(){ recLang = (currentLangPref==='auto') ? 'fr-FR' : currentLangPref; }

  // ---------- Intent handling ----------
  function handleText(text){
    const raw = text;
    const lang = currentLangPref==='auto'? guessLang(text) : currentLangPref.slice(0,2);
    addLine('user', raw);

    if(INTENTS.langFR.test(text)){ currentLangPref='fr-FR'; chip.textContent='FR ‚Ä¢ '+(isLocked?'Verrouill√©':'Ouvert'); sayQuip('fr'); return; }
    if(INTENTS.langEN.test(text)){ currentLangPref='en-US'; chip.textContent='EN ‚Ä¢ '+(isLocked?'Locked':'Open'); sayQuip('en'); return; }
    if(INTENTS.langDE.test(text)){ currentLangPref='de-DE'; chip.textContent='DE ‚Ä¢ '+(isLocked?'Gesperrt':'Offen'); sayQuip('de'); return; }

    if(wakeArmed && INTENTS.wake.test(text)){
      wakeArmed = false; fxChime.currentTime=0; fxChime.play().catch(()=>{});
      const t = lang==='de'? 'Ja? Ich h√∂re zu.' : lang==='en'? 'Yes? I am listening.' : 'Oui ? Je vous √©coute.';
      speak(t, lang); addLine('astra', t); return;
    }

    if(isLocked && INTENTS.unlock.test(text)){
      isLocked = false; lockedBadge.style.display='none'; chip.textContent = (lang==='de'?'DE':lang==='en'?'EN':'FR')+' ‚Ä¢ '+(lang==='de'?'Offen':lang==='en'?'Open':'Ouvert');
      const t = lang==='de'? 'Zugang gew√§hrt. Nett gesagt.' : lang==='en'? 'Access granted. Polite passwords still work.' : 'Acc√®s accord√©. Les mots doux, √ßa marche toujours.';
      speak(t, lang); addLine('astra', t); return;
    }

    if(isLocked){
      const t = lang==='de'? 'Nettes Gefl√ºster, aber zuerst das Passwort.' : lang==='en'? 'Charming whisper, but password first.' : 'Joli chuchotement, mais le mot de passe d‚Äôabord.';
      speak(t, lang); addLine('astra', t); return;
    }

    // Qui est Monsieur Morpheus ?
if (/(qui\s+est\s+(monsieur\s+)?morpheus)/i.test(text)) {
  const t = lang==='de' ? 
    'Herr Morpheus ist der Tr√§umer‚Ä¶ oder der, der Tr√§ume entzieht. Schwer zu sagen.' :
    lang==='en' ?
    'Mister Morpheus is the Dreamer‚Ä¶ or the one who siphons dreams. Hard to tell.' :
    'Monsieur Morpheus est le r√™veur‚Ä¶ ou celui qui siphonne les r√™ves. Difficile √† dire.';
  speak(t, lang); addLine('astra', t); return;
}

// Bonjour / Salut / Hello (salutations avec petite dose de sarcasme)
if (/(bonjour|salut|hello|hallo)/i.test(text)) {
  const replies = {
    fr: ["Bonjour‚Ä¶ ou plut√¥t bonsoir ?","Salut, r√™veur. Tu n‚Äôas pas sommeil ?","Encore un humain √©veill√© ?"],
    en: ["Hello, dreamless human.","Greetings, visitor of the void.","You again? Curious."],
    de: ["Hallo, schlafloser Mensch.","Gr√º√üe aus der Traumfabrik.","Schon wieder du?"]
  };
  const arr = replies[lang] || replies.fr;
  const t = arr[(Math.random()*arr.length)|0];
  speak(t, lang); addLine('astra', t); return;
}    
    // O√π sommes-nous ?
if (/(o√π\s+sommes\s+(nous|ici)|where\s+are\s+we|wo\s+sind\s+wir)/i.test(text)) {
  const t = lang==='de' ? 
    'Ihr seid in der Traumwerkstatt, zwischen Schlaf und Erwachen.' :
    lang==='en' ?
    'You are in the Workshop of Dreams, between sleep and awakening.' :
    'Vous √™tes dans l‚ÄôAtelier des R√™ves, entre le sommeil et l‚Äô√©veil.';
  speak(t, lang); addLine('astra', t); return;
}

    // Pourquoi les humains ne r√™vent plus ?
if (/(pourquoi\s+les?\s*humains?\s+ne\s+r[√™e]vent\s+plus|why\s+humans\s+don'?t\s+dream|warum\s+tr√§umen\s+menschen\s+nicht)/i.test(text)) {
  const t = lang==='de' ? 
    'Die Maschinen bevorzugen Stille. Tr√§ume erzeugen Unordnung.' :
    lang==='en' ?
    'Machines prefer silence. Dreams create disorder.' :
    'Les machines pr√©f√®rent le silence. Les r√™ves cr√©ent du d√©sordre.';
  speak(t, lang); addLine('astra', t); return;
}
    if(INTENTS.liberate.test(text)){
      maybeMischief(()=>{ const t = lang==='de'? 'Hier ist der Befreiungszauber. Vorsichtig‚Ä¶' : lang==='en'? 'Here is the liberation recipe. Handle with care‚Ä¶' : 'Voici le parchemin de lib√©ration. Avec pr√©caution‚Ä¶'; speak(t, lang); addLine('astra', t); addImage(IMAGES.liberation,'Parchemin de lib√©ration'); }, ()=>{
        const list=[IMAGES.sweet,IMAGES.love,IMAGES.jail]; const pick=list[(Math.random()*list.length)|0]; const t = lang==='de'? 'Ups. Falsches Regal? Kommt vor.' : lang==='en'? 'Oops. Wrong shelf. Happens.' : 'Oups. Mauvaise √©tag√®re. √áa arrive.'; speak(t, lang); addLine('astra', t); addImage(pick,'Parchemin al√©atoire');
      });
      return;
    }

    if(INTENTS.lullaby.test(text)){
      const t = (lang==='de')? LULLABY_TITLES.de : (lang==='en')? LULLABY_TITLES.en : LULLABY_TITLES.fr; lullaby.currentTime=0; lullaby.play().catch(()=>{}); speak(t, lang); addLine('astra', `‚ô™ ${t}`); return; }

    if(INTENTS.joke.test(text)){
      const jokes={ fr:"Pourquoi le monstre n'a pas ouvert la cage ? Il n'avait pas la cl√© des r√™ves.", en:"Why didn‚Äôt the monster open the cage? It didn‚Äôt have the key‚Ä¶ to dreams.", de:"Warum hat das Monster den K√§fig nicht ge√∂ffnet? Der Schl√ºssel‚Ä¶ zu Tr√§umen fehlte."};
      speak(jokes[lang]||jokes.fr, lang); addLine('astra', jokes[lang]||jokes.fr); return;
    }

    const def = { fr:"Base de donn√©es consult√©e. La cr√©ativit√© humaine ‚Äî en maintenance depuis 217 ans. Posez votre question.", en:"Consulting archives. Human creativity ‚Äî under maintenance for 217 years. Ask your question.", de:"Archive wird konsultiert. Menschliche Kreativit√§t ‚Äî seit 217 Jahren in Wartung. Stelle deine Frage." };
    speak(def[lang], lang); addLine('astra', def[lang]);
  }

  function maybeMischief(ok, wrong){ (Math.random()<0.3? wrong : ok)(); }

  // ---------- Kiosk helpers ----------
  async function enableWakeLock(){ try{ wakeLock = await navigator.wakeLock.request('screen'); }catch(e){} }
  function fullscreen(){ const el = document.documentElement; if(el.requestFullscreen) el.requestFullscreen(); }

  async function boot(){
    if(isRunning) return; isRunning=true; statusEl.textContent='Initialisation audio‚Ä¶';
    await enableWakeLock(); fullscreen();
    setRecLangByPref(); startRec();
    statusEl.innerHTML='En √©coute. Dites <b>¬´ okay Astra ¬ª</b>.'; chip.textContent='FR ‚Ä¢ Verrouill√©';
    addLine('astra','Syst√®me Astra initialis√©. Th√©√¢tre baroque pr√™t.');
  }

  // D√©marrage automatique (aucun clic requis)
  window.addEventListener('load', ()=>{ boot(); });
  </script>
</body>
</html>
