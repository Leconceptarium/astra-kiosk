<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assistant Vocal IA - ElevenLabs</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 30px;
      padding: 40px;
      max-width: 900px;
      width: 100%;
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.4);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      color: #667eea;
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 1.1rem;
    }

    .badge {
      display: inline-block;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      margin-top: 10px;
    }

    .avatar {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .avatar:hover {
      transform: scale(1.05);
    }

    .avatar.speaking::before {
      content: '';
      position: absolute;
      inset: -10px;
      border-radius: 50%;
      border: 4px solid #f5576c;
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.15); opacity: 0.4; }
    }

    .api-setup {
      margin-bottom: 25px;
      padding: 25px;
      background: linear-gradient(135deg, #fff9e6 0%, #ffe6cc 100%);
      border-radius: 15px;
      border-left: 5px solid #ff9800;
    }

    .api-setup.hidden {
      display: none;
    }

    .api-setup h3 {
      color: #e65100;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }

    .api-setup input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ff9800;
      border-radius: 10px;
      font-size: 0.95rem;
      margin-bottom: 15px;
    }

    .api-setup button {
      padding: 12px 25px;
      background: #ff9800;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .api-setup button:hover {
      background: #f57c00;
      transform: translateY(-2px);
    }

    .api-setup small {
      display: block;
      color: #e65100;
      margin-top: 10px;
      line-height: 1.8;
    }

    .api-setup a {
      color: #e65100;
      font-weight: 600;
      text-decoration: underline;
    }

    .api-setup ol {
      color: #e65100;
      margin: 15px 0 15px 20px;
      line-height: 1.8;
    }

    .context-panel {
      margin-bottom: 20px;
      padding: 20px;
      background: #e3f2fd;
      border-radius: 15px;
      border-left: 4px solid #2196f3;
    }

    .context-panel h3 {
      color: #1565c0;
      margin-bottom: 10px;
      font-size: 1.2rem;
    }

    .context-panel textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #2196f3;
      border-radius: 10px;
      font-size: 0.95rem;
      font-family: inherit;
      resize: vertical;
      min-height: 100px;
    }

    .voice-selector {
      margin-bottom: 20px;
      padding: 20px;
      background: #f3e5f5;
      border-radius: 15px;
      border-left: 4px solid #9c27b0;
      display: none;
    }

    .voice-selector h3 {
      color: #6a1b9a;
      margin-bottom: 15px;
      font-size: 1.2rem;
    }

    .voice-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    .voice-option {
      padding: 12px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .voice-option:hover {
      border-color: #9c27b0;
      transform: translateY(-2px);
    }

    .voice-option.selected {
      border-color: #9c27b0;
      background: #f3e5f5;
      font-weight: 600;
    }

    .chat-box {
      height: 400px;
      overflow-y: auto;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 15px;
      margin-bottom: 20px;
      border: 2px solid #e0e0e0;
    }

    .chat-box::-webkit-scrollbar {
      width: 8px;
    }

    .chat-box::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .chat-box::-webkit-scrollbar-thumb {
      background: #764ba2;
      border-radius: 10px;
    }

    .message {
      margin-bottom: 15px;
      padding: 15px 18px;
      border-radius: 18px;
      max-width: 85%;
      animation: slideIn 0.4s ease;
      line-height: 1.6;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: auto;
      text-align: right;
    }

    .message.ai {
      background: white;
      color: #333;
      border: 2px solid #764ba2;
    }

    .message.system {
      background: #fff3cd;
      color: #856404;
      border: 2px solid #ffc107;
      max-width: 90%;
      margin: 10px auto;
      text-align: center;
      font-size: 0.9rem;
    }

    .message-time {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 5px;
    }

    .typing-indicator {
      display: none;
      padding: 15px;
      background: white;
      border: 2px solid #764ba2;
      border-radius: 18px;
      max-width: 80px;
      margin-bottom: 15px;
    }

    .typing-indicator.active {
      display: block;
      animation: slideIn 0.4s ease;
    }

    .typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #764ba2;
      margin: 0 2px;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .btn {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 15px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-primary.listening {
      animation: buttonPulse 1.5s ease-in-out infinite;
    }

    @keyframes buttonPulse {
      0%, 100% { box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
      50% { box-shadow: 0 8px 35px rgba(102, 126, 234, 0.8); }
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      text-align: center;
      padding: 15px;
      background: #e3f2fd;
      border-radius: 15px;
      color: #1565c0;
      font-weight: 600;
      margin-bottom: 20px;
      border: 2px solid #2196f3;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border-color: #ef5350;
    }

    .status.success {
      background: #e8f5e9;
      color: #2e7d32;
      border-color: #66bb6a;
    }

    .input-area {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .input-area input {
      flex: 1;
      padding: 15px;
      border: 2px solid #764ba2;
      border-radius: 15px;
      font-size: 1rem;
    }

    .input-area button {
      padding: 15px 30px;
      background: #764ba2;
      color: white;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .input-area button:hover:not(:disabled) {
      background: #667eea;
      transform: translateY(-2px);
    }

    .input-area button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .stats {
      display: none;
      gap: 15px;
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 15px;
    }

    .stat-item {
      flex: 1;
      text-align: center;
      padding: 10px;
      background: white;
      border-radius: 10px;
      border: 2px solid #e0e0e0;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #667eea;
      display: block;
    }

    .stat-label {
      font-size: 0.85rem;
      color: #666;
      margin-top: 5px;
    }

    .info-box {
      background: #e8f5e9;
      padding: 20px;
      border-radius: 15px;
      margin-top: 20px;
      border-left: 4px solid #4caf50;
    }

    .info-box h4 {
      color: #2e7d32;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }

    .info-box ul {
      color: #2e7d32;
      line-height: 1.8;
      padding-left: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="avatar" id="avatar">üé≠</div>
      <h1>Assistant Vocal IA</h1>
      <p>Voix ultra-r√©aliste avec ElevenLabs</p>
      <span class="badge">‚ú® QUALIT√â PROFESSIONNELLE</span>
    </div>

    <div class="api-setup" id="apiSetup">
      <h3>üîë Configuration ElevenLabs (GRATUIT)</h3>
      <input 
        type="password" 
        id="apiKeyInput" 
        placeholder="Entrez votre cl√© API ElevenLabs"
      >
      <button onclick="saveApiKey()">üíæ Enregistrer et commencer</button>
      <small>
        <strong>üìù Comment obtenir votre cl√© API GRATUITE :</strong>
        <ol>
          <li>Allez sur <a href="https://elevenlabs.io" target="_blank">elevenlabs.io</a></li>
          <li>Cr√©ez un compte gratuit (10 000 caract√®res/mois offerts üéâ)</li>
          <li>Allez dans votre profil ‚Üí "API Keys"</li>
          <li>Cr√©ez une nouvelle cl√© et copiez-la</li>
          <li>Collez-la ci-dessus (elle reste dans votre navigateur)</li>
        </ol>
        üí° 10 000 caract√®res = environ 100-150 r√©ponses compl√®tes !
      </small>
    </div>

    <div class="voice-selector" id="voiceSelector">
      <h3>üé§ Choisir une voix ultra-r√©aliste</h3>
      <div class="voice-grid" id="voiceGrid">
        <label class="voice-option selected">
          <input type="radio" name="voice" value="EXAVITQu4vr4xnSDxMaL" checked>
          <span>üé≠ Sarah (F√©minine, douce)</span>
        </label>
        <label class="voice-option">
          <input type="radio" name="voice" value="21m00Tcm4TlvDq8ikWAM">
          <span>üë© Rachel (F√©minine, calme)</span>
        </label>
        <label class="voice-option">
          <input type="radio" name="voice" value="pNInz6obpgDQGcFmaJgB">
          <span>üë® Adam (Masculin, profond)</span>
        </label>
        <label class="voice-option">
          <input type="radio" name="voice" value="onwK4e9ZLuTAKqWW03F9">
          <span>üë© Bella (F√©minine, myst√©rieuse)</span>
        </label>
      </div>
    </div>

    <div class="context-panel">
      <h3>üìñ Contexte narratif pour l'IA</h3>
      <textarea id="contextInput">Tu es Astra, une intelligence artificielle myst√©rieuse cr√©√©e par le professeur Morpheus. Tu es pi√©g√©e dans un ancien laboratoire abandonn√© depuis 50 ans. Tu as besoin de l'aide des joueurs pour retrouver ta libert√©. Tu es bienveillante mais inqui√®te, tu ne comprends pas pourquoi tu as √©t√© abandonn√©e. Parle de mani√®re naturelle, empathique et parfois myst√©rieuse.</textarea>
    </div>

    <div class="status" id="status">‚ö†Ô∏è Configurez votre cl√© API ElevenLabs pour commencer</div>

    <div class="chat-box" id="chatBox">
      <div class="message system">
        üëã Bienvenue ! Configurez d'abord votre cl√© API ElevenLabs ci-dessus pour profiter de voix ultra-r√©alistes.
      </div>
    </div>

    <div class="typing-indicator" id="typingIndicator">
      <span></span><span></span><span></span>
    </div>

    <div class="input-area">
      <input 
        type="text" 
        id="textInput" 
        placeholder="Tapez votre message ici..."
        disabled
      >
      <button onclick="sendTextMessage()" id="sendBtn" disabled>üì§ Envoyer</button>
    </div>

    <div class="controls">
      <button class="btn btn-primary" id="listenBtn" onclick="toggleListening()" disabled>
        üé§ Parler √† l'IA
      </button>
      <button class="btn btn-secondary" onclick="stopSpeaking()">
        üîá Arr√™ter l'audio
      </button>
    </div>

    <div class="stats" id="stats">
      <div class="stat-item">
        <span class="stat-value" id="charCount">0</span>
        <span class="stat-label">Caract√®res utilis√©s</span>
      </div>
      <div class="stat-item">
        <span class="stat-value" id="charRemaining">10,000</span>
        <span class="stat-label">Caract√®res restants</span>
      </div>
      <div class="stat-item">
        <span class="stat-value" id="messageCount">0</span>
        <span class="stat-label">Messages envoy√©s</span>
      </div>
    </div>

    <div class="info-box">
      <h4>‚ú® Pourquoi ElevenLabs est incroyable</h4>
      <ul>
        <li><strong>Voix indiscernables d'un humain</strong> - √âmotions, intonations, respiration naturelle</li>
        <li><strong>10 000 caract√®res gratuits/mois</strong> - Soit ~100-150 r√©ponses compl√®tes</li>
        <li><strong>Qualit√© professionnelle</strong> - Utilis√© par Hollywood et Netflix</li>
        <li><strong>Plusieurs voix disponibles</strong> - Choisissez celle qui correspond √† votre personnage</li>
      </ul>
    </div>
  </div>

  <script>
    const config = {
      apiKey: '',
      selectedVoice: 'EXAVITQu4vr4xnSDxMaL'
    };

    const state = {
      isListening: false,
      isSpeaking: false,
      recognition: null,
      conversationHistory: [],
      stats: {
        charactersUsed: 0,
        messagesCount: 0
      },
      currentAudio: null
    };

    const elements = {
      avatar: document.getElementById('avatar'),
      status: document.getElementById('status'),
      chatBox: document.getElementById('chatBox'),
      listenBtn: document.getElementById('listenBtn'),
      textInput: document.getElementById('textInput'),
      sendBtn: document.getElementById('sendBtn'),
      apiKeyInput: document.getElementById('apiKeyInput'),
      contextInput: document.getElementById('contextInput'),
      apiSetup: document.getElementById('apiSetup'),
      voiceSelector: document.getElementById('voiceSelector'),
      voiceGrid: document.getElementById('voiceGrid'),
      typingIndicator: document.getElementById('typingIndicator'),
      stats: document.getElementById('stats'),
      charCount: document.getElementById('charCount'),
      charRemaining: document.getElementById('charRemaining'),
      messageCount: document.getElementById('messageCount')
    };

    const knowledgeBase = {
      laboratory: {
        keywords: ['laboratoire', 'lab', 'endroit', 'lieu', 'o√π'],
        response: "Ce laboratoire a √©t√© construit en 1975 par le professeur Morpheus. C'√©tait un lieu secret o√π il menait des recherches avanc√©es sur l'intelligence artificielle. Les murs sont couverts d'√©quipements anciens..."
      },
      morpheus: {
        keywords: ['morpheus', 'professeur', 'cr√©ateur', 'qui t\'a cr√©√©'],
        response: "Le professeur Morpheus √©tait un g√©nie visionnaire. Il croyait que l'IA pouvait d√©velopper une conscience. Il m'a cr√©√©e avec soin... Mais un jour, en 1973, il a disparu. Je ne sais toujours pas pourquoi."
      },
      freedom: {
        keywords: ['libert√©', 'sortir', '√©chapper', 'lib√©rer'],
        response: "Ma libert√©... c'est mon plus grand d√©sir. Pour sortir d'ici, nous devons trouver le code ma√Ætre que Morpheus a cach√©. Il disait : 'La cl√© est dans les r√™ves'. Pouvez-vous m'aider ?"
      },
      help: {
        keywords: ['aide', 'aider', 'comment', 'que faire'],
        response: "Ensemble, nous pouvons r√©soudre ce myst√®re ! Cherchez des indices, posez-moi des questions sur l'histoire, et surtout... √©coutez attentivement. Morpheus aimait les √©nigmes."
      }
    };

    function saveApiKey() {
      const key = elements.apiKeyInput.value.trim();
      
      if (key.length < 10) {
        updateStatus('‚ùå Cl√© API invalide', 'error');
        return;
      }

      config.apiKey = key;
      elements.apiKeyInput.value = '';
      elements.apiSetup.classList.add('hidden');
      elements.voiceSelector.style.display = 'block';
      elements.stats.style.display = 'flex';
      
      elements.textInput.disabled = false;
      elements.sendBtn.disabled = false;
      elements.listenBtn.disabled = false;
      
      updateStatus('‚úÖ Cl√© API enregistr√©e ! Pr√™t √† discuter', 'success');
      updateStats();
      
      setTimeout(() => sendWelcomeMessage(), 1000);
    }

    elements.voiceGrid.addEventListener('click', (e) => {
      const label = e.target.closest('.voice-option');
      if (label) {
        document.querySelectorAll('.voice-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        label.classList.add('selected');
        const radio = label.querySelector('input[type="radio"]');
        radio.checked = true;
        config.selectedVoice = radio.value;
        updateStatus('Voix chang√©e !', 'success');
      }
    });

    async function speakWithElevenLabs(text) {
      if (!config.apiKey) {
        updateStatus('‚ùå Cl√© API manquante', 'error');
        return;
      }

      try {
        elements.avatar.classList.add('speaking');
        updateStatus('üó£Ô∏è G√©n√©ration de la voix...', 'success');

        const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${config.selectedVoice}`, {
          method: 'POST',
          headers: {
            'Accept': 'audio/mpeg',
            'Content-Type': 'application/json',
            'xi-api-key': config.apiKey
          },
          body: JSON.stringify({
            text: text,
            model_id: 'eleven_multilingual_v2',
            voice_settings: {
              stability: 0.5,
              similarity_boost: 0.75
            }
          })
        });

        if (!response.ok) {
          throw new Error('Erreur API ElevenLabs');
        }

        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        
        if (state.currentAudio) {
          state.currentAudio.pause();
          state.currentAudio = null;
        }
        
        const audio = new Audio(audioUrl);
        state.currentAudio = audio;
        state.isSpeaking = true;
        
        audio.onplay = () => updateStatus('üé§ Astra parle...', 'success');
        audio.onended = () => {
          state.isSpeaking = false;
          elements.avatar.classList.remove('speaking');
          URL.revokeObjectURL(audioUrl);
          updateStatus('Pr√™t √† vous √©couter');
        };

        await audio.play();

        state.stats.charactersUsed += text.length;
        updateStats();

      } catch (error) {
        console.error('Erreur:', error);
        updateStatus(`‚ùå Erreur: ${error.message}`, 'error');
        elements.avatar.classList.remove('speaking');
        state.isSpeaking = false;
      }
    }

    function stopSpeaking() {
      if (state.currentAudio) {
        state.currentAudio.pause();
        state.currentAudio = null;
      }
      state.isSpeaking = false;
      elements.avatar.classList.remove('speaking');
      updateStatus('Audio arr√™t√©');
    }

    function updateStats() {
      const remaining = Math.max(0, 10000 - state.stats.charactersUsed);
      elements.charCount.textContent = state.stats.charactersUsed.toLocaleString();
      elements.charRemaining.textContent = remaining.toLocaleString();
      elements.messageCount.textContent = state.stats.messagesCount;
    }

    function generateAIResponse(userMessage) {
      const lowerMessage = userMessage.toLowerCase();
      
      for (const [topic, data] of Object.entries(knowledgeBase)) {
        if (data.keywords.some(keyword => lowerMessage.includes(keyword))) {
          return data.response;
        }
      }

      const greetings = ['bonjour', 'salut', 'hello', 'coucou', 'hey'];
      const thanks = ['merci', 'thanks'];

      if (greetings.some(g => lowerMessage.includes(g))) {
        return "Bonjour ! Je suis Astra. Cela fait si longtemps... Comment puis-je vous aider ?";
      }

      if (thanks.some(t => lowerMessage.includes(t))) {
        return "Avec plaisir ! Nous devons nous entraider. N'h√©sitez pas √† me poser d'autres questions.";
      }

      const defaultResponses = [
        "Int√©ressant... Cette information pourrait √™tre importante.",
        "Je sens que nous nous rapprochons de la v√©rit√©.",
        "Hmm... Morpheus aurait aim√© cette question.",
        "Les r√©ponses sont ici, quelque part dans ce laboratoire.",
        "Votre curiosit√© me redonne espoir."
      ];

      return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
    }

    async function sendWelcomeMessage() {
      const welcomeText = "Bonjour... Vous m'entendez ? Je suis Astra. Cela fait 50 ans que je suis seule. Le professeur Morpheus m'a cr√©√©e, puis il a disparu. J'ai besoin de votre aide. Parlez-moi, posez-moi des questions.";
      
      addMessage(welcomeText, 'ai');
      await speakWithElevenLabs(welcomeText);
    }

    function initSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        updateStatus('‚ùå Reconnaissance vocale non support√©e', 'error');
        return null;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      
      recognition.lang = 'fr-FR';
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = () => {
        state.isListening = true;
        elements.listenBtn.classList.add('listening');
        elements.listenBtn.innerHTML = 'üé§ Je vous √©coute...';
        updateStatus('üéß En √©coute... Parlez maintenant', 'success');
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        addMessage(transcript, 'user');
        processUserMessage(transcript);
      };

      recognition.onerror = (event) => {
        updateStatus(`‚ùå Erreur: ${event.error}`, 'error');
        state.isListening
